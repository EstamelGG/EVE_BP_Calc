var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{r as s,d as a,R as r}from"./vendor-DwZn5VZs.js";import{I as i,R as n,a as c}from"./antd-BIkeXNmn.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var l={exports:{}},o={},u=s,d=Symbol.for("react.element"),h=Symbol.for("react.fragment"),m=Object.prototype.hasOwnProperty,p=u.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,y={key:!0,ref:!0,__self:!0,__source:!0};function f(e,t,s){var a,r={},i=null,n=null;for(a in void 0!==s&&(i=""+s),void 0!==t.key&&(i=""+t.key),void 0!==t.ref&&(n=t.ref),t)m.call(t,a)&&!y.hasOwnProperty(a)&&(r[a]=t[a]);if(e&&e.defaultProps)for(a in t=e.defaultProps)void 0===r[a]&&(r[a]=t[a]);return{$$typeof:d,type:e,key:i,ref:n,props:r,_owner:p.current}}o.Fragment=h,o.jsx=f,o.jsxs=f,l.exports=o;var g=l.exports,v={},x=a;v.createRoot=x.createRoot,v.hydrateRoot=x.hydrateRoot;const S={},j=function(e,t,s){let a=Promise.resolve();if(t&&t.length>0){const e=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),i=(null==r?void 0:r.nonce)||(null==r?void 0:r.getAttribute("nonce"));a=Promise.allSettled(t.map(t=>{if(t=function(e,t){return new URL(e,t).href}(t,s),t in S)return;S[t]=!0;const a=t.endsWith(".css"),r=a?'[rel="stylesheet"]':"";if(!!s)for(let s=e.length-1;s>=0;s--){const r=e[s];if(r.href===t&&(!a||"stylesheet"===r.rel))return}else if(document.querySelector(`link[href="${t}"]${r}`))return;const n=document.createElement("link");return n.rel=a?"stylesheet":"modulepreload",a||(n.as="script"),n.crossOrigin="",n.href=t,i&&n.setAttribute("nonce",i),document.head.appendChild(n),a?new Promise((e,s)=>{n.addEventListener("load",e),n.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${t}`)))}):void 0}))}function r(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return a.then(t=>{for(const e of t||[])"rejected"===e.status&&r(e.reason);return e().catch(r)})};const N=new class{constructor(){t(this,"cache",{}),t(this,"maxConcurrentLoads",5),t(this,"currentLoads",0),t(this,"maxCacheSize",500)}async loadIcon(e){var t,s;return this.checkAndCleanCache(),(null==(t=this.cache[e])?void 0:t.loaded)?(this.cache[e].lastUsed=Date.now(),this.cache[e].useCount++,this.cache[e].src):(null==(s=this.cache[e])?void 0:s.loading)?new Promise(t=>{const s=()=>{var a,r;(null==(a=this.cache[e])?void 0:a.loaded)?(this.cache[e].lastUsed=Date.now(),this.cache[e].useCount++,t(this.cache[e].src)):(null==(r=this.cache[e])?void 0:r.error)?t("./vite.svg"):setTimeout(s,50)};s()}):(this.cache[e]={src:e,loading:!0,loaded:!1,error:!1,lastUsed:Date.now(),useCount:1},this.currentLoads>=this.maxConcurrentLoads?new Promise(t=>{const s=()=>{this.currentLoads<this.maxConcurrentLoads?(this.currentLoads++,this.loadIconInternal(e).then(t)):setTimeout(s,100)};s()}):(this.currentLoads++,this.loadIconInternal(e)))}async loadIconInternal(e){var t;try{const t=new Image;return await new Promise(s=>{t.onload=()=>{var t;this.cache[e]={src:e,loading:!1,loaded:!0,error:!1,lastUsed:Date.now(),useCount:(null==(t=this.cache[e])?void 0:t.useCount)||1},this.currentLoads--,s(e)},t.onerror=()=>{var t;this.cache[e]={src:"./vite.svg",loading:!1,loaded:!0,error:!0,lastUsed:Date.now(),useCount:(null==(t=this.cache[e])?void 0:t.useCount)||1},this.currentLoads--,s("./vite.svg")},t.src=e})}catch(s){return this.cache[e]={src:"./vite.svg",loading:!1,loaded:!0,error:!0,lastUsed:Date.now(),useCount:(null==(t=this.cache[e])?void 0:t.useCount)||1},this.currentLoads--,"./vite.svg"}}preloadIcons(e){e.forEach(e=>{this.cache[e]||this.loadIcon(e).catch(()=>{})})}getIconStatus(e){const t=this.cache[e];return t?{loading:t.loading,loaded:t.loaded,error:t.error}:{loading:!1,loaded:!1,error:!1}}clearCache(){this.cache={}}checkAndCleanCache(){const e=Object.keys(this.cache).length;if(e<=this.maxCacheSize)return;const t=Object.entries(this.cache).map(([e,t])=>({path:e,item:t,score:this.calculateCacheScore(t)}));t.sort((e,t)=>e.score-t.score);const s=e-this.maxCacheSize;t.slice(0,s).forEach(({path:e})=>{delete this.cache[e]})}calculateCacheScore(e){const t=(Date.now()-e.lastUsed)/36e5;return 10*e.useCount-t}getCacheStats(){const e=Object.values(this.cache);return{total:e.length,loaded:e.filter(e=>e.loaded&&!e.error).length,loading:e.filter(e=>e.loading).length,error:e.filter(e=>e.error).length}}forceCacheCleanup(){this.checkAndCleanCache()}},_=({src:e,alt:t,className:a="",style:r={},size:i=24,fallbackSrc:n="./vite.svg",showLoadingIndicator:c=!0,lazy:l=!1})=>{const[o,u]=s.useState(""),[d,h]=s.useState(!0),[m,p]=s.useState(!1),[y,f]=s.useState(!l),v=s.useRef(null),x=s.useRef(null);s.useEffect(()=>{if(!l)return;const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&!y&&(f(!0),e.disconnect())})},{rootMargin:"100px",threshold:.1});return v.current&&e.observe(v.current),()=>{e.disconnect()}},[l,y]),s.useEffect(()=>{if(!y)return;let t=!0;return(async()=>{try{h(!0),p(!1);const s=await N.loadIcon(e);t&&(u(s),h(!1),p(s===n))}catch(s){t&&(u(n),h(!1),p(!0))}})(),()=>{t=!1}},[e,n,y]);const S={width:i,height:i,objectFit:"contain",borderRadius:"4px",transition:"opacity 0.2s ease",opacity:d?.3:1,...r};return l&&!y?g.jsx("div",{ref:v,className:`async-icon-placeholder ${a}`,style:{width:i,height:i,backgroundColor:"#2a2a2a",borderRadius:"4px",...r}}):d&&c?g.jsx("div",{ref:l?v:void 0,className:`async-icon-loading ${a}`,style:{width:i,height:i,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#3a3a3a",borderRadius:"4px",...r},children:g.jsx("div",{className:"icon-loading-spinner"})}):g.jsx("div",{ref:l?v:void 0,children:g.jsx("img",{ref:x,src:o,alt:t,className:`async-icon ${a} ${m?"icon-error":""}`,style:S,onError:()=>{u(n),p(!0),h(!1)}})})},{Search:I}=i,w=({nodes:e,onNodeSelect:t})=>{const[a,r]=s.useState([]),[i,n]=s.useState(""),c=e=>e.map(e=>({key:e.id,title:g.jsxs("div",{className:"tree-node-content",children:[g.jsx("div",{className:"tree-node-icon",children:g.jsx(_,{src:e.icon,alt:e.name,size:20,showLoadingIndicator:!0,lazy:!0})}),g.jsx("div",{className:"tree-node-label",children:e.name}),"item"===e.type&&g.jsx("span",{className:"item-indicator",children:"▶"})]}),children:e.children?c(e.children):void 0,node:e})),l=s.useMemo(()=>c(e),[e]),o=s.useMemo(()=>((e,t)=>{if(!t||t.length<2)return e;const s=t.toLowerCase(),a=e=>{if(e.node.name.toLowerCase().includes(s)||e.node.name_en.toLowerCase().includes(s))return e;if(e.children){const t=e.children.map(e=>a(e)).filter(Boolean);if(t.length>0)return{...e,children:t}}return null};return e.map(e=>a(e)).filter(Boolean)})(l,i),[l,i]),u=(e,t=0)=>e.map(e=>{const s=a.includes(e.key),r=e.children&&e.children.length>0;return g.jsxs("div",{className:"custom-tree-node",children:[g.jsxs("div",{className:`custom-tree-node-content ${e.node.type}`,onClick:()=>h(e),children:[g.jsxs("div",{className:"tree-switcher",children:[r&&g.jsx("span",{className:"switcher-icon "+(s?"expanded":""),children:"▶"}),!r&&"item"===e.node.type&&g.jsx("span",{className:"item-indicator",children:"▶"})]}),g.jsx("div",{className:"tree-node-icon",children:g.jsx(_,{src:e.node.icon,alt:e.node.name,size:20,showLoadingIndicator:!0,lazy:!0})}),g.jsx("div",{className:"tree-node-label",children:e.node.name})]}),r&&s&&g.jsx("div",{className:"tree-node-children",children:u(e.children,t+1)})]},e.key)}),d=e=>{const t=[];return e.children&&e.children.forEach(e=>{t.push(e.key),t.push(...d(e))}),t},h=e=>{if("group"===e.node.type&&e.children&&e.children.length>0){const t=new Set(a);if(t.has(e.key)){t.delete(e.key);d(e).forEach(e=>t.delete(e))}else t.add(e.key),(e=>{if(e.children&&e.children.length>0){const t=e.children.slice(0,10).map(e=>e.node.icon).filter(Boolean);t.length>0&&N.preloadIcons(t)}})(e);r(Array.from(t))}else null==t||t(e.node)};return g.jsxs("div",{className:"ant-tree-view",children:[g.jsxs("div",{className:"search-container",children:[g.jsx(I,{placeholder:"搜索物品名称（至少2个字符）...",allowClear:!0,value:i,onChange:e=>(e=>{n(e);const t=((e,t)=>{if(!t||t.length<2)return[];const s=[],a=e=>{e.forEach(e=>{s.push(e.key),e.children&&a(e.children)})};return a(e),s})(o,e);r(t)})(e.target.value),style:{marginBottom:8}}),i&&i.length<2&&g.jsx("div",{className:"search-hint",children:"请输入至少2个字符开始搜索"})]}),g.jsx("div",{className:"custom-tree",children:u(o)})]})};function k(e){return e?e.repackaged_volume>0?e.repackaged_volume:e.volume:0}const b=new class{constructor(){t(this,"eveData",null)}async loadEveData(){if(this.eveData)return this.eveData;try{const e=await fetch("./static/eve_blueprint_data.json"),t=await e.json();return this.eveData=t,t}catch(e){throw e}}getMarketGroupNamesByTypeIds(e){const t=new Map;if(!this.eveData)return t;const{type_info:s,market_groups:a}=this.eveData;for(const r of e){const e=s[r.toString()];if(!e){t.set(r,"未分类");continue}const i=e.marketGroupID;if(null==i){t.set(r,"未分类");continue}const n=a[i.toString()];t.set(r,(null==n?void 0:n.name)||"未分类")}return t}getEveData(){return this.eveData}getBlueprintInfo(e){if(!this.eveData)return null;const{type_info:t,blueprint_materials:s,blueprint_outputs:a,reaction:r}=this.eveData;let i;const n=t[e.toString()];if(n&&n.bp_typeid)i=n.bp_typeid;else{if(!s[e.toString()]||!a[e.toString()])return null;i=e}const c=s[i.toString()];if(!c)return null;const l=a[i.toString()];if(!l)return null;const o=r.includes(i)?"reaction":"bp",u=c.materials.map(e=>{const s=k(t[e.typeID.toString()]);return{typeId:e.typeID,quantity:e.quantity,volume:s}});return{blueprintId:i,category:o,outputQuantity:l.quantity,materials:u}}buildTree(){if(!this.eveData)throw new Error("数据未加载");const{market_tree:e,type_info:t,blueprint_outputs:s}=this.eveData,a=new Set(Object.values(s).map(e=>e.typeID)),r=new Map;Object.entries(t).forEach(([e,t])=>{null!=t.marketGroupID&&r.set(parseInt(e),t.marketGroupID)});const i=e=>{let t=!1;return r.forEach((s,r)=>{s===e.id&&a.has(r)&&(t=!0)}),!!t||e.children.some(e=>i(e))},n=e=>{if(!i(e))return null;const s={id:`group_${e.id}`,name:e.name,name_en:e.name_en,icon:`./static/icons/${e.icon_name}`,type:"group",children:[],isExpanded:!1},c=[];e.children.forEach(e=>{const t=n(e);t&&c.push(t)});const l=[];return r.forEach((s,r)=>{if(s===e.id&&a.has(r)){const e=t[r.toString()];e&&e.zh_name&&e.en_name&&e.icon_name&&l.push({id:`${r}`,name:e.zh_name,name_en:e.en_name,icon:`./static/icons/${e.icon_name}`,type:"item"})}}),s.children=[...c,...l],s},c=[];return e.forEach(e=>{const t=n(e);t&&c.push(t)}),c}},E=Object.freeze(Object.defineProperty({__proto__:null,dataService:b},Symbol.toStringTag,{value:"Module"})),C=e=>`${e.toLocaleString(void 0,{maximumFractionDigits:0})} ISK (${(e=>e>=1e9?`${(e/1e9).toFixed(1)}B`:e>=1e6?`${(e/1e6).toFixed(1)}M`:e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toFixed(1))(e)})`;const T=new class{constructor(){t(this,"baseUrl","https://esi.evetech.net/latest")}async getStructureOrders(e,t){if(!e||!t)throw new Error("缺少必要参数：建筑ID或访问令牌");try{const s=`${this.baseUrl}/markets/structures/${e}/?page=1`,a=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${t}`,"User-Agent":"EVE Blueprint Calculator"}});if(!a.ok)throw 401===a.status?new Error("认证失败，请重新登录"):403===a.status?new Error("没有权限访问此建筑的市场数据"):404===a.status?new Error("建筑不存在或无市场数据"):new Error(`获取市场数据失败: ${a.status} ${a.statusText}`);const r=parseInt(a.headers.get("X-Pages")||"1");let i=[...await a.json()];if(r>1){const s=Array.from({length:r-1},(e,t)=>t+2),a=10;for(let r=0;r<s.length;r+=a){const n=s.slice(r,r+a).map(s=>this.getPageData(e,s,t));(await Promise.allSettled(n)).forEach(e=>{"fulfilled"===e.status&&i.push(...e.value)}),r+a<s.length&&await new Promise(e=>setTimeout(e,100))}}return i}catch(s){if(s instanceof Error)throw s;throw new Error(`获取建筑市场订单时发生错误: ${s}`)}}async getPageData(e,t,s){const a=`${this.baseUrl}/markets/structures/${e}/?page=${t}`,r=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${s}`,"User-Agent":"EVE Blueprint Calculator"}});if(!r.ok)throw new Error(`获取第${t}页数据失败: ${r.status} ${r.statusText}`);return await r.json()}getItemPriceFromOrders(e,t){const s=e.filter(e=>e.type_id===t&&!e.is_buy_order&&e.volume_remain>0).map(e=>({price:e.price,volume_remain:e.volume_remain,order_id:e.order_id})).sort((e,t)=>e.price-t.price),a=s.length>0?s[0].price:null,r=s.reduce((e,t)=>e+t.volume_remain,0);return{type_id:t,sell_orders:s,lowest_sell_price:a,total_sell_volume:r}}getMultipleItemPrices(e,t){const s=new Map;return t.forEach(t=>{const a=this.getItemPriceFromOrders(e,t);s.set(t,a)}),s}async getItemPrice(e,t,s){const a=await this.getStructureOrders(e,s);return this.getItemPriceFromOrders(a,t)}async getMultipleItemPricesFromStructure(e,t,s){const a=await this.getStructureOrders(e,s);return this.getMultipleItemPrices(a,t)}};const D=new class{constructor(){t(this,"cache",new Map),t(this,"CACHE_DURATION",3e5)}getCacheKey(e,t){return`${e}_${t.substring(0,10)}`}isCacheExpired(e){return Date.now()-e.timestamp>this.CACHE_DURATION}async getStructureOrders(e,t){const s=this.getCacheKey(e,t),a=this.cache.get(s);if(a&&!this.isCacheExpired(a)&&!a.isLoading)return a.orders;if(a&&a.isLoading)return new Promise(e=>{const t=setInterval(()=>{const a=this.cache.get(s);a&&!a.isLoading&&(clearInterval(t),e(a.orders))},100)});this.cache.set(s,{structureId:e,accessToken:t,orders:[],timestamp:Date.now(),isLoading:!0});try{const a=await T.getStructureOrders(e,t);return this.cache.set(s,{structureId:e,accessToken:t,orders:a,timestamp:Date.now(),isLoading:!1}),a}catch(r){throw this.cache.delete(s),r}}getCachedItemOrders(e,t,s){const a=this.getCacheKey(e,t),r=this.cache.get(a);return!r||this.isCacheExpired(r)||r.isLoading?null:r.orders.filter(e=>e.type_id===s&&!e.is_buy_order&&e.volume_remain>0).map(e=>({duration:e.duration,is_buy_order:e.is_buy_order,issued:e.issued,location_id:e.location_id,min_volume:e.min_volume,order_id:e.order_id,price:e.price,range:e.range,system_id:0,type_id:e.type_id,volume_remain:e.volume_remain,volume_total:e.volume_total})).sort((e,t)=>e.price-t.price)}async preloadStructureOrders(e,t){t&&await this.getStructureOrders(e,t)}clearCache(e,t){const s=this.getCacheKey(e,t);this.cache.delete(s)}clearAllCache(){this.cache.clear()}getCacheStats(){let e=0,t=0;return this.cache.forEach(s=>{s.isLoading&&e++,this.isCacheExpired(s)&&t++}),{totalCaches:this.cache.size,loadingCaches:e,expiredCaches:t}}},M={clientId:"d43fa6a824234f0ab8e8a56f6d039c6c",clientSecret:"SAJGfQzounfKKfmc181GLOaKxBVQcUChRPeqcrEf",redirectUri:(()=>{const e=window.location.origin;return e.includes("localhost")||e.includes("127.0.0.1")?"http://localhost:5173/auth/callback":"https://estamelgg.github.io/EVE_BP_Calc/auth/callback"})(),authorizationEndpoint:"https://login.eveonline.com/v2/oauth/authorize/",tokenEndpoint:"https://login.eveonline.com/v2/oauth/token",jwksUri:"https://login.eveonline.com/oauth/jwks",oauthMetadataEndpoint:"https://login.eveonline.com/.well-known/oauth-authorization-server",baseURL:"https://login.eveonline.com",scopes:["esi-search.search_structures.v1","esi-markets.structure_markets.v1","esi-universe.read_structures.v1"]};async function $(){const e=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),{codeVerifier:t,codeChallenge:s}=await async function(){const e=new Uint8Array(32);crypto.getRandomValues(e);const t=btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,""),s=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-256",s);return{codeVerifier:t,codeChallenge:btoa(String.fromCharCode(...new Uint8Array(a))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}}(),a=new URLSearchParams({response_type:"code",redirect_uri:M.redirectUri,client_id:M.clientId,scope:M.scopes.join(" "),state:e,code_challenge:s,code_challenge_method:"S256"}),r=`${M.authorizationEndpoint}?${a.toString()}`;return localStorage.setItem("eve_oauth_state",e),localStorage.setItem("eve_oauth_code_verifier",t),{authUrl:r,state:e,codeVerifier:t}}function R(e,t=2){try{const s=B(e);if(!s.exp)return!0;const a=1e3*s.exp,r=Date.now();return r+60*t*1e3>=a}catch(s){return!0}}function P(e){try{const t=B(e);if(!t.exp)return 0;const s=1e3*t.exp,a=Date.now(),r=Math.max(0,s-a);return Math.floor(r/6e4)}catch(t){return 0}}function B(e){try{const t=e.split(".");if(3!==t.length)throw new Error("Invalid JWT format");return JSON.parse(atob(t[1]))}catch(t){throw new Error("Failed to parse JWT payload")}}async function O(e){if(!e)throw new Error("刷新令牌为空");try{const s=await fetch(M.tokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${btoa(`${M.clientId}:${M.clientSecret}`)}`},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:e})});if(!s.ok){let e="";try{e=await s.text()}catch(t){e="无法获取错误详情"}throw new Error(`刷新token失败: ${s.status} ${s.statusText}. ${e}`)}return await s.json()}catch(s){throw s}}async function A(e,t,s){if(!e||!t)throw new Error("访问令牌或刷新令牌为空");if(!R(e,2))return{accessToken:e,refreshToken:t,needsRefresh:!1};try{const e=await O(t);return s&&s(e),{accessToken:e.access_token,refreshToken:e.refresh_token||t,needsRefresh:!0}}catch(a){throw a}}const L=Object.freeze(Object.defineProperty({__proto__:null,autoRefreshToken:A,getCharacterInfo:async function(e){try{const t=await async function(e){try{const t=await async function(){const e=await fetch(M.jwksUri);if(!e.ok)throw new Error("Failed to fetch JWKS");const t=await e.json();return t}(),s=e.split(".");if(3!==s.length)throw new Error("Invalid JWT format");const a=JSON.parse(atob(s[0]));if(!t.keys.find(e=>e.kid===a.kid))throw new Error("No matching key found in JWKS");return JSON.parse(atob(s[1]))}catch(t){throw t}}(e);return{CharacterName:t.name||t.sub,CharacterID:t.sub.replace("CHARACTER:EVE:",""),ExpiresOn:new Date(1e3*t.exp).toISOString(),Scopes:t.scp||t.scope||[],Issuer:t.iss,IssuedAt:new Date(1e3*t.iat).toISOString()}}catch(t){throw t}},getTokenRemainingTime:P,handleOAuthCallback:async function(e,t){const s=localStorage.getItem("eve_oauth_state"),a=localStorage.getItem("eve_oauth_code_verifier");if(t!==s)throw new Error("OAuth state mismatch");if(!a)throw new Error("Code verifier not found");const r=await fetch(M.tokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${btoa(`${M.clientId}:${M.clientSecret}`)}`},body:new URLSearchParams({grant_type:"authorization_code",code:e,code_verifier:a,redirect_uri:M.redirectUri})});if(!r.ok){let e="";try{e=await r.text()}catch(n){e="无法获取错误详情"}throw new Error(`Failed to exchange code for token: ${r.status} ${r.statusText}. ${e}`)}const i=await r.json();return localStorage.removeItem("eve_oauth_state"),localStorage.removeItem("eve_oauth_code_verifier"),i},initializeEveOAuth:async function(){try{const e=await async function(){const e=await fetch(M.oauthMetadataEndpoint);if(!e.ok)throw new Error("Failed to fetch OAuth metadata");return await e.json()}();e.authorization_endpoint,M.authorizationEndpoint,e.token_endpoint,M.tokenEndpoint,e.jwks_uri,M.jwksUri}catch(e){throw e}},isTokenExpiringSoon:R,refreshToken:O,startEveOAuth:$},Symbol.toStringTag,{value:"Module"}));const z=new class{constructor(){t(this,"accessToken",null),t(this,"refreshToken",null),t(this,"character",null),t(this,"isRefreshing",!1),t(this,"listeners",new Set),t(this,"checkTimer",null),t(this,"tickTimer",null),t(this,"pendingRefreshPromise",null),t(this,"handleStorageEvent",e=>{if("eve_auth_token"===e.key||"eve_auth_refresh_token"===e.key||"eve_auth_character"===e.key){try{this.accessToken=localStorage.getItem("eve_auth_token"),this.refreshToken=localStorage.getItem("eve_auth_refresh_token");const e=localStorage.getItem("eve_auth_character");this.character=e?JSON.parse(e):null}catch{}this.emit()}})}init(){try{this.accessToken=localStorage.getItem("eve_auth_token"),this.refreshToken=localStorage.getItem("eve_auth_refresh_token");const e=localStorage.getItem("eve_auth_character");this.character=e?JSON.parse(e):null}catch{}this.startCheckTimer(),this.startTickTimer(),window.addEventListener("storage",this.handleStorageEvent),this.getAccessToken(),this.emit()}destroy(){this.checkTimer&&(window.clearInterval(this.checkTimer),this.checkTimer=null),this.tickTimer&&(window.clearInterval(this.tickTimer),this.tickTimer=null),window.removeEventListener("storage",this.handleStorageEvent),this.listeners.clear()}subscribe(e){return this.listeners.add(e),e(this.getState()),()=>this.listeners.delete(e)}getState(){return{accessToken:this.accessToken,refreshToken:this.refreshToken,character:this.character,isRefreshing:this.isRefreshing,remainingMinutes:this.getRemainingMinutes(this.accessToken)}}setTokens(e,t){this.accessToken=e,this.refreshToken=t;try{localStorage.setItem("eve_auth_token",e),localStorage.setItem("eve_auth_refresh_token",t)}catch{}this.emit()}setCharacter(e){this.character=e;try{e?localStorage.setItem("eve_auth_character",JSON.stringify(e)):localStorage.removeItem("eve_auth_character")}catch{}this.emit()}async getAccessToken(e=!1){if(!this.accessToken||!this.refreshToken)return null;if(!(e||this.isExpiringSoon(this.accessToken,2)))return this.accessToken;if(this.pendingRefreshPromise)return this.pendingRefreshPromise;this.isRefreshing=!0,this.emit(),this.pendingRefreshPromise=this.refreshInternal();try{return await this.pendingRefreshPromise}finally{this.pendingRefreshPromise=null,this.isRefreshing=!1,this.emit()}}async refreshInternal(){if(!this.refreshToken)throw new Error("无刷新令牌");const e=await O(this.refreshToken),t=e.access_token,s=e.refresh_token||this.refreshToken;return this.setTokens(t,s),t}startCheckTimer(){this.checkTimer&&window.clearInterval(this.checkTimer),this.checkTimer=window.setInterval(()=>{this.getAccessToken()},6e4)}startTickTimer(){this.tickTimer&&window.clearInterval(this.tickTimer),this.tickTimer=window.setInterval(()=>{this.emit()},6e4)}emit(){const e=this.getState();this.listeners.forEach(t=>t(e))}getRemainingMinutes(e){try{if(!e)return 0;const t=this.parseJWTPayload(e);if(!t.exp)return 0;const s=Math.max(0,1e3*t.exp-Date.now());return Math.floor(s/6e4)}catch{return 0}}isExpiringSoon(e,t){try{const s=this.parseJWTPayload(e);if(!s.exp)return!0;const a=6e4*t;return Date.now()+a>=1e3*s.exp}catch{return!0}}parseJWTPayload(e){const t=e.split(".");if(3!==t.length)throw new Error("Invalid JWT");return JSON.parse(atob(t[1]))}};async function q(e,t,s){const a="string"==typeof s?{type:"region",id:s}:s;try{const s=await async function(e,t,s=!0){try{if("structure"===t.type){if(!t.accessToken)throw new Error("建筑市场需要访问令牌");const a=Number(t.id);if(s){const s=D.getCachedItemOrders(a,t.accessToken,e);if(s)return{typeID:e,orders:s}}const r=(await D.getStructureOrders(a,t.accessToken)).filter(t=>t.type_id===e&&!t.is_buy_order&&t.volume_remain>0).map(e=>({duration:e.duration,is_buy_order:e.is_buy_order,issued:e.issued,location_id:e.location_id,min_volume:e.min_volume,order_id:e.order_id,price:e.price,range:e.range,system_id:0,type_id:e.type_id,volume_remain:e.volume_remain,volume_total:e.volume_total})).sort((e,t)=>e.price-t.price);return{typeID:e,orders:r}}return await V(e,String(t.id))}catch(a){return{typeID:e,orders:[]}}}(e,a),r=s.orders;if(0===r.length)return{totalPrice:0,ordersUsed:[],totalVolume:0};const i=r[0].price;return{totalPrice:i*t,ordersUsed:[{orderId:r[0].order_id,price:i,volumeUsed:t,volumeRemain:r[0].volume_remain}],totalVolume:t}}catch(r){a.type;throw r}}function F(e){const t=new Set;for(const s of e)for(const e of s)t.add(e.typeID);return Array.from(t)}async function V(e,t){try{const s=await fetch(`https://esi.evetech.net/markets/${t}/orders?type_id=${e}&order_type=sell`);if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const a=await s.json();return{typeID:e,orders:a.filter(e=>!e.is_buy_order).sort((e,t)=>e.price-t.price)}}catch(s){return{typeID:e,orders:[]}}}function U(e,t,s,a=!0){if(0===s.length)return{totalPrice:0,actualQuantity:0,isInsufficient:!0,lowestPrice:0};const r=s[0].price;if(!a){return{totalPrice:r*t,actualQuantity:t,isInsufficient:!1,lowestPrice:r}}let i=t,n=0;for(const l of s){if(i<=0)break;const e=Math.min(i,l.volume_remain);n+=e*l.price,i-=e}const c=t-i;return{totalPrice:n,actualQuantity:c,isInsufficient:c<t,lowestPrice:r}}function Q(e,t,s=!0){let a=0;const r=[];for(const i of e){const e=t.get(i.typeID)||[],n=U(i.typeID,i.quantity,e,s);a+=n.totalPrice,r.push({typeID:i.typeID,quantity:i.quantity,price:n.totalPrice,isInsufficient:n.isInsufficient,actualQuantity:n.actualQuantity,lowestPrice:n.lowestPrice})}return{level:0,totalPrice:a,materialsCount:r.length,materials:r}}const J=new class{constructor(){t(this,"config",null)}async loadConfig(){if(this.config)return this.config;try{const e=await fetch("./config/structure-config.json"),t=await e.json();return this.config=t,t}catch(e){throw e}}getConfig(){return this.config}getComplexStructures(){if(!this.config)return[];const e=this.config.structure.complex.map(e=>({name:e.name,value:e.name}));return e.unshift({name:"无建筑",value:"none"}),e}getRefineStructures(){if(!this.config)return[];const e=this.config.structure.refine.map(e=>({name:e.name,value:e.name}));return e.unshift({name:"无建筑",value:"none"}),e}getComplexRigs(){return this.config?[{name:"无插件",value:"none"},{name:"T1",value:"t1"},{name:"T2",value:"t2"}]:[]}getReactionRigs(){return this.config?[{name:"无插件",value:"none"},{name:"T1",value:"t1"},{name:"T2",value:"t2"}]:[]}};const K=new class{constructor(){t(this,"data",null)}async loadData(){if(this.data)return this.data;try{const e=await fetch("./static/solar_systems.json"),t=await e.json();return this.data=t,t}catch(e){throw e}}getData(){return this.data}searchSolarSystems(e){if(!this.data||e.length<2)return[];const t=[],s=e.toLowerCase();for(const[,a]of Object.entries(this.data.solar_systems)){const e=a.solarSystemName_zh.toLowerCase().includes(s),r=a.solarSystemName_en.toLowerCase().includes(s);if(e||r){const e=a.solarSystemName_zh===a.solarSystemName_en?a.solarSystemName_zh:`${a.solarSystemName_zh}/${a.solarSystemName_en}`;t.push({id:a.solarSystemID,displayName:e,securityColor:this.getSecurityColor(a.display_security),displaySecurity:a.display_security})}}return t.filter((e,t,s)=>t===s.findIndex(t=>t.id===e.id)).sort((e,t)=>e.displayName.localeCompare(t.displayName))}getSolarSystemById(e){return this.data&&this.data.solar_systems[e.toString()]||null}getDisplayNameById(e){const t=this.getSolarSystemById(e);return t?t.solarSystemName_zh===t.solarSystemName_en?t.solarSystemName_zh:`${t.solarSystemName_zh}/${t.solarSystemName_en}`:null}getSecurityColor(e){switch(e){case 1:return"#4173d4";case.9:return"#5598e5";case.8:return"#73cbf4";case.7:return"#81d8a9";case.6:case.5:return"#8fe167";case.4:case.3:return"#d0712d";case.2:case.1:return"#bc1117";default:return e<=0?"#82375d":"#ff0000"}}getDisplayNameWithSecurity(e){const t=this.getSolarSystemById(e);if(!t)return null;return{displayName:t.solarSystemName_zh===t.solarSystemName_en?t.solarSystemName_zh:`${t.solarSystemName_zh}/${t.solarSystemName_en}`,securityColor:this.getSecurityColor(t.display_security),displaySecurity:t.display_security}}};const W=new class{constructor(){t(this,"systemsData",null),t(this,"lastFetchTime",0),t(this,"CACHE_DURATION",3e5)}async loadSystemsData(){const e=Date.now();if(this.systemsData&&e-this.lastFetchTime<this.CACHE_DURATION)return this.systemsData;try{const t=await fetch("https://esi.evetech.net/industry/systems");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const s=await t.json();return this.systemsData=s,this.lastFetchTime=e,s}catch(t){throw t}}getSystemsData(){return this.systemsData}getManufacturingCostIndex(e){if(!this.systemsData)return null;const t=this.systemsData.find(t=>t.solar_system_id===e);if(!t)return null;const s=t.cost_indices.find(e=>"manufacturing"===e.activity);return s?s.cost_index:null}getReactionCostIndex(e){if(!this.systemsData)return null;const t=this.systemsData.find(t=>t.solar_system_id===e);if(!t)return null;const s=t.cost_indices.find(e=>"reaction"===e.activity);return s?s.cost_index:null}formatCostIndex(e){return`${(100*e).toFixed(2)}%`}getSystemCostIndices(e){return{manufacturing:this.getManufacturingCostIndex(e),reaction:this.getReactionCostIndex(e)}}};const H=new class{constructor(){t(this,"priceCache",new Map),t(this,"lastFetchTime",0),t(this,"CACHE_DURATION",3e5)}async fetchMarketPrices(){try{const e=await fetch("https://esi.evetech.net/markets/prices");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){return[]}}async getAdjustedPrices(e){const t=Date.now();if(t-this.lastFetchTime<this.CACHE_DURATION&&this.priceCache.size>0){const t=new Map;for(const s of e){const e=this.priceCache.get(s);void 0!==e&&t.set(s,e)}return t}const s=await this.fetchMarketPrices();this.priceCache.clear();for(const r of s)this.priceCache.set(r.type_id,r.adjusted_price);this.lastFetchTime=t;const a=new Map;for(const r of e){const e=this.priceCache.get(r);void 0!==e&&a.set(r,e)}return a}async calculateEIV(e){const t=e.map(e=>e.typeID),s=await this.getAdjustedPrices(t);let a=0;for(const r of e){a+=(s.get(r.typeID)??0)*r.quantity}return a}getSystemCostIndex(e,t){let s;if(s=t?W.getReactionCostIndex(e):W.getManufacturingCostIndex(e),null!==s)return s;return.0014}getTaxRateDetails(e,t,s,a=0){const r=this.getSystemCostIndex(e,s),i=.04,n=t,c=a/100;return{costIndex:r,facilityTax:t,scc:i,structureTax:a,totalRate:r*n+(c+i),details:[`星系成本指数（系数）: ${(100*r).toFixed(2)}%`,`建筑费用减免: ${(100*n).toFixed(2)}%`,`设施税率: ${(100*c).toFixed(2)}%`,`SCC费用: ${4..toFixed(2)}%`]}}async calculateFacilityCost(e){return await this.calculateEIV(e.materials)*this.getTaxRateDetails(e.solarSystemId,e.facilityTax,e.isReaction,e.structureTax||0).totalRate}},G=Object.freeze(Object.defineProperty({__proto__:null,marketPriceService:H},Symbol.toStringTag,{value:"Module"}));const X=new class{calculateBlueprintMaterials(e){const t=b.getEveData();if(!t)return[];const s=b.getBlueprintInfo(e.itemId);if(!s)return[];const a=this.calculateBonus(e);if(!a)return[];const r=[];return s.materials&&s.materials.forEach(s=>{var i;const n=s.quantity||0,c=n*e.runs;let l;l=n<=1?c:Math.ceil(c*a.materialBonus);const o=t.type_info[s.typeId.toString()],u=b.getBlueprintInfo(s.typeId),d={typeID:s.typeId,typeName_zh:(null==o?void 0:o.zh_name)||`未知物品_${s.typeId}`,typeName_en:(null==o?void 0:o.en_name)||`Unknown_${s.typeId}`,quantity:l,volume:k(o),hasBlueprint:!!u,blueprintTypeID:(null==u?void 0:u.blueprintId)||null};if(r.push(d),e.isRecursive&&d.hasBlueprint&&d.blueprintTypeID&&!(null==(i=e.excludedMaterials)?void 0:i.has(s.typeId))&&(void 0===e.maxDepth||e.maxDepth>0)){e.globalMaterialEfficiency,e.globalTimeEfficiency,e.structureType,e.rigType,e.solarSystemId,e.excludedMaterials,void 0!==e.maxDepth&&e.maxDepth,e.globalMaterialEfficiency,e.globalTimeEfficiency;const t=b.getBlueprintInfo(d.blueprintTypeID);if(t){const e=l;Math.ceil(e/t.outputQuantity)}}}),r}calculateBonus(e){const t=b.getBlueprintInfo(e.itemId);if(!t)return null;const s="reaction"===t.category,a=s?1:1-.01*e.materialEfficiency,r=s?1:1-.01*e.timeEfficiency,i=J.getConfig();if(!i)return null;let n=1,c=1,l=1;if(s){if("none"!==e.structureType){const t=i.structure.refine.find(t=>t.name===e.structureType);t&&(n=t.ME,c=t.TE,l=t.Cost)}}else if("none"!==e.structureType){const t=i.structure.complex.find(t=>t.name===e.structureType);t&&(n=t.ME,c=t.TE,l=t.Cost)}let o=1,u=1;if("none"!==e.rigType){const t=s?i["reaction-rigs"][e.rigType]:i["complex-rigs"][e.rigType];if(t&&(u=t.Cost,e.solarSystemId)){const s=K.getSolarSystemById(e.solarSystemId);if(s){const e=s.display_security;let a=1;a=e>=.5?t.hs:e>=0?t.ls:t.ns,o=1-a*(1-t.ME)}}}return{materialBonus:a*n*o,timeBonus:r*c,costBonus:l*u,isReaction:s,blueprintME:a,blueprintTE:r,structureME:n,structureTE:c,structureCost:l,rigSecurityBonus:o,rigCost:u}}getOutputQuantity(e){const t=b.getBlueprintInfo(e);return(null==t?void 0:t.outputQuantity)||1}async calculateFacilityCost(e,t){if(!t.solarSystemId)return{facilityCost:0,eiv:0,costIndex:0,facilityTax:0,scc:.04,totalTaxRate:0,taxDetails:[]};const s=this.calculateBonus(t);if(!s)return{facilityCost:0,eiv:0,costIndex:0,facilityTax:0,scc:.04,totalTaxRate:0,taxDetails:[]};const a=b.getBlueprintInfo(t.itemId),r=[];(null==a?void 0:a.materials)&&a.materials.forEach(e=>{const s=(e.quantity||0)*t.runs,a=b.getEveData(),i=null==a?void 0:a.type_info[e.typeId.toString()];r.push({typeID:e.typeId,quantity:s,typeName:(null==i?void 0:i.zh_name)||`未知物品_${e.typeId}`})});const i={materials:r,solarSystemId:t.solarSystemId,facilityTax:s.structureCost,isReaction:s.isReaction,scc:.04},n=await H.calculateFacilityCost(i),c=H.getTaxRateDetails(t.solarSystemId,s.structureCost,s.isReaction);return{facilityCost:n,eiv:n/c.totalRate,costIndex:c.costIndex,facilityTax:c.facilityTax,scc:c.scc,totalTaxRate:c.totalRate,taxDetails:c.details}}},Y=({selectedNode:e,settings:t,authToken:a})=>{var i;const[l,o]=s.useState({materialEfficiency:(null==t?void 0:t.materialEfficiency)??0,timeEfficiency:(null==t?void 0:t.timeEfficiency)??0,runs:(null==t?void 0:t.runs)??1}),[u,d]=s.useState((null==(i=null==t?void 0:t.runs)?void 0:i.toString())??"1"),[h,m]=s.useState((null==t?void 0:t.runs)??1),[p,y]=s.useState(new Set),[f,v]=s.useState(new Set),x=r.useRef(new Map),S=r.useRef(new Map),[N,I]=s.useState([]),[w,E]=s.useState(!1),[T,M]=s.useState(null),[$,R]=s.useState(!1),[P,B]=s.useState(!1),[O,A]=s.useState(""),[L,J]=s.useState(new Map),[K,W]=s.useState(null),[H,Y]=s.useState("price"),[Z,ee]=s.useState(new Set);s.useEffect(()=>{null!=K&&ee(new Set)},[K]);const te=e=>e.replace(/\*/g,"").trim().toLowerCase();s.useEffect(()=>{var s;e&&(o(e=>({materialEfficiency:(null==t?void 0:t.materialEfficiency)??e.materialEfficiency??0,timeEfficiency:(null==t?void 0:t.timeEfficiency)??e.timeEfficiency??0,runs:(null==t?void 0:t.runs)??e.runs??1})),d((null==(s=null==t?void 0:t.runs)?void 0:s.toString())??"1"),m((null==t?void 0:t.runs)??1))},[null==e?void 0:e.id]),s.useEffect(()=>{y(new Set),v(new Set)},[null==e?void 0:e.id]),s.useEffect(()=>{const e=setTimeout(()=>{m(l.runs)},500);return()=>clearTimeout(e)},[l.runs]),s.useEffect(()=>{if(null==(null==t?void 0:t.runs))return;const e=l.runs,s=""===u?NaN:parseInt(u);e===t.runs&&(!!isNaN(s)||s===t.runs)&&(o(e=>({...e,runs:t.runs})),d(String(t.runs)),m(t.runs))},[null==t?void 0:t.runs]);const se=async s=>{if((null==t?void 0:t.marketSelection)||(null==t?void 0:t.structureMarketId)){E(!0);try{const r="structure"===t.marketType&&t.structureMarketId&&await z.getAccessToken()||void 0,i="structure"===t.marketType&&t.structureMarketId?{type:"structure",id:t.structureMarketId,accessToken:r}:{type:"region",id:t.marketSelection};if("structure"===i.type&&i.accessToken)try{await D.preloadStructureOrders(Number(i.id),i.accessToken)}catch(a){}const n={itemId:parseInt((null==e?void 0:e.id)||"0"),runs:h,materialEfficiency:l.materialEfficiency,timeEfficiency:l.timeEfficiency,structureType:t.complexStructure,rigType:t.complexRig,solarSystemId:t.complexSolarSystem,excludedMaterials:f},c=X.calculateBonus(n),o=(null==ne?void 0:ne.materialLevels.map(e=>e.materials.filter(e=>e.hasBlueprint&&!f.has(e.typeID)).map(e=>({typeID:e.typeID,quantity:e.quantity,typeName:e.typeName_zh}))))||[],u=(null==ne?void 0:ne.materialLevels.map(e=>e.taxCalculationMaterials))||[],d=await async function(e,t,s=!0,r,i,n,c,l,o,u){try{const d="string"==typeof t?{type:"region",id:t}:t,h=(()=>{const t=F(e),s=u?F(u.map(e=>e.map(e=>({typeID:e.typeID,quantity:e.quantity})))):[];return Array.from(new Set([...t,...s]))})(),m=new Map;if("structure"===d.type)try{const e=d.accessToken||await z.getAccessToken();if(!e)throw new Error("建筑市场需要访问令牌");const t=await D.getStructureOrders(Number(d.id),e);h.forEach(e=>{const s=t.filter(t=>t.type_id===e&&!t.is_buy_order&&t.volume_remain>0).map(e=>({duration:e.duration,is_buy_order:e.is_buy_order,issued:e.issued,location_id:e.location_id,min_volume:e.min_volume,order_id:e.order_id,price:e.price,range:e.range,system_id:0,type_id:e.type_id,volume_remain:e.volume_remain,volume_total:e.volume_total})).sort((e,t)=>e.price-t.price);m.set(e,s)})}catch(a){h.forEach(e=>{m.set(e,[])})}else{const e=h.map(async e=>{try{return{typeID:e,orders:(await V(e,String(d.id))).orders}}catch(a){return{typeID:e,orders:[]}}});(await Promise.all(e)).forEach(e=>{m.set(e.typeID,e.orders)})}const p=[];for(let t=0;t<e.length;t++){const u=Q(e[t],m,s);if(u.level=t+1,void 0!==r&&void 0!==i&&void 0!==n)try{let s=[];s=l&&l[t]?l[t]:c&&c[t]?c[t]:e[t].map(e=>({typeID:e.typeID,quantity:e.quantity,typeName:`Material_${e.typeID}`}));const{marketPriceService:a}=await j(async()=>{const{marketPriceService:e}=await Promise.resolve().then(()=>G);return{marketPriceService:e}},void 0,import.meta.url),d=await a.calculateEIV(s),h=a.getTaxRateDetails(r,i,n,o||0),m=d*h.totalRate;u.eiv=d,u.facilityCost=m,u.totalTaxRate=h.totalRate}catch(a){}p.push(u)}for(let e=0;e<p.length;e++){const t=p[e];t.facilityCost;let s=0;for(let a=e;a>=0;a--)s+=p[a].facilityCost||0;t.cumulativeFacilityCost=s}if(u)for(let e=0;e<p.length;e++){const t=p[e],a=u[e]||[];let r=0;for(const e of a){const t=m.get(e.typeID)||[];r+=U(e.typeID,e.quantity,t,s).totalPrice}t.leftoverCumulativePrice=r}for(let e=0;e<p.length;e++){const t=p[e],s=t.totalPrice||0,a=t.leftoverCumulativePrice||0,r=t.cumulativeFacilityCost||0;t.totalCost=s-a+r}return p}catch(a){throw a}}(s,i,t.considerOrderVolume,t.complexSolarSystem||void 0,null==c?void 0:c.structureCost,null==c?void 0:c.isReaction,o,u,t.complexTax||0,(null==ne?void 0:ne.materialLevels.map(e=>e.leftoverProducts))||[]);I(d)}catch(a){I([])}finally{E(!1)}}},ae=async(e,t=!1)=>{try{const s=e.map(e=>`${t?e.typeName_en:e.typeName_zh}    ${e.quantity.toLocaleString()}`).join("\n");await navigator.clipboard.writeText(s)}catch(s){}},re=({width:e,height:t,data:s})=>{const a=Math.min(e,t)/2,r=e/2,i=t/2,n=s.reduce((e,t)=>e+t.value,0)||1;let c=-Math.PI/2;const l=[];return s.forEach((e,t)=>{if(1===s.length||Math.abs(e.value-n)<1e-6)return void l.push(g.jsx("circle",{cx:r,cy:i,r:a,fill:e.color},t));const o=e.value/n*Math.PI*2,u=r+a*Math.cos(c),d=i+a*Math.sin(c),h=r+a*Math.cos(c+o),m=i+a*Math.sin(c+o),p=o>Math.PI?1:0,y=`M ${r} ${i} L ${u} ${d} A ${a} ${a} 0 ${p} 1 ${h} ${m} Z`;l.push(g.jsx("path",{d:y,fill:e.color},t)),c+=o}),g.jsx("svg",{width:e,height:t,viewBox:`0 0 ${e} ${t}`,children:l})},ie=(e,s,a,i=0)=>{const l=a?`${s}-${a}-${e.typeID}`:`${s}-${e.typeID}`,o=p.has(l),u=f.has(e.typeID),d=N.find(e=>e.level===s),h=null==d?void 0:d.materials.find(t=>t.typeID===e.typeID);return g.jsxs(r.Fragment,{children:[g.jsxs("div",{className:`material-item ${e.hasBlueprint?"has-blueprint":""} ${e.isReaction?"is-reaction":""} ${e.hasBlueprint?"clickable":""} ${u?"excluded":""} ${e.deductedQuantity?"deducted":""}`,onClick:()=>((e,t,s)=>{if(!e.hasBlueprint)return;let a;a=s?`${t}-${s}-${e.typeID}`:`${t}-${e.typeID}`;const r=new Set(p);if(r.has(a)){r.delete(a);const s=[];r.forEach(a=>{a.startsWith(`${t}-${e.typeID}-`)&&s.push(a)}),s.forEach(e=>{r.delete(e)})}else r.add(a);y(r)})(e,s,a),style:{marginLeft:20*i+"px"},children:[g.jsx("div",{className:"material-icon",children:g.jsx(_,{src:`./static/icons/${e.typeIcon}`,alt:e.typeName_zh,size:24,showLoadingIndicator:!0})}),g.jsxs("div",{className:"material-info",children:[g.jsxs("div",{className:"material-name",children:[e.typeName_zh," × ",e.quantity.toLocaleString(),e.deductedQuantity?g.jsxs("span",{style:{marginLeft:6,color:"#ffeb3b",fontSize:11},children:["(-",e.deductedQuantity.toLocaleString(),")"]}):null,e.hasBlueprint&&g.jsx("span",{className:"expand-indicator "+(o?"expanded":""),children:o?"▼":"▶"})]}),h&&g.jsxs("div",{className:"material-price "+(h.isInsufficient?"insufficient":""),children:[C(h.price),h.isInsufficient&&g.jsxs("span",{className:"insufficient-warning",children:["(订单不足: ",h.actualQuantity.toLocaleString(),"/",e.quantity.toLocaleString(),")"]})]}),w&&!h&&g.jsx("div",{className:"material-price-loading",children:"计算价格中..."})]}),g.jsxs("div",{className:"material-volume",children:[(e.totalVolume||0).toFixed(2)," m³"]}),g.jsx("div",{className:"material-blueprint-status",children:e.hasBlueprint?e.isReaction?g.jsx("span",{className:"reaction-badge",children:"反应"}):g.jsx("span",{className:"blueprint-badge",children:"蓝图"}):g.jsx("span",{className:"no-blueprint-badge",children:"无蓝图"})}),e.hasBlueprint&&g.jsx("div",{className:"material-exclusion-control",children:g.jsx("button",{className:"exclusion-button "+(u?"excluded":""),onClick:t=>{t.stopPropagation(),((e,t)=>{if(void 0!==t){const e=x.current.get(t);e&&S.current.set(t,e.scrollTop)}const s=new Set(f);s.has(e)?s.delete(e):s.add(e),v(s),void 0!==t&&requestAnimationFrame(()=>{const e=x.current.get(t),s=S.current.get(t)??0;e&&(e.scrollTop=s)})})(e.typeID,s)},title:u?"恢复拆解":"排除拆解",children:u?g.jsx(n,{}):g.jsx(c,{})})})]}),o&&e.hasBlueprint&&e.blueprintTypeID&&t&&(()=>{const a=b.getBlueprintInfo(e.typeID);if(!a||!e.blueprintTypeID)return null;const r=u?g.jsx("div",{className:"excluded-material-notice",style:{marginLeft:20*(i+1)+"px"},children:g.jsxs("div",{className:"notice-content",children:[g.jsx("span",{className:"notice-icon",children:"ℹ️"}),g.jsx("span",{className:"notice-text",children:"此材料已被排除，其子材料不会在后续层级中继续拆解"})]})}):null,n=e.quantity||0,c=Math.ceil(n/a.outputQuantity),l="reaction"===a.category,o={itemId:e.blueprintTypeID,runs:c,materialEfficiency:(null==t?void 0:t.materialEfficiency)||0,timeEfficiency:(null==t?void 0:t.timeEfficiency)||0,structureType:l?t.refineStructure:t.complexStructure,rigType:l?t.reactionRig:t.complexRig,solarSystemId:l?t.refineSolarSystem:t.complexSolarSystem,excludedMaterials:f,isRecursive:!1,maxDepth:1,globalMaterialEfficiency:(null==t?void 0:t.materialEfficiency)||0,globalTimeEfficiency:(null==t?void 0:t.timeEfficiency)||0},d=X.calculateBlueprintMaterials(o).map(t=>{const a=b.getEveData(),r=null==a?void 0:a.type_info[t.typeID.toString()],n=(t.volume||k(r))*t.quantity,c=t.hasBlueprint,l=c&&t.blueprintTypeID&&(null==a?void 0:a.reaction.includes(t.blueprintTypeID))||!1;return ie({typeID:t.typeID,typeName_zh:t.typeName_zh,typeName_en:t.typeName_en,typeIcon:(null==r?void 0:r.icon_name)||"",quantity:t.quantity,totalVolume:n,hasBlueprint:c||!1,isReaction:l||!1,blueprintTypeID:t.blueprintTypeID},s,e.typeID,i+1)});return g.jsxs(g.Fragment,{children:[r,d]})})()]},l)},ne=s.useMemo(()=>{if(!e||"item"!==e.type||!t)return null;const s=parseInt(e.id),a=(()=>{const e=b.getBlueprintInfo(s);return"reaction"===(null==e?void 0:e.category)})(),r={itemId:s,runs:h||1,materialEfficiency:l.materialEfficiency,timeEfficiency:l.timeEfficiency,structureType:a?t.refineStructure:t.complexStructure,rigType:a?t.reactionRig:t.complexRig,solarSystemId:a?t.refineSolarSystem:t.complexSolarSystem,excludedMaterials:f,isRecursive:!1,maxDepth:1,globalMaterialEfficiency:(null==t?void 0:t.materialEfficiency)||0,globalTimeEfficiency:(null==t?void 0:t.timeEfficiency)||0},i=X.calculateBlueprintMaterials(r),n=i.map(e=>{const t=b.getEveData(),s=null==t?void 0:t.type_info[e.typeID.toString()],a=e.volume||k(s);return{typeID:e.typeID,typeName_zh:e.typeName_zh,typeName_en:e.typeName_en,typeIcon:(null==s?void 0:s.icon_name)||"",quantity:e.quantity,volume:a,totalVolume:a*e.quantity,hasBlueprint:e.hasBlueprint||!1,isReaction:(()=>{if(!e.hasBlueprint||!e.blueprintTypeID)return!1;const t=b.getEveData();return(null==t?void 0:t.reaction.includes(e.blueprintTypeID))||!1})()||!1,blueprintTypeID:e.blueprintTypeID}}).sort((e,t)=>{const s=f.has(e.typeID),a=f.has(t.typeID);return s&&!a?-1:!s&&a?1:e.typeID-t.typeID}),c=(()=>{const e=[],a=b.getBlueprintInfo(s),r=[],i=new Map;(null==a?void 0:a.materials)&&a.materials.forEach(e=>{if(!f.has(e.typeId)){const t=(e.quantity||0)*h,s=b.getEveData(),a=null==s?void 0:s.type_info[e.typeId.toString()];r.push({typeID:e.typeId,quantity:t,typeName:(null==a?void 0:a.zh_name)||`未知物品_${e.typeId}`})}}),e.push({level:1,materials:n,hasNextLevel:n.some(e=>e.hasBlueprint&&!f.has(e.typeID)),taxCalculationMaterials:r,leftoverProducts:[]});let c=1,o=n,u=o.some(e=>e.hasBlueprint&&!f.has(e.typeID));for(;u;){const s=new Map;o.forEach(e=>{if(e.hasBlueprint&&e.blueprintTypeID&&!f.has(e.typeID)){const a=b.getBlueprintInfo(e.typeID);if(a&&e.blueprintTypeID){const r=e.quantity||0,i=Math.ceil(r/a.outputQuantity),n="reaction"===a.category,c={itemId:e.blueprintTypeID,runs:i,materialEfficiency:(null==t?void 0:t.materialEfficiency)||0,timeEfficiency:(null==t?void 0:t.timeEfficiency)||0,structureType:n?t.refineStructure:t.complexStructure,rigType:n?t.reactionRig:t.complexRig,solarSystemId:n?t.refineSolarSystem:t.complexSolarSystem,excludedMaterials:f,isRecursive:!1,maxDepth:1,globalMaterialEfficiency:(null==t?void 0:t.materialEfficiency)||0,globalTimeEfficiency:(null==t?void 0:t.timeEfficiency)||0};X.calculateBlueprintMaterials(c).forEach(e=>{const t=b.getEveData(),a=null==t?void 0:t.type_info[e.typeID.toString()],r=e.volume||k(a),i=r*e.quantity,n=e.hasBlueprint,c=n&&e.blueprintTypeID&&(null==t?void 0:t.reaction.includes(e.blueprintTypeID))||!1,l=s.get(e.typeID);l?(l.quantity+=e.quantity,l.totalVolume=(l.totalVolume||0)+i):s.set(e.typeID,{typeID:e.typeID,typeName_zh:e.typeName_zh,typeName_en:e.typeName_en,typeIcon:(null==a?void 0:a.icon_name)||"",quantity:e.quantity,volume:r,totalVolume:i,hasBlueprint:n||!1,isReaction:c||!1,blueprintTypeID:e.blueprintTypeID})})}}else{const t=s.get(e.typeID);t?(t.quantity+=e.quantity,t.totalVolume=(t.totalVolume||0)+(e.totalVolume||0)):s.set(e.typeID,{typeID:e.typeID,typeName_zh:e.typeName_zh,typeName_en:e.typeName_en,typeIcon:e.typeIcon,quantity:e.quantity,volume:e.volume,totalVolume:e.totalVolume,hasBlueprint:e.hasBlueprint,isReaction:e.isReaction,blueprintTypeID:e.blueprintTypeID})}});const a=Array.from(s.values()).sort((e,t)=>{const s=f.has(e.typeID),a=f.has(t.typeID);return s&&!a?-1:!s&&a?1:e.typeID-t.typeID}),r=[],n=[];o.forEach(e=>{if(e.hasBlueprint&&e.blueprintTypeID&&!f.has(e.typeID)){const s=b.getBlueprintInfo(e.typeID);if(s&&e.blueprintTypeID){const a=e.quantity||0,i=Math.ceil(a/s.outputQuantity),c=i*s.outputQuantity-a;c>0&&n.push({typeID:e.typeID,quantity:c,typeName:e.typeName_zh});const o={itemId:e.blueprintTypeID,runs:1,materialEfficiency:l.materialEfficiency,timeEfficiency:l.timeEfficiency,structureType:(null==t?void 0:t.complexStructure)||"engineering_complex",rigType:(null==t?void 0:t.complexRig)||"none",solarSystemId:(null==t?void 0:t.complexSolarSystem)||null,excludedMaterials:f};if(!X.calculateBonus(o))return;s.materials.forEach(e=>{const t=(e.quantity||0)*i,s=r.findIndex(t=>t.typeID===e.typeId);if(s>=0)r[s].quantity+=t;else{const s=b.getEveData(),a=null==s?void 0:s.type_info[e.typeId.toString()];r.push({typeID:e.typeId,quantity:t,typeName:(null==a?void 0:a.zh_name)||`未知物品_${e.typeId}`})}})}}});const d=new Map;n.forEach(e=>{const t=d.get(e.typeID);t?t.quantity+=e.quantity:d.set(e.typeID,{...e})});const h=Array.from(d.values());c++,o=a,u=o.some(e=>e.hasBlueprint&&!f.has(e.typeID)),h.forEach(e=>{const t=i.get(e.typeID);t?t.quantity+=e.quantity:i.set(e.typeID,{...e})}),e.push({level:c,materials:a,hasNextLevel:u,taxCalculationMaterials:r,leftoverProducts:Array.from(i.values())})}return e})().map(e=>{const t=e.materials.map(e=>({...e})),s=new Map(L);return t.forEach(e=>{const t=te(e.typeName_zh),a=te(e.typeName_en);if(t===a){const a=s.get(t)||0;if(a>0&&e.quantity>0){const r=Math.min(a,e.quantity);e.quantity-=r,e.volume&&(e.totalVolume=(e.volume||0)*e.quantity),e.deductedQuantity=r,s.set(t,a-r)}return}const r=s.get(t)||0,i=s.get(a)||0,n=r+i;if(n>0&&e.quantity>0){const c=Math.min(n,e.quantity);let l=c;if(r>0){const e=Math.min(r,l);l-=e,s.set(t,r-e)}if(l>0&&i>0){const e=Math.min(i,l);l-=e,s.set(a,i-e)}e.quantity-=c,e.volume&&(e.totalVolume=(e.volume||0)*e.quantity),e.deductedQuantity=c}}),{...e,materials:t}}),o=X.getOutputQuantity(s);return{blueprintName_zh:e.name,blueprintName_en:e.name_en,outputQuantity:o,materials:n,materialLevels:c,blueprintMaterials:i}},[null==e?void 0:e.id,null==e?void 0:e.type,h,l.materialEfficiency,l.timeEfficiency,f,null==t?void 0:t.marketSelection,L]);return s.useEffect(()=>{if(!ne)return;if(!("structure"===(null==t?void 0:t.marketType)?Boolean(null==t?void 0:t.structureMarketId):Boolean(null==t?void 0:t.marketSelection)))return;const s=ne.materialLevels.map(e=>e.materials.map(e=>({typeID:e.typeID,quantity:e.quantity})));if(s.length>0&&se(s),ne.outputQuantity){const s=ne.outputQuantity*h;(async(e,s)=>{if((null==t?void 0:t.marketSelection)||(null==t?void 0:t.structureMarketId)){R(!0);try{const r="structure"===t.marketType&&t.structureMarketId?{type:"structure",id:t.structureMarketId,accessToken:a||void 0}:{type:"region",id:t.marketSelection},i=await q(e,s,r);M({price:i.totalPrice,isInsufficient:!1,actualQuantity:s})}catch(r){M(null)}finally{R(!1)}}})(parseInt((null==e?void 0:e.id)||"0"),s)}},[ne,null==t?void 0:t.marketSelection,null==t?void 0:t.structureMarketId,null==t?void 0:t.marketType,null==t?void 0:t.considerOrderVolume,null==t?void 0:t.complexSolarSystem,null==t?void 0:t.complexTax,h,null==e?void 0:e.id,f,a]),e?"item"!==e.type?g.jsx("div",{className:"blueprint-view",children:g.jsxs("div",{className:"no-blueprint",children:[g.jsx("div",{className:"no-blueprint-icon",children:"📁"}),g.jsx("div",{className:"no-blueprint-text",children:"此分类不包含制造信息"})]})}):ne?g.jsxs("div",{className:"blueprint-view",children:[g.jsx("div",{className:"blueprint-header",children:g.jsxs("div",{className:"blueprint-header-content",children:[g.jsx("div",{className:"blueprint-icon",children:g.jsx(_,{src:(()=>{const t=b.getEveData(),s=null==t?void 0:t.type_info[e.id];return(null==s?void 0:s.icon_name)?`./static/icons/${s.icon_name}`:`./static/icons/icon_${e.id}_64.png`})(),alt:ne.blueprintName_zh,size:64,showLoadingIndicator:!0})}),g.jsxs("div",{className:"blueprint-info",children:[g.jsxs("div",{className:"blueprint-name",children:[ne.blueprintName_zh,g.jsxs("span",{className:"blueprint-name-en",children:[" (",ne.blueprintName_en,")"]})]}),(()=>{const t=e&&"item"===e.type?b.getBlueprintInfo(parseInt(e.id)):null,s="reaction"===(null==t?void 0:t.category);return g.jsxs("div",{className:"blueprint-settings",children:[g.jsxs("div",{className:"blueprint-setting-item",children:[g.jsx("label",{children:"流程数:"}),g.jsx("input",{type:"number",min:"1",max:"10000",value:u,onFocus:e=>{e.target.select()},onChange:e=>{const t=e.target.value;d(t);const s=""===t||isNaN(parseInt(t))?1:Math.max(1,parseInt(t));o({...l,runs:s})},onBlur:e=>{""===e.target.value&&(d("1"),o({...l,runs:1}))}})]}),g.jsxs("div",{className:"blueprint-setting-item",children:[g.jsx("label",{children:"材料效率:"}),g.jsx("select",{value:l.materialEfficiency,disabled:s,onChange:e=>o({...l,materialEfficiency:parseInt(e.target.value)}),children:Array.from({length:11},(e,t)=>t).map(e=>g.jsx("option",{value:e,children:e},e))})]}),g.jsxs("div",{className:"blueprint-setting-item",children:[g.jsx("label",{children:"时间效率:"}),g.jsx("select",{value:l.timeEfficiency,disabled:s,onChange:e=>o({...l,timeEfficiency:parseInt(e.target.value)}),children:Array.from({length:11},(e,t)=>2*t).map(e=>g.jsx("option",{value:e,children:e},e))})]}),g.jsx("div",{className:"blueprint-setting-item",children:g.jsx("span",{className:"disabled-hint",children:"此处选项会覆盖设置中的默认效率，仅影响此蓝图"})})]})})(),g.jsx("div",{className:"output-info",children:(()=>{const s=(()=>{if(!t)return null;const s={...t,...l},a=e&&"item"===e.type?parseInt(e.id):null;if(!a)return null;const r=b.getBlueprintInfo(a);if(!r)return null;const i="reaction"===r.category,n={itemId:a,runs:1,materialEfficiency:s.materialEfficiency,timeEfficiency:s.timeEfficiency,structureType:i?s.refineStructure:s.complexStructure,rigType:i?s.reactionRig:s.complexRig,solarSystemId:i?s.refineSolarSystem:s.complexSolarSystem},c=X.calculateBonus(n);if(!c)return null;const o=e=>{const t=Math.round(1e5*e)/1e5;return t%1==0?t.toString():t.toFixed(5).replace(/\.?0+$/,"")},u=`${o(100*(1-c.materialBonus))}%`,d=`${o(100*(1-c.timeBonus))}%`,h=`${o(100*(1-c.costBonus))}%`;return{materialBonus:c.materialBonus,timeBonus:c.timeBonus,costBonus:c.costBonus,materialBonusText:u,timeBonusText:d,costBonusText:h,materialComponents:{blueprintME:c.blueprintME,structureME:c.structureME,rigSecurityBonus:c.rigSecurityBonus},timeComponents:{blueprintTE:c.blueprintTE,structureTE:c.structureTE},costComponents:{structureCost:c.structureCost,rigCost:c.rigCost}}})(),a=ne.outputQuantity*h;return g.jsxs("div",{className:"bonus-info-container",children:[g.jsxs("div",{className:"output-row",children:[g.jsxs("div",{className:"bonus-item",children:["产出数量: ",(e=>{const t=Math.round(1e5*e)/1e5;return t%1==0?t.toString():t.toFixed(5).replace(/\.?0+$/,"")})(a)]}),s&&g.jsxs(g.Fragment,{children:[g.jsxs("div",{className:"bonus-item",children:["材料加成: -",s.materialBonusText]}),g.jsxs("div",{className:"bonus-item",children:["时间加成: -",s.timeBonusText]}),g.jsxs("div",{className:"bonus-item",children:["成本加成: -",s.costBonusText]})]})]}),T&&g.jsxs("div",{className:"bonus-item product-price "+(T.isInsufficient?"insufficient":""),children:["产品售价: ",C(T.price),T.isInsufficient&&g.jsxs("span",{className:"insufficient-warning",children:["(订单不足: ",T.actualQuantity.toLocaleString(),"/",a.toLocaleString(),")"]})]}),$&&!T&&g.jsx("div",{className:"bonus-item product-price-loading",children:"计算产品售价中..."})]})})()})]})]})}),g.jsxs("div",{className:"materials-section",children:[g.jsxs("div",{className:"materials-header",children:[g.jsx("h4",{children:"材料需求"}),g.jsx("div",{className:"materials-header-actions",children:g.jsx("button",{className:"copy-button",onClick:()=>B(!0),title:"登记已有材料",children:"登记已有材料"})})]}),P&&g.jsx("div",{className:"existing-modal-overlay",onClick:()=>B(!1),children:g.jsxs("div",{className:"existing-modal",onClick:e=>e.stopPropagation(),children:[g.jsx("div",{className:"existing-modal-header",children:g.jsx("div",{className:"existing-modal-title",children:"登记已有材料"})}),g.jsx("div",{className:"existing-modal-body",children:g.jsx("textarea",{className:"existing-textarea",placeholder:"示例\n高密度黏土克里石*    1,965,821    克里石*            23,589.85 m3    819,177,268.91 星币\n重水*    12,500    冰矿产物*            5,000 m3    1,461,625.00 星币",value:O,onChange:e=>A(e.target.value)})}),g.jsxs("div",{className:"existing-modal-footer",children:[g.jsx("button",{className:"existing-btn",onClick:()=>A(""),children:"清空"}),g.jsx("button",{className:"existing-btn primary",onClick:()=>{const e=(e=>{const t=new Map,s=e.split(/\r?\n/);for(const a of s){const e=a.trim();if(!e)continue;const s=e.split(/\t+| {4,}/);if(s.length<2)continue;const r=(s[0]||"").replace(/\*+$/,"").trim(),i=(s[1]||"").replace(/,/g,"").trim(),n=parseFloat(i);if(!r||!isFinite(n))continue;const c=te(r);t.set(c,(t.get(c)||0)+n)}return t})(O);Array.from(e.entries()).map(([e,t])=>({name:e,quantity:t}));J(e),B(!1)},children:"确认"})]})]})}),g.jsx("div",{className:"materials-columns",children:ne.materialLevels.map(e=>{const t=N.find(t=>t.level===e.level);return g.jsxs("div",{className:"materials-column",children:[g.jsxs("div",{className:"materials-column-header",children:[g.jsxs("div",{className:"header-title-section",children:[g.jsxs("h5",{className:(null==t?void 0:t.materials.some(e=>e.isInsufficient))?"layer-title insufficient":"layer-title",children:["第",e.level,"层材料",(()=>{const t=e.materials.reduce((e,t)=>e+(t.totalVolume||0),0);return` (${s=t,s>=1e6?`${(s/1e6).toFixed(2)}M`:s>=1e3?`${(s/1e3).toFixed(2)}K`:s.toFixed(2)} m³)`;var s})()]}),g.jsxs("div",{className:"copy-buttons",children:[g.jsx("button",{className:"copy-button",onClick:()=>ae(e.materials,!1),title:"复制(中文)",children:"复制(中文)"}),g.jsx("button",{className:"copy-button",onClick:()=>ae(e.materials,!0),title:"复制(英文)",children:"复制(英文)"}),g.jsx("button",{className:"copy-button",onClick:()=>W(e.level),title:"查看材料占比",children:"查看材料占比"})]})]}),g.jsxs("div",{className:"copy-buttons",children:[t&&g.jsxs("div",{className:"level-total-price",children:["材料总价: ",C(t.totalPrice),t.facilityCost&&g.jsxs("div",{className:"level-facility-cost",children:["加工税费: ",C(t.facilityCost),g.jsxs("span",{className:"facility-cost-rate",children:["(税率: ",(100*t.totalTaxRate).toFixed(2),"%)"]})]}),"number"==typeof t.leftoverCumulativePrice&&g.jsxs("div",{className:"level-leftover-total",children:["总计结余材料: ",C(t.leftoverCumulativePrice),g.jsx("span",{className:"leftover-total-hint",children:"(抵减成本)"})]}),t.cumulativeFacilityCost&&t.cumulativeFacilityCost>0&&g.jsxs("div",{className:"level-cumulative-cost",children:["总计税费: ",C(t.cumulativeFacilityCost),g.jsx("span",{className:"cumulative-cost-hint",children:"(加工到产品的总税费)"})]}),"number"==typeof t.totalCost&&g.jsxs("div",{className:"level-total-cost-with-tax",children:["总成本: ",C(t.totalCost),g.jsx("span",{className:"total-cost-hint",children:"(材料总价-总计结余材料+总计税费)"})]})]}),w&&!t&&g.jsx("div",{className:"level-price-loading",children:"计算价格中..."})]})]}),g.jsxs("div",{className:"materials-list",ref:t=>{t&&x.current.set(e.level,t)},children:[e.materials.map(t=>ie(t,e.level)),e.leftoverProducts&&e.leftoverProducts.length>0&&g.jsxs(g.Fragment,{children:[g.jsx("div",{className:"leftover-separator",children:g.jsx("span",{className:"leftover-separator-text",children:"结余部分"})}),e.leftoverProducts.map(t=>{const s=b.getEveData(),a=null==s?void 0:s.type_info[t.typeID.toString()],r=(null==a?void 0:a.icon_name)?`./static/icons/${a.icon_name}`:`./static/icons/icon_${t.typeID}_64.png`,i=t.typeName||(null==a?void 0:a.zh_name)||`未知物品_${t.typeID}`;return g.jsxs("div",{className:"material-item leftover",style:{cursor:"default"},children:[g.jsx("div",{className:"material-icon",children:g.jsx(_,{src:r,alt:i,size:24,showLoadingIndicator:!0})}),g.jsx("div",{className:"material-info",children:g.jsxs("div",{className:"material-name",children:[i," × ",t.quantity.toLocaleString()]})}),g.jsx("div",{className:"material-volume",children:"-"}),g.jsx("div",{className:"material-blueprint-status",children:g.jsx("span",{className:"leftover-badge",children:"结余"})})]},`leftover-${e.level}-${t.typeID}`)})]})]})]},e.level)})})]}),null!=K&&(()=>{const{total:e,slices:t}=((e,t)=>{const s=["#4caf50","#2196f3","#ff9800","#e91e63","#9c27b0","#00bcd4","#8bc34a","#ffc107","#03a9f4","#ff5722","#795548","#607d8b","#cddc39","#673ab7","#009688"];if("price"===t){const t=N.find(t=>t.level===e);if(!t)return{total:0,slices:[]};const a=t.materials.map(e=>e.typeID),r=b.getMarketGroupNamesByTypeIds(a),i=new Map;for(const e of t.materials){const t=r.get(e.typeID)||"未分类",s=i.get(t)||0;i.set(t,s+e.price)}const n=Array.from(i.entries()).sort((e,t)=>t[1]-e[1]).map(([e,t],a)=>({label:e,value:t,color:s[a%s.length]}));return{total:n.reduce((e,t)=>e+t.value,0),slices:n}}{const t=null==ne?void 0:ne.materialLevels.find(t=>t.level===e);if(!t)return{total:0,slices:[]};const a=t.materials.map(e=>e.typeID),r=b.getMarketGroupNamesByTypeIds(a),i=new Map;for(const e of t.materials){const t=r.get(e.typeID)||"未分类",s=i.get(t)||0,a=(null!=e.totalVolume?e.totalVolume:(e.volume||0)*(e.quantity||0))||0;i.set(t,s+a)}const n=Array.from(i.entries()).sort((e,t)=>t[1]-e[1]).map(([e,t],a)=>({label:e,value:t,color:s[a%s.length]}));return{total:n.reduce((e,t)=>e+t.value,0),slices:n}}})(K,H),s=t.filter(e=>0===Z.size||Z.has(e.label)).reduce((e,t)=>e+t.value,0);return g.jsx("div",{className:"existing-modal-overlay",onClick:()=>W(null),children:g.jsxs("div",{className:"existing-modal",onClick:e=>e.stopPropagation(),children:[g.jsx("div",{className:"existing-modal-header",children:g.jsxs("div",{className:"existing-modal-title",children:["第",K,"层 材料","price"===H?"成本":"体积","占比"]})}),g.jsx("div",{className:"existing-modal-body",children:g.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"},children:[g.jsx(re,{width:240,height:240,data:t}),g.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[t.map((t,s)=>g.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,fontSize:12,cursor:"pointer",opacity:0===Z.size||Z.has(t.label)?1:.5},onClick:()=>{const e=new Set(Z);e.has(t.label)?e.delete(t.label):e.add(t.label),ee(e)},title:Z.has(t.label)?"点击取消选择":"点击选择",children:[g.jsx("span",{style:{display:"inline-block",width:10,height:10,background:t.color,borderRadius:2}}),g.jsx("span",{children:t.label}),g.jsxs("span",{style:{color:"#888"},children:["- ","price"===H?C(t.value):`${t.value.toFixed(2)} m³`]}),g.jsxs("span",{style:{color:"#888"},children:["(",(t.value/(e||1)*100).toFixed(2),"%)"]}),Z.has(t.label)&&g.jsx("span",{style:{color:"#52c41a"},children:"[选中]"})]},s)),g.jsxs("div",{style:{marginTop:6,fontSize:12,color:"#bbb",display:"flex",alignItems:"center",gap:8},children:[g.jsx("button",{className:"existing-btn",onClick:()=>ee(new Set),title:"清空选择",children:"清空选择"}),g.jsxs("span",{children:["已选合计: ","price"===H?C(s):`${s.toFixed(2)} m³`," (",(s/(e||1)*100).toFixed(2),"%)"]})]})]})]})}),g.jsxs("div",{className:"existing-modal-footer",children:[g.jsxs("button",{className:"existing-btn",onClick:()=>Y("price"===H?"volume":"price"),children:["切换为","price"===H?"体积占比":"成本占比"]}),g.jsx("button",{className:"existing-btn",onClick:()=>W(null),children:"关闭"})]})]})})})()]}):g.jsx("div",{className:"blueprint-view",children:g.jsxs("div",{className:"no-blueprint",children:[g.jsx("div",{className:"no-blueprint-icon",children:"⚠️"}),g.jsx("div",{className:"no-blueprint-text",children:"此物品没有制造蓝图"})]})}):g.jsx("div",{className:"blueprint-view",children:g.jsxs("div",{className:"no-selection",children:[g.jsx("div",{className:"no-selection-icon",children:"📋"}),g.jsx("div",{className:"no-selection-text",children:"请从左侧选择一个物品"})]})})},Z=({isOpen:e,onClose:t,onAuthSuccess:a,currentToken:r,currentCharacter:i})=>{const[n,c]=s.useState(!1),[l,o]=s.useState(null);s.useEffect(()=>{},[e]);return e?g.jsx("div",{className:"auth-overlay",children:g.jsxs("div",{className:"auth-modal",children:[g.jsxs("div",{className:"auth-header",children:[g.jsx("h2",{children:"EVE Online 认证"}),g.jsx("button",{className:"auth-close",onClick:t,children:"✕"})]}),g.jsxs("div",{className:"auth-content",children:[l&&g.jsxs("div",{className:"auth-error",children:[g.jsx("div",{className:"error-icon",children:"⚠️"}),g.jsx("div",{className:"error-text",children:l})]}),r&&i?g.jsxs("div",{className:"auth-success",children:[g.jsxs("div",{className:"character-info",children:[g.jsx("div",{className:"character-avatar",children:g.jsx("img",{src:`https://images.evetech.net/characters/${i.CharacterID}/portrait?size=64`,alt:"角色头像"})}),g.jsxs("div",{className:"character-details",children:[g.jsx("h3",{children:i.CharacterName}),g.jsx("p",{className:"character-status",children:"已认证"}),g.jsxs("p",{className:"character-id",children:["角色ID: ",i.CharacterID]})]})]}),g.jsx("div",{className:"auth-actions",children:g.jsx("button",{className:"auth-button-logout",onClick:()=>{a("","",null),t()},children:"退出登录"})})]}):g.jsxs("div",{className:"auth-login",children:[g.jsxs("div",{className:"auth-description",children:[g.jsx("p",{children:"通过EVE Online SSO进行认证，获取以下权限："}),g.jsxs("ul",{children:[g.jsx("li",{children:"搜索建筑信息"}),g.jsx("li",{children:"访问建筑市场数据"})]})]}),g.jsx("div",{className:"auth-actions",children:n?g.jsxs("div",{className:"auth-loading",children:[g.jsx("div",{className:"loading-spinner"}),g.jsx("span",{children:"正在处理..."})]}):g.jsx("button",{className:"auth-button-login",onClick:async()=>{c(!0),o(null);try{const{authUrl:e}=await $();window.location.href=e}catch(e){o(e instanceof Error?e.message:"启动认证失败"),c(!1)}},children:g.jsx("img",{src:"./eve_auth.png",alt:"EVE"})})})]})]})]})}):null};const ee=new class{constructor(){t(this,"cacheKey","eve_structure_info_cache"),t(this,"cacheExpiryMinutes",30)}getCachedStructureInfo(e){try{const t=this.loadCache(),s=t[e.toString()];return s?Date.now()>s.expiresAt?(delete t[e.toString()],this.saveCache(t),null):s:null}catch(t){return null}}getCachedStructureName(e){const t=this.getCachedStructureInfo(e);return t?t.name:null}cacheStructureInfo(e,t,s){try{const a=this.loadCache(),r=Date.now(),i=r+60*this.cacheExpiryMinutes*1e3;a[e.toString()]={structure_id:e,name:t,type_id:s,timestamp:r,expiresAt:i},this.saveCache(a)}catch(a){}}cacheStructureName(e,t){this.cacheStructureInfo(e,t,0)}cacheStructureInfos(e){try{const t=this.loadCache(),s=Date.now(),a=s+60*this.cacheExpiryMinutes*1e3;e.forEach(e=>{t[e.structure_id.toString()]={structure_id:e.structure_id,name:e.name,type_id:e.type_id,timestamp:s,expiresAt:a}}),this.saveCache(t)}catch(t){}}cacheStructureNames(e){const t=e.map(e=>({structure_id:e.structure_id,name:e.name,type_id:0}));this.cacheStructureInfos(t)}cleanExpiredCache(){try{const e=this.loadCache(),t=Date.now();let s=0;Object.keys(e).forEach(a=>{e[a].expiresAt<=t&&(delete e[a],s++)}),s>0&&this.saveCache(e)}catch(e){}}getCacheStats(){try{const e=this.loadCache(),t=Date.now();let s=0,a=0,r=0;return Object.values(e).forEach(e=>{s++,e.expiresAt<=t?a++:r++}),{total:s,expired:a,valid:r}}catch(e){return{total:0,expired:0,valid:0}}}clearAllCache(){try{localStorage.removeItem(this.cacheKey)}catch(e){}}loadCache(){try{const e=localStorage.getItem(this.cacheKey);return e?JSON.parse(e):{}}catch(e){return{}}}saveCache(e){try{localStorage.setItem(this.cacheKey,JSON.stringify(e))}catch(t){}}};const te=new class{constructor(){t(this,"baseUrl","https://esi.evetech.net/latest")}async searchStructures(e,t,s){if(!e||!t||!s)throw new Error("缺少必要参数：角色ID、搜索关键词或访问令牌");try{const a=`${this.baseUrl}/characters/${e}/search/?categories=structure&search=${encodeURIComponent(t)}`,r=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${s}`,"User-Agent":"EVE Blueprint Calculator"}});if(!r.ok){if(401===r.status)throw new Error("认证失败，请重新登录");if(403===r.status)throw new Error("没有权限访问建筑搜索");if(404===r.status)return[];throw new Error(`搜索失败: ${r.status} ${r.statusText}`)}return(await r.json()).structure||[]}catch(a){if(a instanceof Error)throw a;throw new Error(`搜索建筑时发生错误: ${a}`)}}async getStructureInfo(e,t){if(!e||!t)throw new Error("缺少必要参数：建筑ID或访问令牌");try{const a=`${this.baseUrl}/universe/structures/${e}/`,r=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${t}`,"User-Agent":"EVE Blueprint Calculator"}});if(!r.ok){if(404===r.status)return null;throw new Error(`获取建筑信息失败: ${r.status} ${r.statusText}`)}const i=await r.json();let n;try{const{dataService:e}=await j(async()=>{const{dataService:e}=await Promise.resolve().then(()=>E);return{dataService:e}},void 0,import.meta.url),t=e.getEveData(),s=null==t?void 0:t.type_info[i.type_id.toString()];n=(null==s?void 0:s.icon_name)||void 0}catch(s){}return{structure_id:e,name:i.name,type_id:i.type_id,solar_system_id:i.solar_system_id,icon_name:n}}catch(s){if(s instanceof Error)throw s;throw new Error(`获取建筑信息时发生错误: ${s}`)}}async getStructuresInfo(e,t){const s=[],a=[];for(const i of e){const e=ee.getCachedStructureInfo(i);if(e){let t;try{const{dataService:s}=await j(async()=>{const{dataService:e}=await Promise.resolve().then(()=>E);return{dataService:e}},void 0,import.meta.url),a=s.getEveData(),r=null==a?void 0:a.type_info[e.type_id.toString()];t=(null==r?void 0:r.icon_name)||void 0}catch(r){}s.push({structure_id:i,name:e.name,type_id:e.type_id,solar_system_id:0,icon_name:t})}else a.push(i)}if(a.length>0){const e=5;for(let i=0;i<a.length;i+=e){const n=a.slice(i,i+e).map(e=>this.getStructureInfo(e,t));try{const e=await Promise.allSettled(n),t=[];e.forEach(e=>{"fulfilled"===e.status&&e.value&&(s.push(e.value),t.push(e.value))}),t.length>0&&ee.cacheStructureInfos(t)}catch(r){}i+e<a.length&&await new Promise(e=>setTimeout(e,100))}}return s}getCachedStructureName(e){return ee.getCachedStructureName(e)}getCachedStructureInfo(e){return ee.getCachedStructureInfo(e)}};function se(){const[e,t]=s.useState([]),[a,r]=s.useState(!0),[i,n]=s.useState(null),[c,l]=s.useState(null),[o,u]=s.useState(300),[d,h]=s.useState(!1),[m,p]=s.useState(!1),[y,f]=s.useState(!1),[v,x]=s.useState(null),[S,N]=s.useState(null),[_,I]=s.useState(null),[k,E]=s.useState(()=>{const e=localStorage.getItem("eve-blueprint-settings");if(e)try{const t=JSON.parse(e);return{materialEfficiency:t.materialEfficiency??0,timeEfficiency:t.timeEfficiency??0,complexStructure:t.complexStructure??"none",complexRig:t.complexRig??"none",complexSolarSystem:t.complexSolarSystem??null,complexTax:t.complexTax??0,refineStructure:t.refineStructure??"none",reactionRig:t.reactionRig??"none",refineSolarSystem:t.refineSolarSystem??null,reactionTax:t.reactionTax??0,marketType:t.marketType??"region",marketSelection:t.marketSelection??"10000002",structureMarketId:t.structureMarketId??null,runs:t.runs??1,considerOrderVolume:t.considerOrderVolume??!0}}catch(t){}return{materialEfficiency:0,timeEfficiency:0,complexStructure:"none",complexRig:"none",complexSolarSystem:null,complexTax:0,refineStructure:"none",reactionRig:"none",refineSolarSystem:null,reactionTax:0,marketType:"region",marketSelection:"10000002",structureMarketId:null,runs:1,considerOrderVolume:!0}}),[C,T]=s.useState(""),[D,M]=s.useState(""),[$,B]=s.useState([]),[O,q]=s.useState([]),[F,V]=s.useState(k),[U,Q]=s.useState(""),[H,G]=s.useState([]),[X,se]=s.useState(!1),[ae,re]=s.useState(null),[ie,ne]=s.useState(!1),[ce,le]=s.useState(null),[oe,ue]=s.useState(null);s.useEffect(()=>{de(),ee.cleanExpiredCache()},[]),s.useEffect(()=>{z.init();const e=z.subscribe(e=>{x(e.accessToken),N(e.refreshToken),I(e.character),ne(e.isRefreshing),le(e.remainingMinutes)});return()=>{e(),z.destroy()}},[]),s.useEffect(()=>{m&&V(k)},[m,k]),s.useEffect(()=>{(async()=>{if("structure"===k.marketType&&k.structureMarketId){const t=ee.getCachedStructureInfo(k.structureMarketId);if(t)return void ue(t.name);if(v)try{const e=await te.getStructureInfo(k.structureMarketId,v);e?(ue(e.name),ee.cacheStructureInfo(k.structureMarketId,e.name,e.type_id)):ue(`建筑 ${k.structureMarketId}`)}catch(e){ue(`建筑 ${k.structureMarketId}`)}else ue(`建筑 ${k.structureMarketId}`)}else ue(null)})()},[k.marketType,k.structureMarketId,v]);const de=async()=>{try{r(!0),n(null),await Promise.all([b.loadEveData(),J.loadConfig(),K.loadData(),W.loadSystemsData(),j(async()=>{const{initializeEveOAuth:e}=await Promise.resolve().then(()=>L);return{initializeEveOAuth:e}},void 0,import.meta.url).then(({initializeEveOAuth:e})=>e())]);const e=b.buildTree();t(e)}catch(e){n(e instanceof Error?e.message:"加载数据失败")}finally{r(!1)}},he=e=>{if(d){const t=e.clientX;t>200&&t<600&&u(t)}},me=()=>{h(!1)},pe=()=>{V(k),p(!1)},ye=(e,t,s)=>{z.setTokens(e,t),z.setCharacter(s),f(!1)},fe=async()=>{if(U.trim())if(v&&(null==_?void 0:_.CharacterID)){se(!0),re(null),G([]);try{const e=await te.searchStructures(_.CharacterID,U,v);if(0===e.length)return void re("未找到匹配的建筑");const t=await te.getStructuresInfo(e,v);G(t),0===t.length&&re("获取建筑信息失败")}catch(e){re(e instanceof Error?e.message:"搜索失败")}finally{se(!1)}}else re("请先登录EVE账号");else re("请输入搜索关键词")},ge=async()=>{if(v&&S&&!ie)try{ne(!0);const t=await A(v,S,()=>{});if(t.needsRefresh){x(t.accessToken),N(t.refreshToken),localStorage.setItem("eve_auth_token",t.accessToken),localStorage.setItem("eve_auth_refresh_token",t.refreshToken);try{const{getCharacterInfo:e}=await j(async()=>{const{getCharacterInfo:e}=await Promise.resolve().then(()=>L);return{getCharacterInfo:e}},void 0,import.meta.url),s=await e(t.accessToken);I(s),localStorage.setItem("eve_auth_character",JSON.stringify(s))}catch(e){}}}catch(e){}finally{ne(!1)}},ve=()=>{if(v){const e=P(v);le(e)}else le(null)};return s.useEffect(()=>{let e=null,t=null,s=null;if("/auth/callback"===window.location.pathname){const a=new URLSearchParams(window.location.search);e=a.get("code"),t=a.get("state"),s=a.get("error")}else if(window.location.hash.includes("#/auth/callback")){const a=new URLSearchParams(window.location.hash.split("?")[1]);e=a.get("code"),t=a.get("state"),s=a.get("error")}if(e||t||s||"/auth/callback"===window.location.pathname||"/EVE_BP_Calc/auth/callback"===window.location.pathname||window.location.hash.includes("#/auth/callback")){if(s){const e=window.location.pathname.includes("/EVE_BP_Calc")?"/EVE_BP_Calc/":"/";return void window.history.replaceState({},document.title,e)}if(e&&t)j(async()=>{const{handleOAuthCallback:e,getCharacterInfo:t}=await Promise.resolve().then(()=>L);return{handleOAuthCallback:e,getCharacterInfo:t}},void 0,import.meta.url).then(({handleOAuthCallback:s,getCharacterInfo:a})=>{s(e,t).then(e=>a(e.access_token).then(t=>{ye(e.access_token,e.refresh_token,t);const s=window.location.pathname.includes("/EVE_BP_Calc")?"/EVE_BP_Calc/":"/";window.history.replaceState({},document.title,s)})).catch(e=>{const t=window.location.pathname.includes("/EVE_BP_Calc")?"/EVE_BP_Calc/":"/";window.history.replaceState({},document.title,t)})});else{const e=window.location.pathname.includes("/EVE_BP_Calc")?"/EVE_BP_Calc/":"/";window.history.replaceState({},document.title,e)}}},[]),s.useEffect(()=>{if(!v||!S)return;ve(),R(v,2)&&ge();const e=setInterval(()=>{ve(),v&&R(v,2)&&!ie&&ge()},6e4);return()=>{clearInterval(e)}},[v,S]),s.useEffect(()=>{ve()},[v]),s.useEffect(()=>{if(d)return document.addEventListener("mousemove",he),document.addEventListener("mouseup",me),()=>{document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",me)}},[d]),a?g.jsx("div",{className:"app",children:g.jsxs("div",{className:"loading",children:[g.jsx("div",{className:"loading-spinner"}),g.jsx("div",{className:"loading-text",children:"加载中..."})]})}):i?g.jsx("div",{className:"app",children:g.jsxs("div",{className:"error",children:[g.jsx("div",{className:"error-icon",children:"⚠️"}),g.jsx("div",{className:"error-text",children:i}),g.jsx("button",{className:"error-retry",onClick:de,children:"重试"})]})}):g.jsxs("div",{className:"app",children:[g.jsxs("div",{className:"app-header",children:[g.jsx("h1",{children:"EVE蓝图计算器"}),g.jsxs("div",{className:"header-actions",children:[v&&_?g.jsx("div",{className:"user-menu",children:g.jsxs("div",{className:"user-info",children:[null!==ce&&g.jsx("div",{className:"token-status",children:ie?g.jsx("span",{className:"token-refreshing",children:"[!] 刷新中..."}):ce<=2?g.jsxs("span",{className:"token-expiring",children:["[!] ",ce,"分钟"]}):g.jsxs("span",{className:"token-valid",children:[ce,"分钟"]})}),g.jsx("button",{className:"user-avatar-button",onClick:()=>f(!0),title:`${_.CharacterName} - 点击查看账户信息`,children:g.jsx("img",{src:`https://images.evetech.net/characters/${_.CharacterID}/portrait?size=32`,alt:_.CharacterName,className:"user-avatar"})})]})}):g.jsx("button",{className:"auth-button",onClick:()=>f(!0),title:"EVE认证",children:g.jsx("img",{src:"./eve_auth.png",alt:"EVE认证"})}),g.jsx("button",{className:"settings-button",onClick:()=>p(!0),title:"设置",children:"⚙️"})]})]}),g.jsxs("div",{className:"app-content",children:[g.jsxs("div",{className:"sidebar",style:{width:`${o}px`},children:[g.jsx("div",{className:"sidebar-header",children:g.jsx("h2",{children:"物品目录"})}),g.jsx("div",{className:"sidebar-content",children:g.jsx(w,{nodes:e,onNodeSelect:e=>{l(e)}})})]}),g.jsx("div",{className:"resize-handle "+(d?"resizing":""),onMouseDown:e=>{h(!0),e.preventDefault()}}),g.jsxs("div",{className:"main-content",children:[g.jsxs("div",{className:"content-header",children:[g.jsx("div",{className:"content-header-main",children:g.jsx("h2",{children:"详细信息"})}),k&&g.jsx("div",{className:"content-header-settings",children:g.jsxs("div",{className:"settings-summary",children:[g.jsxs("div",{className:"settings-row",children:[g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"材料效率:"}),g.jsx("span",{className:"settings-value",children:k.materialEfficiency})]}),g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"时间效率:"}),g.jsx("span",{className:"settings-value",children:k.timeEfficiency})]}),g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"市场:"}),g.jsx("span",{className:"settings-value",children:(()=>{if("structure"===k.marketType&&oe)return oe;if("structure"===k.marketType&&k.structureMarketId)return`建筑 ${k.structureMarketId}`;return{10000002:"Jita",10000043:"Amarr",10000032:"Dodixie",10000042:"Hek",10000030:"Rens"}[k.marketSelection]||k.marketSelection})()})]})]}),g.jsxs("div",{className:"settings-row",children:[g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"加工建筑:"}),g.jsxs("span",{className:"settings-value",children:["none"!==k.complexStructure?k.complexStructure:"无","none"!==k.complexRig&&` + ${k.complexRig.toUpperCase()}`]})]}),g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"制造加成:"}),g.jsx("span",{className:"settings-value",children:(()=>{const e=J.getConfig();if(!e)return"无数据";let t=1,s=1,a=1,r=1,i=1,n=1,c=1;if("none"!==k.complexStructure){const a=e.structure.complex.find(e=>e.name===k.complexStructure);a&&(t=a.ME,s=a.Cost)}if("none"!==k.complexRig){const t=e["complex-rigs"][k.complexRig];t&&(a=t.ME,r=t.Cost,i=t.hs,n=t.ls,c=t.ns)}let l=1;if(k.complexSolarSystem&&"none"!==k.complexRig){const e=K.getSolarSystemById(k.complexSolarSystem);if(e){const t=e.display_security;l=t>=.5?1-i*(1-a):t>=0?1-n*(1-a):1-c*(1-a)}}const o=s*r,u=e=>{const t=Math.round(1e5*e)/1e5;return t%1==0?t.toString():t.toFixed(5).replace(/\.?0+$/,"")};return`材料 -${u(100*(1-t*("none"!==k.complexRig?l:1)))}%, 成本 -${u(100*(1-o))}%`})()})]}),k.complexSolarSystem&&g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"加工星系:"}),g.jsx("span",{className:"settings-value",children:(()=>{const e=K.getDisplayNameWithSecurity(k.complexSolarSystem);return e?g.jsxs(g.Fragment,{children:[g.jsx("span",{className:"security-badge-small",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]}):"未知星系"})()})]}),k.complexSolarSystem&&g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"制造系数:"}),g.jsx("span",{className:"settings-value",children:(()=>{const e=W.getManufacturingCostIndex(k.complexSolarSystem);return null===e?"未知":W.formatCostIndex(e)})()})]}),k.complexTax>0&&g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"加工税率:"}),g.jsxs("span",{className:"settings-value",children:[k.complexTax,"%"]})]})]}),g.jsxs("div",{className:"settings-row",children:[g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"反应建筑:"}),g.jsxs("span",{className:"settings-value",children:["none"!==k.refineStructure?k.refineStructure:"无","none"!==k.reactionRig&&` + ${k.reactionRig.toUpperCase()}`]})]}),g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"反应加成:"}),g.jsx("span",{className:"settings-value",children:(()=>{const e=J.getConfig();if(!e)return"无数据";let t=1,s=1,a=1,r=1,i=1,n=1,c=1;if("none"!==k.refineStructure){const a=e.structure.refine.find(e=>e.name===k.refineStructure);a&&(t=a.ME,s=a.Cost)}if("none"!==k.reactionRig){const t=e["reaction-rigs"][k.reactionRig];t&&(a=t.ME,r=t.Cost,i=t.hs,n=t.ls,c=t.ns)}let l=1;if(k.refineSolarSystem&&"none"!==k.reactionRig){const e=K.getSolarSystemById(k.refineSolarSystem);if(e){const t=e.display_security;l=t>=.5?1-i*(1-a):t>=0?1-n*(1-a):1-c*(1-a)}}const o=s*r,u=e=>{const t=Math.round(1e5*e)/1e5;return t%1==0?t.toString():t.toFixed(5).replace(/\.?0+$/,"")};return`材料 -${u(100*(1-t*("none"!==k.reactionRig?l:1)))}%, 成本 -${u(100*(1-o))}%`})()})]}),k.refineSolarSystem&&g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"反应星系:"}),g.jsx("span",{className:"settings-value",children:(()=>{const e=K.getDisplayNameWithSecurity(k.refineSolarSystem);return e?g.jsxs(g.Fragment,{children:[g.jsx("span",{className:"security-badge-small",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]}):"未知星系"})()})]}),k.refineSolarSystem&&g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"反应系数:"}),g.jsx("span",{className:"settings-value",children:(()=>{const e=W.getReactionCostIndex(k.refineSolarSystem);return null===e?"未知":W.formatCostIndex(e)})()})]}),k.reactionTax>0&&g.jsxs("div",{className:"settings-item",children:[g.jsx("span",{className:"settings-label",children:"反应税率:"}),g.jsxs("span",{className:"settings-value",children:[k.reactionTax,"%"]})]})]})]})})]}),g.jsx("div",{className:"content-body",children:g.jsx(Y,{selectedNode:c,settings:k,authToken:v})})]})]}),m&&g.jsx("div",{className:"settings-overlay",children:g.jsxs("div",{className:"settings-modal",children:[g.jsxs("div",{className:"settings-header",children:[g.jsx("h2",{children:"设置"}),g.jsx("button",{className:"settings-close",onClick:pe,children:"✕"})]}),g.jsxs("div",{className:"settings-layout",children:[g.jsxs("div",{className:"settings-content",children:[g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"默认蓝图材料效率:"}),g.jsx("select",{value:F.materialEfficiency,onChange:e=>V({...F,materialEfficiency:parseInt(e.target.value)}),children:Array.from({length:11},(e,t)=>t).map(e=>g.jsx("option",{value:e,children:e},e))})]}),g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"默认蓝图时间效率:"}),g.jsx("select",{value:F.timeEfficiency,onChange:e=>V({...F,timeEfficiency:parseInt(e.target.value)}),children:Array.from({length:11},(e,t)=>2*t).map(e=>g.jsx("option",{value:e,children:e},e))})]}),g.jsxs("div",{className:"setting-group",children:[g.jsx("h3",{children:"默认加工建筑"}),g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"建筑名称:"}),g.jsx("select",{value:F.complexStructure,onChange:e=>V({...F,complexStructure:e.target.value}),children:J.getComplexStructures().map(e=>g.jsx("option",{value:e.value,children:e.name},e.value))})]}),g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"插件:"}),g.jsx("select",{value:F.complexRig,onChange:e=>V({...F,complexRig:e.target.value}),children:J.getComplexRigs().map(e=>g.jsx("option",{value:e.value,children:e.name},e.value))})]}),g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"星系:"}),g.jsxs("div",{className:"solar-system-input",children:[g.jsx("input",{type:"text",placeholder:"输入至少2个字符搜索星系",value:C,onChange:e=>(e=>{if(T(e),e.length>=2){const t=K.searchSolarSystems(e);B(t)}else B([])})(e.target.value)}),$.length>0&&g.jsx("div",{className:"solar-system-results",children:$.map(e=>g.jsxs("div",{className:"solar-system-result-item",onClick:()=>{return t=e.id,V({...F,complexSolarSystem:t}),T(""),void B([]);var t},children:[g.jsx("span",{className:"security-badge",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]},e.id))}),F.complexSolarSystem&&g.jsxs("div",{className:"selected-solar-system",children:["已选择: ",(()=>{const e=K.getDisplayNameWithSecurity(F.complexSolarSystem);return e?g.jsxs(g.Fragment,{children:[g.jsx("span",{className:"security-badge",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]}):"未知星系"})()]})]})]}),g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"设施税:"}),g.jsx("input",{type:"number",min:"0",max:"100",value:F.complexTax,onChange:e=>V({...F,complexTax:Math.min(100,Math.max(0,parseInt(e.target.value)||0))}),placeholder:"0-100"})]})]}),g.jsxs("div",{className:"setting-group",children:[g.jsx("h3",{children:"默认反应建筑"}),g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"建筑名称:"}),g.jsx("select",{value:F.refineStructure,onChange:e=>V({...F,refineStructure:e.target.value}),children:J.getRefineStructures().map(e=>g.jsx("option",{value:e.value,children:e.name},e.value))})]}),g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"插件:"}),g.jsx("select",{value:F.reactionRig,onChange:e=>V({...F,reactionRig:e.target.value}),children:J.getReactionRigs().map(e=>g.jsx("option",{value:e.value,children:e.name},e.value))})]}),g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"星系:"}),g.jsxs("div",{className:"solar-system-input",children:[g.jsx("input",{type:"text",placeholder:"输入至少2个字符搜索星系",value:D,onChange:e=>(e=>{if(M(e),e.length>=2){const t=K.searchSolarSystems(e);q(t)}else q([])})(e.target.value)}),O.length>0&&g.jsx("div",{className:"solar-system-results",children:O.map(e=>g.jsxs("div",{className:"solar-system-result-item",onClick:()=>{return t=e.id,V({...F,refineSolarSystem:t}),M(""),void q([]);var t},children:[g.jsx("span",{className:"security-badge",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]},e.id))}),F.refineSolarSystem&&g.jsxs("div",{className:"selected-solar-system",children:["已选择: ",(()=>{const e=K.getDisplayNameWithSecurity(F.refineSolarSystem);return e?g.jsxs(g.Fragment,{children:[g.jsx("span",{className:"security-badge",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]}):"未知星系"})()]})]})]}),g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"设施税:"}),g.jsx("input",{type:"number",min:"0",max:"100",value:F.reactionTax,onChange:e=>V({...F,reactionTax:Math.min(100,Math.max(0,parseInt(e.target.value)||0))}),placeholder:"0-100"})]})]}),g.jsxs("div",{className:"setting-group",children:[g.jsx("h3",{children:"价格计算设置"}),g.jsxs("div",{className:"setting-item",children:[g.jsx("label",{children:"考虑订单数量:"}),g.jsx("input",{type:"checkbox",checked:F.considerOrderVolume,onChange:e=>V({...F,considerOrderVolume:e.target.checked})}),g.jsx("span",{className:"setting-description",children:F.considerOrderVolume?"开启：按实际订单分配计算价格（更准确）":"关闭：使用最低价格×需求量计算（更快速）"})]})]})]}),g.jsxs("div",{className:"settings-sidebar",children:[g.jsxs("div",{className:"sidebar-content",children:[g.jsx("h3",{children:"市场选择"}),g.jsxs("div",{className:"market-selector",children:[g.jsx("div",{className:"market-option",children:g.jsxs("label",{className:"market-radio-item",children:[g.jsx("input",{type:"radio",name:"sidebarMarketSelection",value:"10000002",checked:"region"===F.marketType&&"10000002"===F.marketSelection,onChange:e=>V({...F,marketType:"region",marketSelection:e.target.value,structureMarketId:null})}),g.jsx("div",{className:"market-option-content",children:g.jsx("div",{className:"market-name",children:"Jita"})})]})}),g.jsx("div",{className:"market-option",children:g.jsxs("label",{className:"market-radio-item",children:[g.jsx("input",{type:"radio",name:"sidebarMarketSelection",value:"10000043",checked:"region"===F.marketType&&"10000043"===F.marketSelection,onChange:e=>V({...F,marketType:"region",marketSelection:e.target.value,structureMarketId:null})}),g.jsx("div",{className:"market-option-content",children:g.jsx("div",{className:"market-name",children:"Amarr"})})]})}),g.jsx("div",{className:"market-option",children:g.jsxs("label",{className:"market-radio-item",children:[g.jsx("input",{type:"radio",name:"sidebarMarketSelection",value:"10000032",checked:"region"===F.marketType&&"10000032"===F.marketSelection,onChange:e=>V({...F,marketType:"region",marketSelection:e.target.value,structureMarketId:null})}),g.jsx("div",{className:"market-option-content",children:g.jsx("div",{className:"market-name",children:"Dodixie"})})]})}),g.jsx("div",{className:"market-option",children:g.jsxs("label",{className:"market-radio-item",children:[g.jsx("input",{type:"radio",name:"sidebarMarketSelection",value:"10000042",checked:"region"===F.marketType&&"10000042"===F.marketSelection,onChange:e=>V({...F,marketType:"region",marketSelection:e.target.value,structureMarketId:null})}),g.jsx("div",{className:"market-option-content",children:g.jsx("div",{className:"market-name",children:"Hek"})})]})}),g.jsx("div",{className:"market-option",children:g.jsxs("label",{className:"market-radio-item",children:[g.jsx("input",{type:"radio",name:"sidebarMarketSelection",value:"10000030",checked:"region"===F.marketType&&"10000030"===F.marketSelection,onChange:e=>V({...F,marketType:"region",marketSelection:e.target.value,structureMarketId:null})}),g.jsx("div",{className:"market-option-content",children:g.jsx("div",{className:"market-name",children:"Rens"})})]})})]})]}),g.jsxs("div",{className:"sidebar-content",style:{marginTop:"20px"},children:[g.jsx("h3",{children:"市场建筑搜索"}),g.jsxs("div",{className:"structure-search-section",children:[g.jsxs("div",{className:"structure-search-form",children:[g.jsxs("div",{className:"search-input-wrapper",children:[g.jsx("input",{type:"text",className:"structure-search-input",placeholder:"输入建筑名称关键词...",value:U,onChange:e=>Q(e.target.value),onKeyPress:e=>{"Enter"===e.key&&fe()}}),g.jsx("button",{className:"structure-search-button",onClick:fe,disabled:X||!v,children:X?"搜索中...":"搜索"})]}),U&&g.jsx("button",{className:"structure-clear-button",onClick:()=>{Q(""),G([]),re(null)},children:"清空"})]}),!v&&g.jsx("div",{className:"structure-search-notice",children:g.jsx("p",{children:"请先登录EVE账号以搜索市场建筑"})}),ae&&g.jsx("div",{className:"structure-search-error",children:g.jsxs("p",{children:["[x] ",ae]})}),H.length>0&&g.jsxs("div",{className:"structure-search-results",children:[g.jsxs("div",{className:"structure-results-header",children:[g.jsxs("h4",{children:["搜索结果 (",H.length,")"]}),g.jsx("button",{className:"structure-cache-clear-button",onClick:()=>{ee.clearAllCache()},title:"清除建筑信息缓存",children:"清除缓存"})]}),g.jsx("div",{className:"structure-list",children:H.map(e=>g.jsx("div",{className:"structure-item "+("structure"===F.marketType&&F.structureMarketId===e.structure_id?"selected":""),onClick:()=>{return t=e.structure_id,void V({...F,marketType:"structure",structureMarketId:t});var t},children:g.jsxs("div",{className:"structure-item-content",children:[g.jsxs("div",{className:"structure-icon",children:[e.icon_name?g.jsx("img",{src:`./static/icons/${e.icon_name}`,alt:"建筑图标",className:"structure-icon-img",onError:e=>{var t;const s=e.target;s.style.display="none",null==(t=s.nextElementSibling)||t.classList.remove("hidden")}}):null,g.jsx("div",{className:"structure-default-icon "+(e.icon_name?"hidden":""),children:"🏢"})]}),g.jsx("div",{className:"structure-info",children:g.jsx("div",{className:"structure-name",children:e.name})}),"structure"===F.marketType&&F.structureMarketId===e.structure_id&&g.jsx("div",{className:"structure-selected-indicator",children:"✓"})]})},e.structure_id))})]})]})]})]})]}),g.jsxs("div",{className:"settings-actions",children:[g.jsx("button",{className:"settings-button-cancel",onClick:pe,children:"取消"}),g.jsx("button",{className:"settings-button-confirm",onClick:()=>{(e=>{E(e);try{localStorage.setItem("eve-blueprint-settings",JSON.stringify(e))}catch(t){}})(F),p(!1)},children:"确定"})]})]})}),g.jsx(Z,{isOpen:y,onClose:()=>f(!1),onAuthSuccess:ye,currentToken:v,currentRefreshToken:S,currentCharacter:_})]})}v.createRoot(document.getElementById("root")).render(g.jsx(r.StrictMode,{children:g.jsx(se,{})}));
