var e=Object.defineProperty,t=(t,a,s)=>((t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s)(t,"symbol"!=typeof a?a+"":a,s);import{r as a,d as s,R as r}from"./vendor-DwZn5VZs.js";import{I as i,R as n,a as c,b as l,c as o,d as u,e as d}from"./antd-Bw4wSnyU.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var m={exports:{}},h={},p=a,y=Symbol.for("react.element"),f=Symbol.for("react.fragment"),g=Object.prototype.hasOwnProperty,v=p.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,x={key:!0,ref:!0,__self:!0,__source:!0};function S(e,t,a){var s,r={},i=null,n=null;for(s in void 0!==a&&(i=""+a),void 0!==t.key&&(i=""+t.key),void 0!==t.ref&&(n=t.ref),t)g.call(t,s)&&!x.hasOwnProperty(s)&&(r[s]=t[s]);if(e&&e.defaultProps)for(s in t=e.defaultProps)void 0===r[s]&&(r[s]=t[s]);return{$$typeof:y,type:e,key:i,ref:n,props:r,_owner:v.current}}h.Fragment=f,h.jsx=S,h.jsxs=S,m.exports=h;var I=m.exports,j={},N=s;j.createRoot=N.createRoot,j.hydrateRoot=N.hydrateRoot;const _={},w=function(e,t,a){let s=Promise.resolve();if(t&&t.length>0){const e=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),i=(null==r?void 0:r.nonce)||(null==r?void 0:r.getAttribute("nonce"));s=Promise.allSettled(t.map(t=>{if(t=function(e,t){return new URL(e,t).href}(t,a),t in _)return;_[t]=!0;const s=t.endsWith(".css"),r=s?'[rel="stylesheet"]':"";if(!!a)for(let a=e.length-1;a>=0;a--){const r=e[a];if(r.href===t&&(!s||"stylesheet"===r.rel))return}else if(document.querySelector(`link[href="${t}"]${r}`))return;const n=document.createElement("link");return n.rel=s?"stylesheet":"modulepreload",s||(n.as="script"),n.crossOrigin="",n.href=t,i&&n.setAttribute("nonce",i),document.head.appendChild(n),s?new Promise((e,a)=>{n.addEventListener("load",e),n.addEventListener("error",()=>a(new Error(`Unable to preload CSS for ${t}`)))}):void 0}))}function r(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return s.then(t=>{for(const e of t||[])"rejected"===e.status&&r(e.reason);return e().catch(r)})};const b=new class{constructor(){t(this,"cache",{}),t(this,"maxConcurrentLoads",5),t(this,"currentLoads",0),t(this,"maxCacheSize",500)}async loadIcon(e){var t,a;return this.checkAndCleanCache(),(null==(t=this.cache[e])?void 0:t.loaded)?(this.cache[e].lastUsed=Date.now(),this.cache[e].useCount++,this.cache[e].src):(null==(a=this.cache[e])?void 0:a.loading)?new Promise(t=>{const a=()=>{var s,r;(null==(s=this.cache[e])?void 0:s.loaded)?(this.cache[e].lastUsed=Date.now(),this.cache[e].useCount++,t(this.cache[e].src)):(null==(r=this.cache[e])?void 0:r.error)?t("./vite.svg"):setTimeout(a,50)};a()}):(this.cache[e]={src:e,loading:!0,loaded:!1,error:!1,lastUsed:Date.now(),useCount:1},this.currentLoads>=this.maxConcurrentLoads?new Promise(t=>{const a=()=>{this.currentLoads<this.maxConcurrentLoads?(this.currentLoads++,this.loadIconInternal(e).then(t)):setTimeout(a,100)};a()}):(this.currentLoads++,this.loadIconInternal(e)))}async loadIconInternal(e){var t;try{const t=new Image;return await new Promise(a=>{t.onload=()=>{var t;this.cache[e]={src:e,loading:!1,loaded:!0,error:!1,lastUsed:Date.now(),useCount:(null==(t=this.cache[e])?void 0:t.useCount)||1},this.currentLoads--,a(e)},t.onerror=()=>{var t;this.cache[e]={src:"./vite.svg",loading:!1,loaded:!0,error:!0,lastUsed:Date.now(),useCount:(null==(t=this.cache[e])?void 0:t.useCount)||1},this.currentLoads--,a("./vite.svg")},t.src=e})}catch(a){return this.cache[e]={src:"./vite.svg",loading:!1,loaded:!0,error:!0,lastUsed:Date.now(),useCount:(null==(t=this.cache[e])?void 0:t.useCount)||1},this.currentLoads--,"./vite.svg"}}preloadIcons(e){e.forEach(e=>{this.cache[e]||this.loadIcon(e).catch(()=>{})})}getIconStatus(e){const t=this.cache[e];return t?{loading:t.loading,loaded:t.loaded,error:t.error}:{loading:!1,loaded:!1,error:!1}}clearCache(){this.cache={}}checkAndCleanCache(){const e=Object.keys(this.cache).length;if(e<=this.maxCacheSize)return;const t=Object.entries(this.cache).map(([e,t])=>({path:e,item:t,score:this.calculateCacheScore(t)}));t.sort((e,t)=>e.score-t.score);const a=e-this.maxCacheSize;t.slice(0,a).forEach(({path:e})=>{delete this.cache[e]})}calculateCacheScore(e){const t=(Date.now()-e.lastUsed)/36e5;return 10*e.useCount-t}getCacheStats(){const e=Object.values(this.cache);return{total:e.length,loaded:e.filter(e=>e.loaded&&!e.error).length,loading:e.filter(e=>e.loading).length,error:e.filter(e=>e.error).length}}forceCacheCleanup(){this.checkAndCleanCache()}},k=({src:e,alt:t,className:s="",style:r={},size:i=24,fallbackSrc:n="./vite.svg",showLoadingIndicator:c=!0,lazy:l=!1})=>{const[o,u]=a.useState(""),[d,m]=a.useState(!0),[h,p]=a.useState(!1),[y,f]=a.useState(!l),g=a.useRef(null),v=a.useRef(null);a.useEffect(()=>{if(!l)return;const e=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&!y&&(f(!0),e.disconnect())})},{rootMargin:"100px",threshold:.1});return g.current&&e.observe(g.current),()=>{e.disconnect()}},[l,y]),a.useEffect(()=>{if(!y)return;let t=!0;return(async()=>{try{m(!0),p(!1);const a=await b.loadIcon(e);t&&(u(a),m(!1),p(a===n))}catch(a){t&&(u(n),m(!1),p(!0))}})(),()=>{t=!1}},[e,n,y]);const x={width:i,height:i,objectFit:"contain",borderRadius:"4px",transition:"opacity 0.2s ease",opacity:d?.3:1,...r};return l&&!y?I.jsx("div",{ref:g,className:`async-icon-placeholder ${s}`,style:{width:i,height:i,backgroundColor:"#2a2a2a",borderRadius:"4px",...r}}):d&&c?I.jsx("div",{ref:l?g:void 0,className:`async-icon-loading ${s}`,style:{width:i,height:i,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#3a3a3a",borderRadius:"4px",...r},children:I.jsx("div",{className:"icon-loading-spinner"})}):I.jsx("div",{ref:l?g:void 0,children:I.jsx("img",{ref:v,src:o,alt:t,className:`async-icon ${s} ${h?"icon-error":""}`,style:x,onError:()=>{u(n),p(!0),m(!1)}})})},{Search:E}=i,C=({nodes:e,onNodeSelect:t})=>{const[s,r]=a.useState([]),[i,n]=a.useState(""),c=e=>e.map(e=>({key:e.id,title:I.jsxs("div",{className:"tree-node-content",children:[I.jsx("div",{className:"tree-node-icon",children:I.jsx(k,{src:e.icon,alt:e.name,size:20,showLoadingIndicator:!0,lazy:!0})}),I.jsx("div",{className:"tree-node-label",children:e.name}),"item"===e.type&&I.jsx("span",{className:"item-indicator",children:"▶"})]}),children:e.children?c(e.children):void 0,node:e})),l=a.useMemo(()=>c(e),[e]),o=a.useMemo(()=>((e,t)=>{if(!t||t.length<2)return e;const a=t.toLowerCase(),s=e=>{if(e.node.name.toLowerCase().includes(a)||e.node.name_en.toLowerCase().includes(a))return e;if(e.children){const t=e.children.map(e=>s(e)).filter(Boolean);if(t.length>0)return{...e,children:t}}return null};return e.map(e=>s(e)).filter(Boolean)})(l,i),[l,i]),u=(e,t=0)=>e.map(e=>{const a=s.includes(e.key),r=e.children&&e.children.length>0;return I.jsxs("div",{className:"custom-tree-node",children:[I.jsxs("div",{className:`custom-tree-node-content ${e.node.type}`,onClick:()=>m(e),children:[I.jsxs("div",{className:"tree-switcher",children:[r&&I.jsx("span",{className:"switcher-icon "+(a?"expanded":""),children:"▶"}),!r&&"item"===e.node.type&&I.jsx("span",{className:"item-indicator",children:"▶"})]}),I.jsx("div",{className:"tree-node-icon",children:I.jsx(k,{src:e.node.icon,alt:e.node.name,size:20,showLoadingIndicator:!0,lazy:!0})}),I.jsx("div",{className:"tree-node-label",children:e.node.name})]}),r&&a&&I.jsx("div",{className:"tree-node-children",children:u(e.children,t+1)})]},e.key)}),d=e=>{const t=[];return e.children&&e.children.forEach(e=>{t.push(e.key),t.push(...d(e))}),t},m=e=>{if("group"===e.node.type&&e.children&&e.children.length>0){const t=new Set(s);if(t.has(e.key)){t.delete(e.key);d(e).forEach(e=>t.delete(e))}else t.add(e.key),(e=>{if(e.children&&e.children.length>0){const t=e.children.slice(0,10).map(e=>e.node.icon).filter(Boolean);t.length>0&&b.preloadIcons(t)}})(e);r(Array.from(t))}else null==t||t(e.node)};return I.jsxs("div",{className:"ant-tree-view",children:[I.jsxs("div",{className:"search-container",children:[I.jsx(E,{placeholder:"搜索物品名称（至少2个字符）...",allowClear:!0,value:i,onChange:e=>(e=>{n(e);const t=((e,t)=>{if(!t||t.length<2)return[];const a=[],s=e=>{e.forEach(e=>{a.push(e.key),e.children&&s(e.children)})};return s(e),a})(o,e);r(t)})(e.target.value),style:{marginBottom:8}}),i&&i.length<2&&I.jsx("div",{className:"search-hint",children:"请输入至少2个字符开始搜索"})]}),I.jsx("div",{className:"custom-tree",children:u(o)})]})};function T(e){return e?e.repackaged_volume>0?e.repackaged_volume:e.volume:0}const D=new class{constructor(){t(this,"eveData",null)}async loadEveData(){if(this.eveData)return this.eveData;try{const e=await fetch("./static/eve_blueprint_data.json"),t=await e.json();return this.eveData=t,t}catch(e){throw e}}getMarketGroupNamesByTypeIds(e){const t=new Map;if(!this.eveData)return t;const{type_info:a,market_groups:s}=this.eveData;for(const r of e){const e=a[r.toString()];if(!e){t.set(r,"未分类");continue}const i=e.marketGroupID;if(null==i){t.set(r,"未分类");continue}const n=s[i.toString()];t.set(r,(null==n?void 0:n.name)||"未分类")}return t}getEveData(){return this.eveData}getBlueprintInfo(e){if(!this.eveData)return null;const{type_info:t,blueprint_materials:a,blueprint_outputs:s,reaction:r}=this.eveData;let i;const n=t[e.toString()];if(n&&n.bp_typeid)i=n.bp_typeid;else{if(!a[e.toString()]||!s[e.toString()])return null;i=e}const c=a[i.toString()];if(!c)return null;const l=s[i.toString()];if(!l)return null;const o=r.includes(i)?"reaction":"bp",u=c.materials.map(e=>{const a=T(t[e.typeID.toString()]);return{typeId:e.typeID,quantity:e.quantity,volume:a}});return{blueprintId:i,category:o,outputQuantity:l.quantity,materials:u}}buildTree(){if(!this.eveData)throw new Error("数据未加载");const{market_tree:e,type_info:t,blueprint_outputs:a}=this.eveData,s=new Set(Object.values(a).map(e=>e.typeID)),r=new Map;Object.entries(t).forEach(([e,t])=>{null!=t.marketGroupID&&r.set(parseInt(e),t.marketGroupID)});const i=e=>{let t=!1;return r.forEach((a,r)=>{a===e.id&&s.has(r)&&(t=!0)}),!!t||e.children.some(e=>i(e))},n=e=>{if(!i(e))return null;const a={id:`group_${e.id}`,name:e.name,name_en:e.name_en,icon:`./static/icons/${e.icon_name}`,type:"group",children:[],isExpanded:!1},c=[];e.children.forEach(e=>{const t=n(e);t&&c.push(t)});const l=[];return r.forEach((a,r)=>{if(a===e.id&&s.has(r)){const e=t[r.toString()];e&&e.zh_name&&e.en_name&&e.icon_name&&l.push({id:`${r}`,name:e.zh_name,name_en:e.en_name,icon:`./static/icons/${e.icon_name}`,type:"item"})}}),a.children=[...c,...l],a},c=[];return e.forEach(e=>{const t=n(e);t&&c.push(t)}),c}},M=Object.freeze(Object.defineProperty({__proto__:null,dataService:D},Symbol.toStringTag,{value:"Module"})),$=e=>`${e.toLocaleString(void 0,{maximumFractionDigits:0})} ISK (${(e=>e>=1e9?`${(e/1e9).toFixed(1)}B`:e>=1e6?`${(e/1e6).toFixed(1)}M`:e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toFixed(1))(e)})`;const R=new class{constructor(){t(this,"baseUrl","https://esi.evetech.net/latest")}async getStructureOrders(e,t){if(!e||!t)throw new Error("缺少必要参数：建筑ID或访问令牌");try{const a=`${this.baseUrl}/markets/structures/${e}/?page=1`,s=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${t}`,"User-Agent":"EVE Blueprint Calculator"}});if(!s.ok)throw 401===s.status?new Error("认证失败，请重新登录"):403===s.status?new Error("没有权限访问此建筑的市场数据"):404===s.status?new Error("建筑不存在或无市场数据"):new Error(`获取市场数据失败: ${s.status} ${s.statusText}`);const r=parseInt(s.headers.get("X-Pages")||"1");let i=[...await s.json()];if(r>1){const a=Array.from({length:r-1},(e,t)=>t+2),s=10;for(let r=0;r<a.length;r+=s){const n=a.slice(r,r+s).map(a=>this.getPageData(e,a,t));(await Promise.allSettled(n)).forEach(e=>{"fulfilled"===e.status&&i.push(...e.value)}),r+s<a.length&&await new Promise(e=>setTimeout(e,100))}}return i}catch(a){if(a instanceof Error)throw a;throw new Error(`获取建筑市场订单时发生错误: ${a}`)}}async getPageData(e,t,a){const s=`${this.baseUrl}/markets/structures/${e}/?page=${t}`,r=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${a}`,"User-Agent":"EVE Blueprint Calculator"}});if(!r.ok)throw new Error(`获取第${t}页数据失败: ${r.status} ${r.statusText}`);return await r.json()}getItemPriceFromOrders(e,t){const a=e.filter(e=>e.type_id===t&&!e.is_buy_order&&e.volume_remain>0).map(e=>({price:e.price,volume_remain:e.volume_remain,order_id:e.order_id})).sort((e,t)=>e.price-t.price),s=a.length>0?a[0].price:null,r=a.reduce((e,t)=>e+t.volume_remain,0);return{type_id:t,sell_orders:a,lowest_sell_price:s,total_sell_volume:r}}getMultipleItemPrices(e,t){const a=new Map;return t.forEach(t=>{const s=this.getItemPriceFromOrders(e,t);a.set(t,s)}),a}async getItemPrice(e,t,a){const s=await this.getStructureOrders(e,a);return this.getItemPriceFromOrders(s,t)}async getMultipleItemPricesFromStructure(e,t,a){const s=await this.getStructureOrders(e,a);return this.getMultipleItemPrices(s,t)}};const P=new class{constructor(){t(this,"cache",new Map),t(this,"CACHE_DURATION",3e5)}getCacheKey(e,t){return`${e}_${t.substring(0,10)}`}isCacheExpired(e){return Date.now()-e.timestamp>this.CACHE_DURATION}async getStructureOrders(e,t){const a=this.getCacheKey(e,t),s=this.cache.get(a);if(s&&!this.isCacheExpired(s)&&!s.isLoading)return s.orders;if(s&&s.isLoading)return new Promise(e=>{const t=setInterval(()=>{const s=this.cache.get(a);s&&!s.isLoading&&(clearInterval(t),e(s.orders))},100)});this.cache.set(a,{structureId:e,accessToken:t,orders:[],timestamp:Date.now(),isLoading:!0});try{const s=await R.getStructureOrders(e,t);return this.cache.set(a,{structureId:e,accessToken:t,orders:s,timestamp:Date.now(),isLoading:!1}),s}catch(r){throw this.cache.delete(a),r}}getCachedItemOrders(e,t,a){const s=this.getCacheKey(e,t),r=this.cache.get(s);return!r||this.isCacheExpired(r)||r.isLoading?null:r.orders.filter(e=>e.type_id===a&&!e.is_buy_order&&e.volume_remain>0).map(e=>({duration:e.duration,is_buy_order:e.is_buy_order,issued:e.issued,location_id:e.location_id,min_volume:e.min_volume,order_id:e.order_id,price:e.price,range:e.range,system_id:0,type_id:e.type_id,volume_remain:e.volume_remain,volume_total:e.volume_total})).sort((e,t)=>e.price-t.price)}async preloadStructureOrders(e,t){t&&await this.getStructureOrders(e,t)}clearCache(e,t){const a=this.getCacheKey(e,t);this.cache.delete(a)}clearAllCache(){this.cache.clear()}getCacheStats(){let e=0,t=0;return this.cache.forEach(a=>{a.isLoading&&e++,this.isCacheExpired(a)&&t++}),{totalCaches:this.cache.size,loadingCaches:e,expiredCaches:t}}},B={clientId:"d43fa6a824234f0ab8e8a56f6d039c6c",clientSecret:"SAJGfQzounfKKfmc181GLOaKxBVQcUChRPeqcrEf",redirectUri:(()=>{const e=window.location.origin;return e.includes("localhost")||e.includes("127.0.0.1")?"http://localhost:5173/auth/callback":"https://estamelgg.github.io/EVE_BP_Calc/auth/callback"})(),authorizationEndpoint:"https://login.eveonline.com/v2/oauth/authorize/",tokenEndpoint:"https://login.eveonline.com/v2/oauth/token",jwksUri:"https://login.eveonline.com/oauth/jwks",oauthMetadataEndpoint:"https://login.eveonline.com/.well-known/oauth-authorization-server",baseURL:"https://login.eveonline.com",scopes:["esi-search.search_structures.v1","esi-markets.structure_markets.v1","esi-universe.read_structures.v1"]};async function O(){const e=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),{codeVerifier:t,codeChallenge:a}=await async function(){const e=new Uint8Array(32);crypto.getRandomValues(e);const t=btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,""),a=(new TextEncoder).encode(t),s=await crypto.subtle.digest("SHA-256",a);return{codeVerifier:t,codeChallenge:btoa(String.fromCharCode(...new Uint8Array(s))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}}(),s=new URLSearchParams({response_type:"code",redirect_uri:B.redirectUri,client_id:B.clientId,scope:B.scopes.join(" "),state:e,code_challenge:a,code_challenge_method:"S256"}),r=`${B.authorizationEndpoint}?${s.toString()}`;return localStorage.setItem("eve_oauth_state",e),localStorage.setItem("eve_oauth_code_verifier",t),{authUrl:r,state:e,codeVerifier:t}}function q(e,t=2){try{const a=A(e);if(!a.exp)return!0;const s=1e3*a.exp,r=Date.now();return r+60*t*1e3>=s}catch(a){return!0}}function L(e){try{const t=A(e);if(!t.exp)return 0;const a=1e3*t.exp,s=Date.now(),r=Math.max(0,a-s);return Math.floor(r/6e4)}catch(t){return 0}}function A(e){try{const t=e.split(".");if(3!==t.length)throw new Error("Invalid JWT format");return JSON.parse(atob(t[1]))}catch(t){throw new Error("Failed to parse JWT payload")}}async function z(e){if(!e)throw new Error("刷新令牌为空");try{const a=await fetch(B.tokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${btoa(`${B.clientId}:${B.clientSecret}`)}`},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:e})});if(!a.ok){let e="";try{e=await a.text()}catch(t){e="无法获取错误详情"}throw new Error(`刷新token失败: ${a.status} ${a.statusText}. ${e}`)}return await a.json()}catch(a){throw a}}async function V(e,t,a){if(!e||!t)throw new Error("访问令牌或刷新令牌为空");if(!q(e,2))return{accessToken:e,refreshToken:t,needsRefresh:!1};try{const e=await z(t);return a&&a(e),{accessToken:e.access_token,refreshToken:e.refresh_token||t,needsRefresh:!0}}catch(s){throw s}}const F=Object.freeze(Object.defineProperty({__proto__:null,autoRefreshToken:V,getCharacterInfo:async function(e){try{const t=await async function(e){try{const t=await async function(){const e=await fetch(B.jwksUri);if(!e.ok)throw new Error("Failed to fetch JWKS");const t=await e.json();return t}(),a=e.split(".");if(3!==a.length)throw new Error("Invalid JWT format");const s=JSON.parse(atob(a[0]));if(!t.keys.find(e=>e.kid===s.kid))throw new Error("No matching key found in JWKS");return JSON.parse(atob(a[1]))}catch(t){throw t}}(e);return{CharacterName:t.name||t.sub,CharacterID:t.sub.replace("CHARACTER:EVE:",""),ExpiresOn:new Date(1e3*t.exp).toISOString(),Scopes:t.scp||t.scope||[],Issuer:t.iss,IssuedAt:new Date(1e3*t.iat).toISOString()}}catch(t){throw t}},getTokenRemainingTime:L,handleOAuthCallback:async function(e,t){const a=localStorage.getItem("eve_oauth_state"),s=localStorage.getItem("eve_oauth_code_verifier");if(t!==a)throw new Error("OAuth state mismatch");if(!s)throw new Error("Code verifier not found");const r=await fetch(B.tokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${btoa(`${B.clientId}:${B.clientSecret}`)}`},body:new URLSearchParams({grant_type:"authorization_code",code:e,code_verifier:s,redirect_uri:B.redirectUri})});if(!r.ok){let e="";try{e=await r.text()}catch(n){e="无法获取错误详情"}throw new Error(`Failed to exchange code for token: ${r.status} ${r.statusText}. ${e}`)}const i=await r.json();return localStorage.removeItem("eve_oauth_state"),localStorage.removeItem("eve_oauth_code_verifier"),i},initializeEveOAuth:async function(){try{const e=await async function(){const e=await fetch(B.oauthMetadataEndpoint);if(!e.ok)throw new Error("Failed to fetch OAuth metadata");return await e.json()}();e.authorization_endpoint,B.authorizationEndpoint,e.token_endpoint,B.tokenEndpoint,e.jwks_uri,B.jwksUri}catch(e){throw e}},isTokenExpiringSoon:q,refreshToken:z,startEveOAuth:O},Symbol.toStringTag,{value:"Module"}));const U=new class{constructor(){t(this,"accessToken",null),t(this,"refreshToken",null),t(this,"character",null),t(this,"isRefreshing",!1),t(this,"listeners",new Set),t(this,"checkTimer",null),t(this,"tickTimer",null),t(this,"pendingRefreshPromise",null),t(this,"handleStorageEvent",e=>{if("eve_auth_token"===e.key||"eve_auth_refresh_token"===e.key||"eve_auth_character"===e.key){try{this.accessToken=localStorage.getItem("eve_auth_token"),this.refreshToken=localStorage.getItem("eve_auth_refresh_token");const e=localStorage.getItem("eve_auth_character");this.character=e?JSON.parse(e):null}catch{}this.emit()}})}init(){try{this.accessToken=localStorage.getItem("eve_auth_token"),this.refreshToken=localStorage.getItem("eve_auth_refresh_token");const e=localStorage.getItem("eve_auth_character");this.character=e?JSON.parse(e):null}catch{}this.startCheckTimer(),this.startTickTimer(),window.addEventListener("storage",this.handleStorageEvent),this.getAccessToken(),this.emit()}destroy(){this.checkTimer&&(window.clearInterval(this.checkTimer),this.checkTimer=null),this.tickTimer&&(window.clearInterval(this.tickTimer),this.tickTimer=null),window.removeEventListener("storage",this.handleStorageEvent),this.listeners.clear()}subscribe(e){return this.listeners.add(e),e(this.getState()),()=>this.listeners.delete(e)}getState(){return{accessToken:this.accessToken,refreshToken:this.refreshToken,character:this.character,isRefreshing:this.isRefreshing,remainingMinutes:this.getRemainingMinutes(this.accessToken)}}setTokens(e,t){this.accessToken=e,this.refreshToken=t;try{localStorage.setItem("eve_auth_token",e),localStorage.setItem("eve_auth_refresh_token",t)}catch{}this.emit()}setCharacter(e){this.character=e;try{e?localStorage.setItem("eve_auth_character",JSON.stringify(e)):localStorage.removeItem("eve_auth_character")}catch{}this.emit()}async getAccessToken(e=!1){if(!this.accessToken||!this.refreshToken)return null;if(!(e||this.isExpiringSoon(this.accessToken,2)))return this.accessToken;if(this.pendingRefreshPromise)return this.pendingRefreshPromise;this.isRefreshing=!0,this.emit(),this.pendingRefreshPromise=this.refreshInternal();try{return await this.pendingRefreshPromise}finally{this.pendingRefreshPromise=null,this.isRefreshing=!1,this.emit()}}async refreshInternal(){if(!this.refreshToken)throw new Error("无刷新令牌");const e=await z(this.refreshToken),t=e.access_token,a=e.refresh_token||this.refreshToken;return this.setTokens(t,a),t}startCheckTimer(){this.checkTimer&&window.clearInterval(this.checkTimer),this.checkTimer=window.setInterval(()=>{this.getAccessToken()},6e4)}startTickTimer(){this.tickTimer&&window.clearInterval(this.tickTimer),this.tickTimer=window.setInterval(()=>{this.emit()},6e4)}emit(){const e=this.getState();this.listeners.forEach(t=>t(e))}getRemainingMinutes(e){try{if(!e)return 0;const t=this.parseJWTPayload(e);if(!t.exp)return 0;const a=Math.max(0,1e3*t.exp-Date.now());return Math.floor(a/6e4)}catch{return 0}}isExpiringSoon(e,t){try{const a=this.parseJWTPayload(e);if(!a.exp)return!0;const s=6e4*t;return Date.now()+s>=1e3*a.exp}catch{return!0}}parseJWTPayload(e){const t=e.split(".");if(3!==t.length)throw new Error("Invalid JWT");return JSON.parse(atob(t[1]))}};async function Q(e,t,a){const s="string"==typeof a?{type:"region",id:a}:a;try{const a=(await K(e,s)).orders;if(0===a.length)return{totalPrice:0,ordersUsed:[],totalVolume:0};const r=a[0].price;return{totalPrice:r*t,ordersUsed:[{orderId:a[0].order_id,price:r,volumeUsed:t,volumeRemain:a[0].volume_remain}],totalVolume:t}}catch(r){s.type;throw r}}function J(e){const t=new Set;for(const a of e)for(const e of a)t.add(e.typeID);return Array.from(t)}async function W(e,t){try{const a=await fetch(`https://esi.evetech.net/markets/${t}/orders?type_id=${e}&order_type=sell`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const s=await a.json();return{typeID:e,orders:s.filter(e=>!e.is_buy_order).sort((e,t)=>e.price-t.price)}}catch(a){return{typeID:e,orders:[]}}}async function K(e,t,a=!0){try{if("structure"===t.type){if(!t.accessToken)throw new Error("建筑市场需要访问令牌");const s=Number(t.id);if(a){const a=P.getCachedItemOrders(s,t.accessToken,e);if(a)return{typeID:e,orders:a}}const r=(await P.getStructureOrders(s,t.accessToken)).filter(t=>t.type_id===e&&!t.is_buy_order&&t.volume_remain>0).map(e=>({duration:e.duration,is_buy_order:e.is_buy_order,issued:e.issued,location_id:e.location_id,min_volume:e.min_volume,order_id:e.order_id,price:e.price,range:e.range,system_id:0,type_id:e.type_id,volume_remain:e.volume_remain,volume_total:e.volume_total})).sort((e,t)=>e.price-t.price);return{typeID:e,orders:r}}return await W(e,String(t.id))}catch(s){return{typeID:e,orders:[]}}}function H(e,t,a,s=!0){if(0===a.length)return{totalPrice:0,actualQuantity:0,isInsufficient:!0,lowestPrice:0};const r=a[0].price;if(!s){return{totalPrice:r*t,actualQuantity:t,isInsufficient:!1,lowestPrice:r}}let i=t,n=0;for(const l of a){if(i<=0)break;const e=Math.min(i,l.volume_remain);n+=e*l.price,i-=e}const c=t-i;return{totalPrice:n,actualQuantity:c,isInsufficient:c<t,lowestPrice:r}}async function G(e,t,a=!0,s,r,i,n,c,l,o,u){try{const m="string"==typeof t?{type:"region",id:t}:t,h=u||void 0,p=(()=>{const t=J(e),a=o?J(o.map(e=>e.map(e=>({typeID:e.typeID,quantity:e.quantity})))):[];return Array.from(new Set([...t,...a]))})(),y=new Map;if("structure"===m.type)try{const e=m.accessToken||await U.getAccessToken();if(!e)throw new Error("建筑市场需要访问令牌");const t=await P.getStructureOrders(Number(m.id),e);p.forEach(e=>{const a=t.filter(t=>t.type_id===e&&!t.is_buy_order&&t.volume_remain>0).map(e=>({duration:e.duration,is_buy_order:e.is_buy_order,issued:e.issued,location_id:e.location_id,min_volume:e.min_volume,order_id:e.order_id,price:e.price,range:e.range,system_id:0,type_id:e.type_id,volume_remain:e.volume_remain,volume_total:e.volume_total})).sort((e,t)=>e.price-t.price);y.set(e,a)})}catch(d){p.forEach(e=>{y.set(e,[])})}else{const e=p.map(async e=>{try{return{typeID:e,orders:(await W(e,String(m.id))).orders}}catch(d){return{typeID:e,orders:[]}}});(await Promise.all(e)).forEach(e=>{y.set(e.typeID,e.orders)})}const f=[],g=new Map,v=async e=>{if(!h)return[];const t=g.get(e);if(t)return t;try{const t=(await K(e,{type:h.type,id:h.id,accessToken:h.accessToken})).orders.filter(e=>!e.is_buy_order&&e.volume_remain>0).sort((e,t)=>e.price-t.price);return g.set(e,t),t}catch{return[]}};for(let t=0;t<e.length;t++){let o=0;const u=[];for(const s of e[t]){const e=y.get(s.typeID)||[],t=H(s.typeID,s.quantity,e,a);let r=t.totalPrice,i=t.actualQuantity,n=t.lowestPrice,c=t.isInsufficient,l="none",d=0;if(c&&h){const e=s.quantity-i;if(e>0){const o=await v(s.typeID),u=H(s.typeID,e,o,a);r+=u.totalPrice,i+=u.actualQuantity,n=0===n?u.lowestPrice:Math.min(n,u.lowestPrice),c=i<s.quantity,d=u.actualQuantity,d>0&&(l=0===t.actualQuantity&&u.actualQuantity>=s.quantity?"all":t.actualQuantity>0?"partial":u.actualQuantity>0?"all":"none",0===t.actualQuantity&&u.actualQuantity<s.quantity&&(l="partial"))}}o+=r,u.push({typeID:s.typeID,quantity:s.quantity,price:r,isInsufficient:c,actualQuantity:i,lowestPrice:n,fallbackUsed:l,fallbackQuantity:d})}const m={level:t+1,totalPrice:o,materialsCount:u.length,materials:u};if(void 0!==s&&void 0!==r&&void 0!==i)try{let a=[];a=c&&c[t]?c[t]:n&&n[t]?n[t]:e[t].map(e=>({typeID:e.typeID,quantity:e.quantity,typeName:`Material_${e.typeID}`}));const{marketPriceService:o}=await w(async()=>{const{marketPriceService:e}=await Promise.resolve().then(()=>ae);return{marketPriceService:e}},void 0,import.meta.url),u=await o.calculateEIV(a),d=o.getTaxRateDetails(s,r,i,l||0),h=u*d.totalRate;m.eiv=u,m.facilityCost=h,m.totalTaxRate=d.totalRate}catch(d){}f.push(m)}for(let e=0;e<f.length;e++){const t=f[e];t.facilityCost;let a=0;for(let s=e;s>=0;s--)a+=f[s].facilityCost||0;t.cumulativeFacilityCost=a}if(o)for(let e=0;e<f.length;e++){const t=f[e],s=o[e]||[];let r=0;for(const e of s){const t=y.get(e.typeID)||[],s=H(e.typeID,e.quantity,t,a);let i=s.totalPrice,n=s.actualQuantity;if(s.isInsufficient&&h){const t=e.quantity-n;if(t>0){const s=await v(e.typeID);i+=H(e.typeID,t,s,a).totalPrice}}r+=i}t.leftoverCumulativePrice=r}for(let e=0;e<f.length;e++){const t=f[e],a=t.totalPrice||0,s=t.leftoverCumulativePrice||0,r=t.cumulativeFacilityCost||0;t.totalCost=a-s+r}return f}catch(d){throw d}}const X=Object.freeze(Object.defineProperty({__proto__:null,calculateAllLevelPrices:G,calculateItemPrice:H,extractUniqueTypeIDs:J,getItemOrders:W,getItemOrdersUniversal:K,getMarketPrice:async function(e,t,a){const s="string"==typeof a?{type:"region",id:a}:a;try{const a=(await K(e,s)).orders;if(0===a.length)return{totalPrice:0,ordersUsed:[],totalVolume:0};let r=t,i=0;const n=[];for(const e of a){if(r<=0)break;const t=Math.min(r,e.volume_remain);i+=t*e.price,r-=t,n.push({orderId:e.order_id,price:e.price,volumeUsed:t,volumeRemain:e.volume_remain})}return{totalPrice:i,ordersUsed:n,totalVolume:t-r}}catch(r){s.type;throw r}},getProductSellPrice:Q},Symbol.toStringTag,{value:"Module"}));const Y=new class{constructor(){t(this,"config",null)}async loadConfig(){if(this.config)return this.config;try{const e=await fetch("./config/structure-config.json"),t=await e.json();return this.config=t,t}catch(e){throw e}}getConfig(){return this.config}getComplexStructures(){if(!this.config)return[];const e=this.config.structure.complex.map(e=>({name:e.name,value:e.name}));return e.unshift({name:"无建筑",value:"none"}),e}getRefineStructures(){if(!this.config)return[];const e=this.config.structure.refine.map(e=>({name:e.name,value:e.name}));return e.unshift({name:"无建筑",value:"none"}),e}getComplexRigs(){return this.config?[{name:"无插件",value:"none"},{name:"T1",value:"t1"},{name:"T2",value:"t2"}]:[]}getReactionRigs(){return this.config?[{name:"无插件",value:"none"},{name:"T1",value:"t1"},{name:"T2",value:"t2"}]:[]}};const Z=new class{constructor(){t(this,"data",null)}async loadData(){if(this.data)return this.data;try{const e=await fetch("./static/solar_systems.json"),t=await e.json();return this.data=t,t}catch(e){throw e}}getData(){return this.data}searchSolarSystems(e){if(!this.data||e.length<2)return[];const t=[],a=e.toLowerCase();for(const[,s]of Object.entries(this.data.solar_systems)){const e=s.solarSystemName_zh.toLowerCase().includes(a),r=s.solarSystemName_en.toLowerCase().includes(a);if(e||r){const e=s.solarSystemName_zh===s.solarSystemName_en?s.solarSystemName_zh:`${s.solarSystemName_zh}/${s.solarSystemName_en}`;t.push({id:s.solarSystemID,displayName:e,securityColor:this.getSecurityColor(s.display_security),displaySecurity:s.display_security})}}return t.filter((e,t,a)=>t===a.findIndex(t=>t.id===e.id)).sort((e,t)=>e.displayName.localeCompare(t.displayName))}getSolarSystemById(e){return this.data&&this.data.solar_systems[e.toString()]||null}getDisplayNameById(e){const t=this.getSolarSystemById(e);return t?t.solarSystemName_zh===t.solarSystemName_en?t.solarSystemName_zh:`${t.solarSystemName_zh}/${t.solarSystemName_en}`:null}getSecurityColor(e){switch(e){case 1:return"#4173d4";case.9:return"#5598e5";case.8:return"#73cbf4";case.7:return"#81d8a9";case.6:case.5:return"#8fe167";case.4:case.3:return"#d0712d";case.2:case.1:return"#bc1117";default:return e<=0?"#82375d":"#ff0000"}}getDisplayNameWithSecurity(e){const t=this.getSolarSystemById(e);if(!t)return null;return{displayName:t.solarSystemName_zh===t.solarSystemName_en?t.solarSystemName_zh:`${t.solarSystemName_zh}/${t.solarSystemName_en}`,securityColor:this.getSecurityColor(t.display_security),displaySecurity:t.display_security}}};const ee=new class{constructor(){t(this,"systemsData",null),t(this,"lastFetchTime",0),t(this,"CACHE_DURATION",3e5)}async loadSystemsData(){const e=Date.now();if(this.systemsData&&e-this.lastFetchTime<this.CACHE_DURATION)return this.systemsData;try{const t=await fetch("https://esi.evetech.net/industry/systems");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=await t.json();return this.systemsData=a,this.lastFetchTime=e,a}catch(t){throw t}}getSystemsData(){return this.systemsData}getManufacturingCostIndex(e){if(!this.systemsData)return null;const t=this.systemsData.find(t=>t.solar_system_id===e);if(!t)return null;const a=t.cost_indices.find(e=>"manufacturing"===e.activity);return a?a.cost_index:null}getReactionCostIndex(e){if(!this.systemsData)return null;const t=this.systemsData.find(t=>t.solar_system_id===e);if(!t)return null;const a=t.cost_indices.find(e=>"reaction"===e.activity);return a?a.cost_index:null}formatCostIndex(e){return`${(100*e).toFixed(2)}%`}getSystemCostIndices(e){return{manufacturing:this.getManufacturingCostIndex(e),reaction:this.getReactionCostIndex(e)}}};const te=new class{constructor(){t(this,"priceCache",new Map),t(this,"lastFetchTime",0),t(this,"CACHE_DURATION",3e5)}async fetchMarketPrices(){try{const e=await fetch("https://esi.evetech.net/markets/prices");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){return[]}}async getAdjustedPrices(e){const t=Date.now();if(t-this.lastFetchTime<this.CACHE_DURATION&&this.priceCache.size>0){const t=new Map;for(const a of e){const e=this.priceCache.get(a);void 0!==e&&t.set(a,e)}return t}const a=await this.fetchMarketPrices();this.priceCache.clear();for(const r of a)this.priceCache.set(r.type_id,r.adjusted_price);this.lastFetchTime=t;const s=new Map;for(const r of e){const e=this.priceCache.get(r);void 0!==e&&s.set(r,e)}return s}async calculateEIV(e){const t=e.map(e=>e.typeID),a=await this.getAdjustedPrices(t);let s=0;for(const r of e){s+=(a.get(r.typeID)??0)*r.quantity}return s}getSystemCostIndex(e,t){let a;if(a=t?ee.getReactionCostIndex(e):ee.getManufacturingCostIndex(e),null!==a)return a;return.0014}getTaxRateDetails(e,t,a,s=0){const r=this.getSystemCostIndex(e,a),i=.04,n=t,c=s/100;return{costIndex:r,facilityTax:t,scc:i,structureTax:s,totalRate:r*n+(c+i),details:[`星系成本指数（系数）: ${(100*r).toFixed(2)}%`,`建筑费用减免: ${(100*n).toFixed(2)}%`,`设施税率: ${(100*c).toFixed(2)}%`,`SCC费用: ${4..toFixed(2)}%`]}}async calculateFacilityCost(e){return await this.calculateEIV(e.materials)*this.getTaxRateDetails(e.solarSystemId,e.facilityTax,e.isReaction,e.structureTax||0).totalRate}},ae=Object.freeze(Object.defineProperty({__proto__:null,marketPriceService:te},Symbol.toStringTag,{value:"Module"}));const se=new class{calculateBlueprintMaterials(e){const t=D.getEveData();if(!t)return[];const a=D.getBlueprintInfo(e.itemId);if(!a)return[];const s=this.calculateBonus(e);if(!s)return[];const r=[];return a.materials&&a.materials.forEach(a=>{var i;const n=a.quantity||0,c=n*e.runs;let l;l=n<=1?c:Math.ceil(c*s.materialBonus);const o=t.type_info[a.typeId.toString()],u=D.getBlueprintInfo(a.typeId),d={typeID:a.typeId,typeName_zh:(null==o?void 0:o.zh_name)||`未知物品_${a.typeId}`,typeName_en:(null==o?void 0:o.en_name)||`Unknown_${a.typeId}`,quantity:l,volume:T(o),hasBlueprint:!!u,blueprintTypeID:(null==u?void 0:u.blueprintId)||null};if(r.push(d),e.isRecursive&&d.hasBlueprint&&d.blueprintTypeID&&!(null==(i=e.excludedMaterials)?void 0:i.has(a.typeId))&&(void 0===e.maxDepth||e.maxDepth>0)){e.globalMaterialEfficiency,e.globalTimeEfficiency,e.structureType,e.rigType,e.solarSystemId,e.excludedMaterials,void 0!==e.maxDepth&&e.maxDepth,e.globalMaterialEfficiency,e.globalTimeEfficiency;const t=D.getBlueprintInfo(d.blueprintTypeID);if(t){const e=l;Math.ceil(e/t.outputQuantity)}}}),r}calculateBonus(e){const t=D.getBlueprintInfo(e.itemId);if(!t)return null;const a="reaction"===t.category,s=a?1:1-.01*e.materialEfficiency,r=a?1:1-.01*e.timeEfficiency,i=Y.getConfig();if(!i)return null;let n=1,c=1,l=1;if(a){if("none"!==e.structureType){const t=i.structure.refine.find(t=>t.name===e.structureType);t&&(n=t.ME,c=t.TE,l=t.Cost)}}else if("none"!==e.structureType){const t=i.structure.complex.find(t=>t.name===e.structureType);t&&(n=t.ME,c=t.TE,l=t.Cost)}let o=1,u=1;if("none"!==e.rigType){const t=a?i["reaction-rigs"][e.rigType]:i["complex-rigs"][e.rigType];if(t&&(u=t.Cost,e.solarSystemId)){const a=Z.getSolarSystemById(e.solarSystemId);if(a){const e=a.display_security;let s=1;s=e>=.5?t.hs:e>=0?t.ls:t.ns,o=1-s*(1-t.ME)}}}return{materialBonus:s*n*o,timeBonus:r*c,costBonus:l*u,isReaction:a,blueprintME:s,blueprintTE:r,structureME:n,structureTE:c,structureCost:l,rigSecurityBonus:o,rigCost:u}}getOutputQuantity(e){const t=D.getBlueprintInfo(e);return(null==t?void 0:t.outputQuantity)||1}async calculateFacilityCost(e,t){if(!t.solarSystemId)return{facilityCost:0,eiv:0,costIndex:0,facilityTax:0,scc:.04,totalTaxRate:0,taxDetails:[]};const a=this.calculateBonus(t);if(!a)return{facilityCost:0,eiv:0,costIndex:0,facilityTax:0,scc:.04,totalTaxRate:0,taxDetails:[]};const s=D.getBlueprintInfo(t.itemId),r=[];(null==s?void 0:s.materials)&&s.materials.forEach(e=>{const a=(e.quantity||0)*t.runs,s=D.getEveData(),i=null==s?void 0:s.type_info[e.typeId.toString()];r.push({typeID:e.typeId,quantity:a,typeName:(null==i?void 0:i.zh_name)||`未知物品_${e.typeId}`})});const i={materials:r,solarSystemId:t.solarSystemId,facilityTax:a.structureCost,isReaction:a.isReaction,scc:.04},n=await te.calculateFacilityCost(i),c=te.getTaxRateDetails(t.solarSystemId,a.structureCost,a.isReaction);return{facilityCost:n,eiv:n/c.totalRate,costIndex:c.costIndex,facilityTax:c.facilityTax,scc:c.scc,totalTaxRate:c.totalRate,taxDetails:c.details}}},re=({selectedNode:e,settings:t,authToken:s})=>{var i;const[m,h]=a.useState({materialEfficiency:(null==t?void 0:t.materialEfficiency)??0,timeEfficiency:(null==t?void 0:t.timeEfficiency)??0,runs:(null==t?void 0:t.runs)??1,productionLines:1}),[p,y]=a.useState((null==(i=null==t?void 0:t.runs)?void 0:i.toString())??"1"),[f,g]=a.useState((null==t?void 0:t.runs)??1),[v,x]=a.useState(1),[S,j]=a.useState(new Set),[N,_]=a.useState(new Set),b=r.useRef(new Map),E=r.useRef(new Map),[C,M]=a.useState([]),[R,B]=a.useState(!1),[O,q]=a.useState(null),[L,A]=a.useState(!1),[z,V]=a.useState(null),[F,J]=a.useState(!1),[W,K]=a.useState(!1),[H,Y]=a.useState(""),[Z,ee]=a.useState(new Map),[te,ae]=a.useState(null),[re,ie]=a.useState("price"),[ne,ce]=a.useState(new Set),[le,oe]=a.useState(null),[ue,de]=a.useState([]),[me,he]=a.useState(new Map);a.useEffect(()=>{null!=te&&ce(new Set)},[te]);const pe=e=>e.replace(/\*/g,"").trim().toLowerCase();a.useEffect(()=>{var a;e&&(h(e=>({materialEfficiency:(null==t?void 0:t.materialEfficiency)??e.materialEfficiency??0,timeEfficiency:(null==t?void 0:t.timeEfficiency)??e.timeEfficiency??0,runs:(null==t?void 0:t.runs)??e.runs??1,productionLines:e.productionLines??1})),y((null==(a=null==t?void 0:t.runs)?void 0:a.toString())??"1"),g((null==t?void 0:t.runs)??1))},[null==e?void 0:e.id]),a.useEffect(()=>{j(new Set),_(new Set)},[null==e?void 0:e.id]),a.useEffect(()=>{const e=setTimeout(()=>{g(m.runs),x(m.productionLines||1)},500);return()=>clearTimeout(e)},[m.runs,m.productionLines]),a.useEffect(()=>{if(null==(null==t?void 0:t.runs))return;const e=m.runs,a=""===p?NaN:parseInt(p);e===t.runs&&(!!isNaN(a)||a===t.runs)&&(h(e=>({...e,runs:t.runs})),y(String(t.runs)),g(t.runs))},[null==t?void 0:t.runs]);const ye=e=>e.filter(e=>e.hasBlueprint&&!N.has(e.typeID)).map(e=>({typeID:e.typeID,quantity:e.quantity,typeName:e.typeName_zh})),fe=async(e,t=!1)=>{try{const a=e.filter(e=>(e.quantity||0)>0);if(0===a.length)return;const s=a.map(e=>`${t?e.typeName_en:e.typeName_zh}    ${e.quantity.toLocaleString()}`).join("\n");await navigator.clipboard.writeText(s)}catch(a){}},ge=async e=>{if(!t)return{notWorth:!1};const a="structure"===t.marketType&&t.structureMarketId&&await U.getAccessToken()||void 0,s="structure"===t.marketType&&t.structureMarketId?{type:"structure",id:t.structureMarketId,accessToken:a}:{type:"region",id:t.marketSelection},r=D.getBlueprintInfo(e.typeID);if(!r)return{notWorth:!1};try{const a=Math.ceil((e.quantity||0)/(r.outputQuantity||1)),i=a*(r.outputQuantity||1),{getMarketPrice:n}=await w(async()=>{const{getMarketPrice:e}=await Promise.resolve().then(()=>X);return{getMarketPrice:e}},void 0,import.meta.url),c=await n(e.typeID,i,s);if((c.totalVolume||0)<i)return{notWorth:!1};const l=c.totalPrice,o=(()=>{const s=[],i=new Map,n="reaction"===r.category,c={itemId:e.blueprintTypeID,runs:a,materialEfficiency:t.materialEfficiency||0,timeEfficiency:t.timeEfficiency||0,structureType:n?t.refineStructure:t.complexStructure,rigType:n?t.reactionRig:t.complexRig,solarSystemId:n?t.refineSolarSystem:t.complexSolarSystem,excludedMaterials:N,isRecursive:!1,maxDepth:1,globalMaterialEfficiency:t.materialEfficiency||0,globalTimeEfficiency:t.timeEfficiency||0},l=se.calculateBlueprintMaterials(c),o=D.getEveData(),u=l.map(e=>{const t=null==o?void 0:o.type_info[e.typeID.toString()],a=e.volume||T(t),s=e.hasBlueprint,r=s&&e.blueprintTypeID&&(null==o?void 0:o.reaction.includes(e.blueprintTypeID))||!1;return{typeID:e.typeID,typeName_zh:e.typeName_zh,typeName_en:e.typeName_en,typeIcon:(null==t?void 0:t.icon_name)||"",quantity:e.quantity,volume:a,totalVolume:a*e.quantity,hasBlueprint:s||!1,isReaction:r||!1,blueprintTypeID:e.blueprintTypeID}}).sort((e,t)=>e.typeID-t.typeID),d=[];r.materials&&r.materials.forEach(e=>{if(!N.has(e.typeId)){const t=(e.quantity||0)*a,s=null==o?void 0:o.type_info[e.typeId.toString()];d.push({typeID:e.typeId,quantity:t,typeName:(null==s?void 0:s.zh_name)||`未知物品_${e.typeId}`})}}),s.push({level:1,materials:u,hasNextLevel:u.some(e=>e.hasBlueprint&&!N.has(e.typeID)),taxCalculationMaterials:d,leftoverProducts:[]});let m=u,h=s[0].hasNextLevel,p=1;for(;h;){const e=new Map,a=[],r=[];m.forEach(s=>{if(s.hasBlueprint&&s.blueprintTypeID&&!N.has(s.typeID)){const i=D.getBlueprintInfo(s.typeID);if(i){const n=s.quantity||0,c=Math.ceil(n/(i.outputQuantity||1)),l=c*(i.outputQuantity||1)-n;l>0&&r.push({typeID:s.typeID,quantity:l,typeName:s.typeName_zh}),i.materials&&i.materials.forEach(e=>{const t=(e.quantity||0)*c,s=a.findIndex(t=>t.typeID===e.typeId);if(s>=0)a[s].quantity+=t;else{const s=null==o?void 0:o.type_info[e.typeId.toString()];a.push({typeID:e.typeId,quantity:t,typeName:(null==s?void 0:s.zh_name)||`未知物品_${e.typeId}`})}});const u="reaction"===i.category,d={itemId:s.blueprintTypeID,runs:c,materialEfficiency:t.materialEfficiency||0,timeEfficiency:t.timeEfficiency||0,structureType:u?t.refineStructure:t.complexStructure,rigType:u?t.reactionRig:t.complexRig,solarSystemId:u?t.refineSolarSystem:t.complexSolarSystem,excludedMaterials:N,isRecursive:!1,maxDepth:1,globalMaterialEfficiency:t.materialEfficiency||0,globalTimeEfficiency:t.timeEfficiency||0};se.calculateBlueprintMaterials(d).forEach(t=>{const a=null==o?void 0:o.type_info[t.typeID.toString()],s=t.volume||T(a),r=t.hasBlueprint,i=r&&t.blueprintTypeID&&(null==o?void 0:o.reaction.includes(t.blueprintTypeID))||!1,n=e.get(t.typeID);n?(n.quantity+=t.quantity,n.totalVolume=(n.totalVolume||0)+s*t.quantity):e.set(t.typeID,{typeID:t.typeID,typeName_zh:t.typeName_zh,typeName_en:t.typeName_en,typeIcon:(null==a?void 0:a.icon_name)||"",quantity:t.quantity,volume:s,totalVolume:s*t.quantity,hasBlueprint:r||!1,isReaction:i||!1,blueprintTypeID:t.blueprintTypeID})})}}else{const t=e.get(s.typeID);t?(t.quantity+=s.quantity,t.totalVolume=(t.totalVolume||0)+(s.totalVolume||0)):e.set(s.typeID,{...s})}});const n=new Map;r.forEach(e=>{const t=n.get(e.typeID);t?t.quantity+=e.quantity:n.set(e.typeID,{...e})}),Array.from(n.values()).forEach(e=>{const t=i.get(e.typeID);t?t.quantity+=e.quantity:i.set(e.typeID,{...e})}),p++;const c=Array.from(e.values()).sort((e,t)=>e.typeID-t.typeID);m=c,h=c.some(e=>e.hasBlueprint&&!N.has(e.typeID)),s.push({level:p,materials:c,hasNextLevel:h,taxCalculationMaterials:a,leftoverProducts:Array.from(i.values())})}return s})(),u=o.map(e=>e.materials.map(e=>({typeID:e.typeID,quantity:e.quantity}))),d=o.map(e=>ye(e.materials)),m=o.map(e=>e.taxCalculationMaterials),h=o.map(e=>e.leftoverProducts),p={itemId:e.typeID,runs:a,materialEfficiency:t.materialEfficiency||0,timeEfficiency:t.timeEfficiency||0,structureType:"reaction"===r.category?t.refineStructure:t.complexStructure,rigType:"reaction"===r.category?t.reactionRig:t.complexRig,solarSystemId:"reaction"===r.category?t.refineSolarSystem:t.complexSolarSystem},y=se.calculateBonus(p),f=await G(u,s,t.considerOrderVolume,"reaction"===r.category?t.refineSolarSystem||void 0:t.complexSolarSystem||void 0,null==y?void 0:y.structureCost,null==y?void 0:y.isReaction,d,m,("reaction"===r.category?t.reactionTax:t.complexTax)||0,h),g=f[f.length-1],v=g&&"number"==typeof g.totalCost?g.totalCost:(null==g?void 0:g.totalPrice)||0;return{notWorth:!(v<=l*.95||l-v>=1e6)}}catch(i){return{notWorth:!1}}},ve=({width:e,height:t,data:a})=>{const s=Math.min(e,t)/2,r=e/2,i=t/2,n=a.reduce((e,t)=>e+t.value,0)||1;let c=-Math.PI/2;const l=[];return a.forEach((e,t)=>{if(1===a.length||Math.abs(e.value-n)<1e-6)return void l.push(I.jsx("circle",{cx:r,cy:i,r:s,fill:e.color},t));const o=e.value/n*Math.PI*2,u=r+s*Math.cos(c),d=i+s*Math.sin(c),m=r+s*Math.cos(c+o),h=i+s*Math.sin(c+o),p=o>Math.PI?1:0,y=`M ${r} ${i} L ${u} ${d} A ${s} ${s} 0 ${p} 1 ${m} ${h} Z`;l.push(I.jsx("path",{d:y,fill:e.color},t)),c+=o}),I.jsx("svg",{width:e,height:t,viewBox:`0 0 ${e} ${t}`,children:l})},xe=(e,a,s,i=0)=>{const n=s?`${a}-${s}-${e.typeID}`:`${a}-${e.typeID}`,c=S.has(n),l=N.has(e.typeID),o=C.find(e=>e.level===a),m=null==o?void 0:o.materials.find(t=>t.typeID===e.typeID);let h=null;if(e.hasBlueprint){const t=D.getBlueprintInfo(e.typeID),a=(null==t?void 0:t.outputQuantity)||0;a>0&&(h=Math.ceil((e.quantity||0)/a))}const p=`${a}-${e.typeID}-${e.quantity}`,y=!0===me.get(p);return I.jsxs(r.Fragment,{children:[I.jsxs("div",{className:`material-item ${e.hasBlueprint?"has-blueprint":""} ${e.isReaction?"is-reaction":""} ${e.hasBlueprint?"clickable":""} ${l?"excluded":""} ${e.deductedQuantity?"deducted":""} ${y?"not-worth":""}`,onClick:()=>((e,t,a)=>{if(!e.hasBlueprint)return;let s;s=a?`${t}-${a}-${e.typeID}`:`${t}-${e.typeID}`;const r=new Set(S);if(r.has(s)){r.delete(s);const a=[];r.forEach(s=>{s.startsWith(`${t}-${e.typeID}-`)&&a.push(s)}),a.forEach(e=>{r.delete(e)})}else r.add(s);j(r)})(e,a,s),style:{marginLeft:20*i+"px"},children:[I.jsx("div",{className:"material-icon",children:I.jsx(k,{src:`./static/icons/${e.typeIcon}`,alt:e.typeName_zh,size:24,showLoadingIndicator:!0})}),I.jsxs("div",{className:"material-info",children:[I.jsxs("div",{className:"material-name",children:[e.typeName_zh," × ",e.quantity.toLocaleString(),null!=h?` (${h.toLocaleString()}流程)`:"",e.deductedQuantity?I.jsxs("span",{style:{marginLeft:6,color:"#ffeb3b",fontSize:11},children:["(-",e.deductedQuantity.toLocaleString(),")"]}):null,e.hasBlueprint&&I.jsx("span",{className:"expand-indicator "+(c?"expanded":""),children:c?"▼":"▶"})]}),m&&I.jsxs("div",{className:"material-price "+(m.isInsufficient?"insufficient":""),children:[$(m.price),m.isInsufficient&&I.jsxs("span",{className:"insufficient-warning",children:["(订单不足: ",m.actualQuantity.toLocaleString(),"/",e.quantity.toLocaleString(),")"]}),F&&m.fallbackUsed&&"none"!==m.fallbackUsed&&I.jsx("span",{className:"insufficient-warning",style:{marginLeft:6,color:"#52c41a"},children:"all"===m.fallbackUsed?"全部从Jita采购":"部分从Jita采购"})]}),R&&!m&&I.jsx("div",{className:"material-price-loading",children:"计算价格中..."})]}),I.jsxs("div",{className:"material-volume",children:[(e.totalVolume||0).toFixed(2)," m³"]}),I.jsx("div",{className:"material-blueprint-status",children:e.hasBlueprint?e.isReaction?I.jsx("span",{className:"reaction-badge",children:"反应"}):I.jsx("span",{className:"blueprint-badge",children:"蓝图"}):I.jsx("span",{className:"no-blueprint-badge",children:"无蓝图"})}),e.hasBlueprint&&I.jsx("div",{className:"material-exclusion-control",children:I.jsx("button",{className:"exclusion-button "+(l?"excluded":""),onClick:t=>{t.stopPropagation(),((e,t)=>{if(void 0!==t){const e=b.current.get(t);e&&E.current.set(t,e.scrollTop)}const a=new Set(N);a.has(e)?a.delete(e):a.add(e),_(a),void 0!==t&&requestAnimationFrame(()=>{const e=b.current.get(t),a=E.current.get(t)??0;e&&(e.scrollTop=a)})})(e.typeID,a)},title:l?"恢复拆解":"排除拆解",children:l?I.jsx(u,{}):I.jsx(d,{})})})]}),c&&e.hasBlueprint&&e.blueprintTypeID&&t&&(()=>{const s=D.getBlueprintInfo(e.typeID);if(!s||!e.blueprintTypeID)return null;const r=l?I.jsx("div",{className:"excluded-material-notice",style:{marginLeft:20*(i+1)+"px"},children:I.jsxs("div",{className:"notice-content",children:[I.jsx("span",{className:"notice-icon",children:"ℹ️"}),I.jsx("span",{className:"notice-text",children:"此材料已被排除，其子材料不会在后续层级中继续拆解"})]})}):null,n=e.quantity||0,c=Math.ceil(n/s.outputQuantity),o="reaction"===s.category,u={itemId:e.blueprintTypeID,runs:c,materialEfficiency:(null==t?void 0:t.materialEfficiency)||0,timeEfficiency:(null==t?void 0:t.timeEfficiency)||0,structureType:o?t.refineStructure:t.complexStructure,rigType:o?t.reactionRig:t.complexRig,solarSystemId:o?t.refineSolarSystem:t.complexSolarSystem,excludedMaterials:N,isRecursive:!1,maxDepth:1,globalMaterialEfficiency:(null==t?void 0:t.materialEfficiency)||0,globalTimeEfficiency:(null==t?void 0:t.timeEfficiency)||0},d=se.calculateBlueprintMaterials(u).map(t=>{const s=D.getEveData(),r=null==s?void 0:s.type_info[t.typeID.toString()],n=(t.volume||T(r))*t.quantity,c=t.hasBlueprint,l=c&&t.blueprintTypeID&&(null==s?void 0:s.reaction.includes(t.blueprintTypeID))||!1;return xe({typeID:t.typeID,typeName_zh:t.typeName_zh,typeName_en:t.typeName_en,typeIcon:(null==r?void 0:r.icon_name)||"",quantity:t.quantity,totalVolume:n,hasBlueprint:c||!1,isReaction:l||!1,blueprintTypeID:t.blueprintTypeID},a,e.typeID,i+1)});return I.jsxs(I.Fragment,{children:[r,d]})})()]},n)},Se=a.useMemo(()=>{if(!e||"item"!==e.type||!t)return null;const a=parseInt(e.id),s=(()=>{const e=D.getBlueprintInfo(a);return"reaction"===(null==e?void 0:e.category)})(),r=Math.max(1,f||1),i=Math.max(1,v||1),n={itemId:a,runs:r,materialEfficiency:m.materialEfficiency,timeEfficiency:m.timeEfficiency,structureType:s?t.refineStructure:t.complexStructure,rigType:s?t.reactionRig:t.complexRig,solarSystemId:s?t.refineSolarSystem:t.complexSolarSystem,excludedMaterials:N,isRecursive:!1,maxDepth:1,globalMaterialEfficiency:(null==t?void 0:t.materialEfficiency)||0,globalTimeEfficiency:(null==t?void 0:t.timeEfficiency)||0},c=se.calculateBlueprintMaterials(n).map(e=>({...e,quantity:e.quantity*i,volume:e.volume})),l=c.map(e=>{const t=D.getEveData(),a=null==t?void 0:t.type_info[e.typeID.toString()],s=e.volume||T(a);return{typeID:e.typeID,typeName_zh:e.typeName_zh,typeName_en:e.typeName_en,typeIcon:(null==a?void 0:a.icon_name)||"",quantity:e.quantity,volume:s,totalVolume:s*e.quantity,hasBlueprint:e.hasBlueprint||!1,isReaction:(()=>{if(!e.hasBlueprint||!e.blueprintTypeID)return!1;const t=D.getEveData();return(null==t?void 0:t.reaction.includes(e.blueprintTypeID))||!1})()||!1,blueprintTypeID:e.blueprintTypeID}}).sort((e,t)=>{const a=N.has(e.typeID),s=N.has(t.typeID);return a&&!s?-1:!a&&s?1:e.typeID-t.typeID}),o=(()=>{const e=[],s=D.getBlueprintInfo(a),r=[],i=new Map;(null==s?void 0:s.materials)&&s.materials.forEach(e=>{if(!N.has(e.typeId)){const t=(e.quantity||0)*f,a=D.getEveData(),s=null==a?void 0:a.type_info[e.typeId.toString()];r.push({typeID:e.typeId,quantity:t,typeName:(null==s?void 0:s.zh_name)||`未知物品_${e.typeId}`})}}),e.push({level:1,materials:l,hasNextLevel:l.some(e=>e.hasBlueprint&&!N.has(e.typeID)),taxCalculationMaterials:r,leftoverProducts:[]});let n=1,c=l,o=c.some(e=>e.hasBlueprint&&!N.has(e.typeID));for(;o;){const a=new Map;c.forEach(e=>{if(e.hasBlueprint&&e.blueprintTypeID&&!N.has(e.typeID)){const s=D.getBlueprintInfo(e.typeID);if(s&&e.blueprintTypeID){const r=e.quantity||0,i=Math.ceil(r/s.outputQuantity),n="reaction"===s.category,c={itemId:e.blueprintTypeID,runs:i,materialEfficiency:(null==t?void 0:t.materialEfficiency)||0,timeEfficiency:(null==t?void 0:t.timeEfficiency)||0,structureType:n?t.refineStructure:t.complexStructure,rigType:n?t.reactionRig:t.complexRig,solarSystemId:n?t.refineSolarSystem:t.complexSolarSystem,excludedMaterials:N,isRecursive:!1,maxDepth:1,globalMaterialEfficiency:(null==t?void 0:t.materialEfficiency)||0,globalTimeEfficiency:(null==t?void 0:t.timeEfficiency)||0};se.calculateBlueprintMaterials(c).forEach(e=>{const t=D.getEveData(),s=null==t?void 0:t.type_info[e.typeID.toString()],r=e.volume||T(s),i=r*e.quantity,n=e.hasBlueprint,c=n&&e.blueprintTypeID&&(null==t?void 0:t.reaction.includes(e.blueprintTypeID))||!1,l=a.get(e.typeID);l?(l.quantity+=e.quantity,l.totalVolume=(l.totalVolume||0)+i):a.set(e.typeID,{typeID:e.typeID,typeName_zh:e.typeName_zh,typeName_en:e.typeName_en,typeIcon:(null==s?void 0:s.icon_name)||"",quantity:e.quantity,volume:r,totalVolume:i,hasBlueprint:n||!1,isReaction:c||!1,blueprintTypeID:e.blueprintTypeID})})}}else{const t=a.get(e.typeID);t?(t.quantity+=e.quantity,t.totalVolume=(t.totalVolume||0)+(e.totalVolume||0)):a.set(e.typeID,{typeID:e.typeID,typeName_zh:e.typeName_zh,typeName_en:e.typeName_en,typeIcon:e.typeIcon,quantity:e.quantity,volume:e.volume,totalVolume:e.totalVolume,hasBlueprint:e.hasBlueprint,isReaction:e.isReaction,blueprintTypeID:e.blueprintTypeID})}});const s=Array.from(a.values()).sort((e,t)=>{const a=N.has(e.typeID),s=N.has(t.typeID);return a&&!s?-1:!a&&s?1:e.typeID-t.typeID}),r=[],l=[];c.forEach(e=>{if(e.hasBlueprint&&e.blueprintTypeID&&!N.has(e.typeID)){const a=D.getBlueprintInfo(e.typeID);if(a&&e.blueprintTypeID){const s=e.quantity||0,i=Math.ceil(s/a.outputQuantity),n=i*a.outputQuantity-s;n>0&&l.push({typeID:e.typeID,quantity:n,typeName:e.typeName_zh});const c={itemId:e.blueprintTypeID,runs:1,materialEfficiency:m.materialEfficiency,timeEfficiency:m.timeEfficiency,structureType:(null==t?void 0:t.complexStructure)||"engineering_complex",rigType:(null==t?void 0:t.complexRig)||"none",solarSystemId:(null==t?void 0:t.complexSolarSystem)||null,excludedMaterials:N};if(!se.calculateBonus(c))return;a.materials.forEach(e=>{const t=(e.quantity||0)*i,a=r.findIndex(t=>t.typeID===e.typeId);if(a>=0)r[a].quantity+=t;else{const a=D.getEveData(),s=null==a?void 0:a.type_info[e.typeId.toString()];r.push({typeID:e.typeId,quantity:t,typeName:(null==s?void 0:s.zh_name)||`未知物品_${e.typeId}`})}})}}});const u=new Map;l.forEach(e=>{const t=u.get(e.typeID);t?t.quantity+=e.quantity:u.set(e.typeID,{...e})});const d=Array.from(u.values());n++,c=s,o=c.some(e=>e.hasBlueprint&&!N.has(e.typeID)),d.forEach(e=>{const t=i.get(e.typeID);t?t.quantity+=e.quantity:i.set(e.typeID,{...e})}),e.push({level:n,materials:s,hasNextLevel:o,taxCalculationMaterials:r,leftoverProducts:Array.from(i.values())})}return e})().map(e=>{const t=e.materials.map(e=>({...e})),a=new Map(Z);return t.forEach(e=>{const t=pe(e.typeName_zh),s=pe(e.typeName_en);if(t===s){const s=a.get(t)||0;if(s>0&&e.quantity>0){const r=Math.min(s,e.quantity);e.quantity-=r,e.volume&&(e.totalVolume=(e.volume||0)*e.quantity),e.deductedQuantity=r,a.set(t,s-r)}return}const r=a.get(t)||0,i=a.get(s)||0,n=r+i;if(n>0&&e.quantity>0){const c=Math.min(n,e.quantity);let l=c;if(r>0){const e=Math.min(r,l);l-=e,a.set(t,r-e)}if(l>0&&i>0){const e=Math.min(i,l);l-=e,a.set(s,i-e)}e.quantity-=c,e.volume&&(e.totalVolume=(e.volume||0)*e.quantity),e.deductedQuantity=c}}),{...e,materials:t}}),u=se.getOutputQuantity(a)*i;return{blueprintName_zh:e.name,blueprintName_en:e.name_en,outputQuantity:u,materials:l,materialLevels:o,blueprintMaterials:c}},[null==e?void 0:e.id,null==e?void 0:e.type,f,v,m.materialEfficiency,m.timeEfficiency,N,null==t?void 0:t.marketSelection,null==t?void 0:t.complexStructure,null==t?void 0:t.complexRig,null==t?void 0:t.complexSolarSystem,null==t?void 0:t.refineStructure,null==t?void 0:t.reactionRig,null==t?void 0:t.refineSolarSystem,Z]),Ie=a.useMemo(()=>{if(!z||!C||0===C.length||!Se)return!1;const e=(Se.outputQuantity||0)*(f||1);if((z.actualQuantity||0)<e)return!1;const t=C.map(e=>e.totalCost).filter(e=>"number"==typeof e&&!isNaN(e));if(0===t.length)return!1;const a=Math.min(...t),s=z.price;return!(a<=.95*s||s-a>=1e6)},[z,C,Se,f]),je=a.useMemo(()=>{if(!z||!C||0===C.length||!Se)return null;const e=(Se.outputQuantity||0)*(f||1);if((z.actualQuantity||0)<e)return null;const t=C.map(e=>e.totalCost).filter(e=>"number"==typeof e&&!isNaN(e));if(0===t.length)return null;const a=Math.min(...t),s=z.price,r=1e6,i=s-a,n=a<=.95*s,c=i>=r;return{notWorth:!(n||c),minCost:a,direct:s,ratio:0===s?0:a/s,saving:i,ratioThreshold:.95,savingThreshold:r,ratioOk:n,savingOk:c}},[z,C,Se,f]);return a.useEffect(()=>{if(!Se)return;if(!("structure"===(null==t?void 0:t.marketType)?Boolean(null==t?void 0:t.structureMarketId):Boolean(null==t?void 0:t.marketSelection)))return;const a=Se.materialLevels.map(e=>e.materials.map(e=>({typeID:e.typeID,quantity:e.quantity})));if(a.length>0&&(async a=>{if((null==t?void 0:t.marketSelection)||(null==t?void 0:t.structureMarketId)){B(!0);try{const r="structure"===t.marketType&&t.structureMarketId&&await U.getAccessToken()||void 0,i="structure"===t.marketType&&t.structureMarketId?{type:"structure",id:t.structureMarketId,accessToken:r}:{type:"region",id:t.marketSelection};if("structure"===i.type&&i.accessToken)try{await P.preloadStructureOrders(Number(i.id),i.accessToken)}catch(s){}const n={itemId:parseInt((null==e?void 0:e.id)||"0"),runs:f,materialEfficiency:m.materialEfficiency,timeEfficiency:m.timeEfficiency,structureType:t.complexStructure,rigType:t.complexRig,solarSystemId:t.complexSolarSystem,excludedMaterials:N},c=se.calculateBonus(n),l=(null==Se?void 0:Se.materialLevels.map(e=>ye(e.materials)))||[],o=(null==Se?void 0:Se.materialLevels.map(e=>e.taxCalculationMaterials))||[],u=await G(a,i,t.considerOrderVolume,t.complexSolarSystem||void 0,null==c?void 0:c.structureCost,null==c?void 0:c.isReaction,l,o,t.complexTax||0,(null==Se?void 0:Se.materialLevels.map(e=>e.leftoverProducts))||[],F?{type:"region",id:"10000002"}:void 0);M(u)}catch(s){M([])}finally{B(!1)}}})(a),Se.outputQuantity){const a=Se.outputQuantity*f;(async(e,a)=>{if((null==t?void 0:t.marketSelection)||(null==t?void 0:t.structureMarketId)){A(!0);try{const r="structure"===t.marketType&&t.structureMarketId?{type:"structure",id:t.structureMarketId,accessToken:s||void 0}:{type:"region",id:t.marketSelection},i=await Q(e,a,r);q({price:i.totalPrice,isInsufficient:!1,actualQuantity:a});const{getMarketPrice:n}=await w(async()=>{const{getMarketPrice:e}=await Promise.resolve().then(()=>X);return{getMarketPrice:e}},void 0,import.meta.url),c=await n(e,a,r);V({price:c.totalPrice,actualQuantity:c.totalVolume})}catch(r){q(null),V(null)}finally{A(!1)}}})(parseInt((null==e?void 0:e.id)||"0"),a)}(async()=>{const e=new Map;for(const a of Se.materialLevels)for(const s of a.materials){const r=`${a.level}-${s.typeID}-${s.quantity}`;try{const t=await ge(s);e.set(r,t.notWorth)}catch(t){e.set(r,!1)}}he(e)})()},[Se,null==t?void 0:t.marketSelection,null==t?void 0:t.structureMarketId,null==t?void 0:t.marketType,null==t?void 0:t.considerOrderVolume,null==t?void 0:t.complexStructure,null==t?void 0:t.complexRig,null==t?void 0:t.complexSolarSystem,null==t?void 0:t.refineStructure,null==t?void 0:t.reactionRig,null==t?void 0:t.refineSolarSystem,null==t?void 0:t.complexTax,f,v,null==e?void 0:e.id,N,s,F]),e?"item"!==e.type?I.jsx("div",{className:"blueprint-view",children:I.jsxs("div",{className:"no-blueprint",children:[I.jsx("div",{className:"no-blueprint-icon",children:"📁"}),I.jsx("div",{className:"no-blueprint-text",children:"此分类不包含制造信息"})]})}):Se?I.jsxs("div",{className:"blueprint-view",children:[(R||L)&&I.jsx("div",{className:"loading-overlay",children:I.jsxs("div",{className:"loading-box",children:[I.jsx("div",{className:"loading-spinner"}),I.jsx("div",{className:"loading-text",children:"加载价格中..."})]})}),I.jsx("div",{className:"blueprint-header",children:I.jsxs("div",{className:"blueprint-header-content",children:[I.jsx("div",{className:"blueprint-icon",children:I.jsx(k,{src:(()=>{const t=D.getEveData(),a=null==t?void 0:t.type_info[e.id];return(null==a?void 0:a.icon_name)?`./static/icons/${a.icon_name}`:`./static/icons/icon_${e.id}_64.png`})(),alt:Se.blueprintName_zh,size:64,showLoadingIndicator:!0})}),I.jsxs("div",{className:"blueprint-info",children:[I.jsxs("div",{className:"blueprint-name",children:[Se.blueprintName_zh,Ie&&je&&I.jsxs("span",{className:"bp-tag not-worth",children:["不值得制造:",`${je.ratioOk?"":"1. 成本占比不够低"}${je.ratioOk||je.savingOk?"":"\n"}${je.savingOk?"":"2. 利润不够高"}`.trim()]}),I.jsxs("span",{className:"blueprint-name-en",children:[" (",Se.blueprintName_en,")"]})]}),(()=>{const t=e&&"item"===e.type?D.getBlueprintInfo(parseInt(e.id)):null,a="reaction"===(null==t?void 0:t.category);return I.jsxs("div",{className:"blueprint-settings",children:[I.jsxs("div",{className:"blueprint-setting-item",children:[I.jsx("label",{children:"流程数:"}),I.jsx("input",{type:"number",min:"1",max:"10000",value:p,onFocus:e=>{e.target.select()},onChange:e=>{const t=e.target.value;y(t);const a=""===t||isNaN(parseInt(t))?1:Math.max(1,parseInt(t));h({...m,runs:a})},onBlur:e=>{""===e.target.value&&(y("1"),h({...m,runs:1}))}})]}),I.jsxs("div",{className:"blueprint-setting-item",children:[I.jsx("label",{children:"产线数:"}),I.jsx("select",{value:m.productionLines,onChange:e=>h({...m,productionLines:Math.max(1,parseInt(e.target.value)||1)}),children:Array.from({length:50},(e,t)=>t+1).map(e=>I.jsx("option",{value:e,children:e},e))})]}),I.jsxs("div",{className:"blueprint-setting-item",children:[I.jsx("label",{children:"材料效率:"}),I.jsx("select",{value:m.materialEfficiency,disabled:a,onChange:e=>h({...m,materialEfficiency:parseInt(e.target.value)}),children:Array.from({length:11},(e,t)=>t).map(e=>I.jsx("option",{value:e,children:e},e))})]}),I.jsxs("div",{className:"blueprint-setting-item",children:[I.jsx("label",{children:"时间效率:"}),I.jsx("select",{value:m.timeEfficiency,disabled:a,onChange:e=>h({...m,timeEfficiency:parseInt(e.target.value)}),children:Array.from({length:11},(e,t)=>2*t).map(e=>I.jsx("option",{value:e,children:e},e))})]}),I.jsxs("div",{className:"blueprint-setting-item",children:[I.jsx("span",{className:"disabled-hint",children:"此处选项会覆盖设置中的默认效率，仅影响此蓝图"}),I.jsx("label",{style:{marginLeft:8},children:"缺货用Jita补齐:"}),I.jsx("input",{type:"checkbox",checked:F,onChange:e=>J(e.target.checked)})]})]})})(),I.jsx("div",{className:"output-info",children:(()=>{const a=(()=>{if(!t)return null;const a={...t,...m},s=e&&"item"===e.type?parseInt(e.id):null;if(!s)return null;const r=D.getBlueprintInfo(s);if(!r)return null;const i="reaction"===r.category,n={itemId:s,runs:1,materialEfficiency:a.materialEfficiency,timeEfficiency:a.timeEfficiency,structureType:i?a.refineStructure:a.complexStructure,rigType:i?a.reactionRig:a.complexRig,solarSystemId:i?a.refineSolarSystem:a.complexSolarSystem},c=se.calculateBonus(n);if(!c)return null;const l=e=>{const t=Math.round(1e5*e)/1e5;return t%1==0?t.toString():t.toFixed(5).replace(/\.?0+$/,"")},o=`${l(100*(1-c.materialBonus))}%`,u=`${l(100*(1-c.timeBonus))}%`,d=`${l(100*(1-c.costBonus))}%`;return{materialBonus:c.materialBonus,timeBonus:c.timeBonus,costBonus:c.costBonus,materialBonusText:o,timeBonusText:u,costBonusText:d,materialComponents:{blueprintME:c.blueprintME,structureME:c.structureME,rigSecurityBonus:c.rigSecurityBonus},timeComponents:{blueprintTE:c.blueprintTE,structureTE:c.structureTE},costComponents:{structureCost:c.structureCost,rigCost:c.rigCost}}})(),s=Se.outputQuantity*f;return I.jsxs("div",{className:"bonus-info-container",children:[I.jsxs("div",{className:"output-row",children:[I.jsxs("div",{className:"bonus-item",children:["产出数量: ",(e=>{const t=Math.round(1e5*e)/1e5;return t%1==0?t.toString():t.toFixed(5).replace(/\.?0+$/,"")})(s)]}),a&&I.jsxs(I.Fragment,{children:[I.jsxs("div",{className:"bonus-item",children:["材料加成: -",a.materialBonusText]}),I.jsxs("div",{className:"bonus-item",children:["时间加成: -",a.timeBonusText]}),I.jsxs("div",{className:"bonus-item",children:["成本加成: -",a.costBonusText]})]})]}),O&&I.jsxs("div",{className:"bonus-item product-price "+(O.isInsufficient?"insufficient":""),children:["产品售价: ",$(O.price),O.isInsufficient&&I.jsxs("span",{className:"insufficient-warning",children:["(订单不足: ",O.actualQuantity.toLocaleString(),"/",s.toLocaleString(),")"]})]}),L&&!O&&I.jsx("div",{className:"bonus-item product-price-loading",children:"计算产品售价中..."})]})})()})]})]})}),I.jsxs("div",{className:"materials-section",children:[I.jsxs("div",{className:"materials-header",children:[I.jsx("h4",{children:"材料需求"}),I.jsx("div",{className:"materials-header-actions",children:I.jsx("button",{className:"copy-button",onClick:()=>K(!0),title:"登记已有材料",children:"登记已有材料"})})]}),W&&I.jsx("div",{className:"existing-modal-overlay",onClick:()=>K(!1),children:I.jsxs("div",{className:"existing-modal",onClick:e=>e.stopPropagation(),children:[I.jsx("div",{className:"existing-modal-header",children:I.jsx("div",{className:"existing-modal-title",children:"登记已有材料"})}),I.jsx("div",{className:"existing-modal-body",children:I.jsx("textarea",{className:"existing-textarea",placeholder:"示例\n高密度黏土克里石*    1,965,821    克里石*            23,589.85 m3    819,177,268.91 星币\n重水*    12,500    冰矿产物*            5,000 m3    1,461,625.00 星币",value:H,onChange:e=>Y(e.target.value)})}),I.jsxs("div",{className:"existing-modal-footer",children:[I.jsx("button",{className:"existing-btn",onClick:()=>Y(""),children:"清空"}),I.jsx("button",{className:"existing-btn primary",onClick:()=>{const e=(e=>{const t=new Map,a=e.split(/\r?\n/);for(const s of a){const e=s.trim();if(!e)continue;const a=e.split(/\t+| {4,}/);if(a.length<2)continue;const r=(a[0]||"").replace(/\*+$/,"").trim(),i=(a[1]||"").replace(/,/g,"").trim(),n=parseFloat(i);if(!r||!isFinite(n))continue;const c=pe(r);t.set(c,(t.get(c)||0)+n)}return t})(H);Array.from(e.entries()).map(([e,t])=>({name:e,quantity:t}));ee(e),K(!1)},children:"确认"})]})]})}),I.jsx("div",{className:"materials-columns",children:Se.materialLevels.map(e=>{const t=C.find(t=>t.level===e.level);return I.jsxs("div",{className:"materials-column",children:[I.jsxs("div",{className:"materials-column-header",children:[I.jsxs("div",{className:"header-title-section",children:[I.jsxs("h5",{className:(null==t?void 0:t.materials.some(e=>e.isInsufficient))?"layer-title insufficient":"layer-title",children:["第",e.level,"层材料",(()=>{const t=e.materials.reduce((e,t)=>e+(t.totalVolume||0),0);return` (${a=t,a>=1e6?`${(a/1e6).toFixed(2)}M`:a>=1e3?`${(a/1e3).toFixed(2)}K`:a.toFixed(2)} m³)`;var a})()]}),I.jsxs("div",{className:"copy-buttons",children:[I.jsx("button",{className:"copy-button",onClick:()=>ae(e.level),title:"查看材料占比",children:I.jsx(n,{})}),I.jsx("button",{className:"copy-button",onClick:()=>{const t=(e=>{if(!Se)return[];const t=new Map,a=new Map,s=new Map,r=new Set,i=new Map;for(const u of Se.materialLevels){const e=i.get(u.level)||new Set;for(const i of u.materials)t.set(i.typeID,u.level),a.set(i.typeID,(a.get(i.typeID)||0)+(i.quantity||0)),s.set(i.typeID,i.typeName_zh),e.add(i.typeID),i.hasBlueprint&&!N.has(i.typeID)&&r.add(i.typeID);i.set(u.level,e)}if(0===r.size)return[];const n=new Set(Array.from(i.get(e)||new Set)),c=[],l=new Set;let o=1;for(;;){const i=[];if(r.forEach(a=>{if(l.has(a))return;if((t.get(a)||0)>=e)return;const s=D.getBlueprintInfo(a);if(!s||!s.materials)return;let r=!0;for(const e of s.materials){const t=e.typeId,a=Boolean(D.getBlueprintInfo(t)),s=N.has(t);if(!n.has(t)&&!s&&a){r=!1;break}}r&&i.push(a)}),0===i.length)break;const u=i.map(r=>{var i,n;const c=D.getBlueprintInfo(r),l="reaction"===(null==c?void 0:c.category);return{typeID:r,typeName:s.get(r)||(null==(n=null==(i=D.getEveData())?void 0:i.type_info[r.toString()])?void 0:n.zh_name)||`未知物品_${r}`,quantity:a.get(r)||0,level:t.get(r)||e,isReaction:Boolean(l)}}).sort((e,t)=>{const a=e.isReaction?1:0,s=t.isReaction?1:0;if(a!==s)return a-s;const r=t.level-e.level;return 0!==r?r:e.typeName.localeCompare(t.typeName)});c.push({round:o++,items:u}),i.forEach(e=>{l.add(e),n.add(e)})}return c})(e.level);de(t),oe(e.level)},title:"查看加工顺序",children:I.jsx(c,{})})]})]}),I.jsxs("div",{className:"copy-buttons",children:[t&&I.jsxs("div",{className:"level-total-price",children:["材料总价: ",$(t.totalPrice),t.facilityCost&&I.jsxs("div",{className:"level-facility-cost",children:["加工税费: ",$(t.facilityCost),I.jsxs("span",{className:"facility-cost-rate",children:["(税率: ",(100*t.totalTaxRate).toFixed(2),"%)"]})]}),"number"==typeof t.leftoverCumulativePrice&&I.jsxs("div",{className:"level-leftover-total",children:["总计结余材料: ",$(t.leftoverCumulativePrice),I.jsx("span",{className:"leftover-total-hint",children:"(抵减成本)"})]}),t.cumulativeFacilityCost&&t.cumulativeFacilityCost>0&&I.jsxs("div",{className:"level-cumulative-cost",children:["总计税费: ",$(t.cumulativeFacilityCost),I.jsx("span",{className:"cumulative-cost-hint",children:"(加工到产品的总税费)"})]}),"number"==typeof t.totalCost&&I.jsxs("div",{className:"level-total-cost-with-tax",children:["总成本: ",$(t.totalCost),I.jsx("span",{className:"total-cost-hint",children:"(材料总价-总计结余材料+总计税费)"})]})]}),R&&!t&&I.jsx("div",{className:"level-price-loading",children:"计算价格中..."})]})]}),I.jsxs("div",{className:"materials-list",ref:t=>{t&&b.current.set(e.level,t)},children:[I.jsxs("div",{className:"copy-buttons full",style:{padding:"4px 0 6px 0",width:"100%"},children:[I.jsxs("button",{className:"copy-button",style:{flex:1},onClick:()=>fe(e.materials,!1),title:"复制(中文)",children:[I.jsx(l,{})," 复制(中文)"]}),I.jsxs("button",{className:"copy-button",style:{flex:1},onClick:()=>fe(e.materials,!0),title:"复制(英文)",children:[I.jsx(o,{})," 复制(英文)"]})]}),e.materials.map(t=>xe(t,e.level)),e.leftoverProducts&&e.leftoverProducts.length>0&&I.jsxs(I.Fragment,{children:[I.jsx("div",{className:"leftover-separator",children:I.jsx("span",{className:"leftover-separator-text",children:"结余部分"})}),e.leftoverProducts.map(t=>{const a=D.getEveData(),s=null==a?void 0:a.type_info[t.typeID.toString()],r=(null==s?void 0:s.icon_name)?`./static/icons/${s.icon_name}`:`./static/icons/icon_${t.typeID}_64.png`,i=t.typeName||(null==s?void 0:s.zh_name)||`未知物品_${t.typeID}`;return I.jsxs("div",{className:"material-item leftover",style:{cursor:"default"},children:[I.jsx("div",{className:"material-icon",children:I.jsx(k,{src:r,alt:i,size:24,showLoadingIndicator:!0})}),I.jsx("div",{className:"material-info",children:I.jsxs("div",{className:"material-name",children:[i," × ",t.quantity.toLocaleString()]})}),I.jsx("div",{className:"material-volume",children:"-"}),I.jsx("div",{className:"material-blueprint-status",children:I.jsx("span",{className:"leftover-badge",children:"结余"})})]},`leftover-${e.level}-${t.typeID}`)})]})]})]},e.level)})})]}),null!=te&&(()=>{const{total:e,slices:t}=((e,t)=>{const a=["#4caf50","#2196f3","#ff9800","#e91e63","#9c27b0","#00bcd4","#8bc34a","#ffc107","#03a9f4","#ff5722","#795548","#607d8b","#cddc39","#673ab7","#009688"];if("price"===t){const t=C.find(t=>t.level===e);if(!t)return{total:0,slices:[]};const s=t.materials.map(e=>e.typeID),r=D.getMarketGroupNamesByTypeIds(s),i=new Map;for(const e of t.materials){const t=r.get(e.typeID)||"未分类",a=i.get(t)||0;i.set(t,a+e.price)}const n=Array.from(i.entries()).sort((e,t)=>t[1]-e[1]).map(([e,t],s)=>({label:e,value:t,color:a[s%a.length]}));return{total:n.reduce((e,t)=>e+t.value,0),slices:n}}{const t=null==Se?void 0:Se.materialLevels.find(t=>t.level===e);if(!t)return{total:0,slices:[]};const s=t.materials.map(e=>e.typeID),r=D.getMarketGroupNamesByTypeIds(s),i=new Map;for(const e of t.materials){const t=r.get(e.typeID)||"未分类",a=i.get(t)||0,s=(null!=e.totalVolume?e.totalVolume:(e.volume||0)*(e.quantity||0))||0;i.set(t,a+s)}const n=Array.from(i.entries()).sort((e,t)=>t[1]-e[1]).map(([e,t],s)=>({label:e,value:t,color:a[s%a.length]}));return{total:n.reduce((e,t)=>e+t.value,0),slices:n}}})(te,re),a=t.filter(e=>0===ne.size||ne.has(e.label)).reduce((e,t)=>e+t.value,0);return I.jsx("div",{className:"existing-modal-overlay",onClick:()=>ae(null),children:I.jsxs("div",{className:"existing-modal",onClick:e=>e.stopPropagation(),children:[I.jsx("div",{className:"existing-modal-header",children:I.jsxs("div",{className:"existing-modal-title",children:["第",te,"层 材料","price"===re?"成本":"体积","占比"]})}),I.jsx("div",{className:"existing-modal-body",children:I.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"},children:[I.jsx(ve,{width:240,height:240,data:t}),I.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[t.map((t,a)=>I.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,fontSize:12,cursor:"pointer",opacity:0===ne.size||ne.has(t.label)?1:.5},onClick:()=>{const e=new Set(ne);e.has(t.label)?e.delete(t.label):e.add(t.label),ce(e)},title:ne.has(t.label)?"点击取消选择":"点击选择",children:[I.jsx("span",{style:{display:"inline-block",width:10,height:10,background:t.color,borderRadius:2}}),I.jsx("span",{children:t.label}),I.jsxs("span",{style:{color:"#888"},children:["- ","price"===re?$(t.value):`${t.value.toFixed(2)} m³`]}),I.jsxs("span",{style:{color:"#888"},children:["(",(t.value/(e||1)*100).toFixed(2),"%)"]}),ne.has(t.label)&&I.jsx("span",{style:{color:"#52c41a"},children:"[选中]"})]},a)),I.jsxs("div",{style:{marginTop:6,fontSize:12,color:"#bbb",display:"flex",alignItems:"center",gap:8},children:[I.jsx("button",{className:"existing-btn",onClick:()=>ce(new Set),title:"清空选择",children:"清空选择"}),I.jsxs("span",{children:["已选合计: ","price"===re?$(a):`${a.toFixed(2)} m³`," (",(a/(e||1)*100).toFixed(2),"%)"]})]})]})]})}),I.jsxs("div",{className:"existing-modal-footer",children:[I.jsxs("button",{className:"existing-btn",onClick:()=>ie("price"===re?"volume":"price"),children:["切换为","price"===re?"体积占比":"成本占比"]}),I.jsx("button",{className:"existing-btn",onClick:()=>ae(null),children:"关闭"})]})]})})})(),null!=le&&I.jsx("div",{className:"existing-modal-overlay",onClick:()=>oe(null),children:I.jsxs("div",{className:"existing-modal",onClick:e=>e.stopPropagation(),children:[I.jsx("div",{className:"existing-modal-header",children:I.jsxs("div",{className:"existing-modal-title",children:["从第",le,"层开始的加工顺序"]})}),I.jsxs("div",{className:"existing-modal-body",style:{maxHeight:420,overflowY:"auto"},children:[I.jsx("div",{style:{fontSize:12,color:"#bbb",lineHeight:1.6,marginBottom:8},children:"说明：从所选层的材料视为已具备，凡依赖已满足（含直接采购与不拆解）的上层产品，可在同一轮并行加工。"}),0===ue.length?I.jsx("div",{style:{fontSize:13,color:"#999"},children:"无可加工项"}):ue.map(e=>I.jsxs("div",{style:{marginBottom:12},children:[I.jsxs("div",{style:{fontWeight:600,marginBottom:6},children:["第",e.round,"轮："]}),I.jsx("div",{style:{display:"flex",flexDirection:"column",gap:6},children:e.items.map(t=>{const a=D.getEveData(),s=null==a?void 0:a.type_info[t.typeID.toString()],r=(null==s?void 0:s.icon_name)?`./static/icons/${s.icon_name}`:`./static/icons/icon_${t.typeID}_64.png`;return I.jsxs("div",{className:"material-item",style:{cursor:"default"},children:[I.jsx("div",{className:"material-icon",children:I.jsx(k,{src:r,alt:t.typeName,size:24,showLoadingIndicator:!0})}),I.jsx("div",{className:"material-info",children:I.jsxs("div",{className:"material-name",children:[t.typeName," × ",t.quantity.toLocaleString()," ",I.jsxs("span",{style:{color:"#888",marginLeft:6},children:["(第",t.level,"层)"]})]})}),I.jsx("div",{className:"material-volume",children:"-"}),I.jsx("div",{className:"material-blueprint-status",children:t.isReaction?I.jsx("span",{className:"reaction-badge",children:"反应"}):I.jsx("span",{className:"blueprint-badge",children:"蓝图"})})]},`${e.round}-${t.typeID}`)})})]},e.round))]}),I.jsx("div",{className:"existing-modal-footer",children:I.jsx("button",{className:"existing-btn",onClick:()=>oe(null),children:"关闭"})})]})})]}):I.jsx("div",{className:"blueprint-view",children:I.jsxs("div",{className:"no-blueprint",children:[I.jsx("div",{className:"no-blueprint-icon",children:"⚠️"}),I.jsx("div",{className:"no-blueprint-text",children:"此物品没有制造蓝图"})]})}):I.jsx("div",{className:"blueprint-view",children:I.jsxs("div",{className:"no-selection",children:[I.jsx("div",{className:"no-selection-icon",children:"📋"}),I.jsx("div",{className:"no-selection-text",children:"请从左侧选择一个物品"})]})})},ie=({isOpen:e,onClose:t,onAuthSuccess:s,currentToken:r,currentCharacter:i})=>{const[n,c]=a.useState(!1),[l,o]=a.useState(null);a.useEffect(()=>{},[e]);return e?I.jsx("div",{className:"auth-overlay",children:I.jsxs("div",{className:"auth-modal",children:[I.jsxs("div",{className:"auth-header",children:[I.jsx("h2",{children:"EVE Online 认证"}),I.jsx("button",{className:"auth-close",onClick:t,children:"✕"})]}),I.jsxs("div",{className:"auth-content",children:[l&&I.jsxs("div",{className:"auth-error",children:[I.jsx("div",{className:"error-icon",children:"⚠️"}),I.jsx("div",{className:"error-text",children:l})]}),r&&i?I.jsxs("div",{className:"auth-success",children:[I.jsxs("div",{className:"character-info",children:[I.jsx("div",{className:"character-avatar",children:I.jsx("img",{src:`https://images.evetech.net/characters/${i.CharacterID}/portrait?size=64`,alt:"角色头像"})}),I.jsxs("div",{className:"character-details",children:[I.jsx("h3",{children:i.CharacterName}),I.jsx("p",{className:"character-status",children:"已认证"}),I.jsxs("p",{className:"character-id",children:["角色ID: ",i.CharacterID]})]})]}),I.jsx("div",{className:"auth-actions",children:I.jsx("button",{className:"auth-button-logout",onClick:()=>{s("","",null),t()},children:"退出登录"})})]}):I.jsxs("div",{className:"auth-login",children:[I.jsxs("div",{className:"auth-description",children:[I.jsx("p",{children:"通过EVE Online SSO进行认证，获取以下权限："}),I.jsxs("ul",{children:[I.jsx("li",{children:"搜索建筑信息"}),I.jsx("li",{children:"访问建筑市场数据"})]})]}),I.jsx("div",{className:"auth-actions",children:n?I.jsxs("div",{className:"auth-loading",children:[I.jsx("div",{className:"loading-spinner"}),I.jsx("span",{children:"正在处理..."})]}):I.jsx("button",{className:"auth-button-login",onClick:async()=>{c(!0),o(null);try{const{authUrl:e}=await O();window.location.href=e}catch(e){o(e instanceof Error?e.message:"启动认证失败"),c(!1)}},children:I.jsx("img",{src:"./eve_auth.png",alt:"EVE"})})})]})]})]})}):null};const ne=new class{constructor(){t(this,"cacheKey","eve_structure_info_cache"),t(this,"cacheExpiryMinutes",30)}getCachedStructureInfo(e){try{const t=this.loadCache(),a=t[e.toString()];return a?Date.now()>a.expiresAt?(delete t[e.toString()],this.saveCache(t),null):a:null}catch(t){return null}}getCachedStructureName(e){const t=this.getCachedStructureInfo(e);return t?t.name:null}cacheStructureInfo(e,t,a){try{const s=this.loadCache(),r=Date.now(),i=r+60*this.cacheExpiryMinutes*1e3;s[e.toString()]={structure_id:e,name:t,type_id:a,timestamp:r,expiresAt:i},this.saveCache(s)}catch(s){}}cacheStructureName(e,t){this.cacheStructureInfo(e,t,0)}cacheStructureInfos(e){try{const t=this.loadCache(),a=Date.now(),s=a+60*this.cacheExpiryMinutes*1e3;e.forEach(e=>{t[e.structure_id.toString()]={structure_id:e.structure_id,name:e.name,type_id:e.type_id,timestamp:a,expiresAt:s}}),this.saveCache(t)}catch(t){}}cacheStructureNames(e){const t=e.map(e=>({structure_id:e.structure_id,name:e.name,type_id:0}));this.cacheStructureInfos(t)}cleanExpiredCache(){try{const e=this.loadCache(),t=Date.now();let a=0;Object.keys(e).forEach(s=>{e[s].expiresAt<=t&&(delete e[s],a++)}),a>0&&this.saveCache(e)}catch(e){}}getCacheStats(){try{const e=this.loadCache(),t=Date.now();let a=0,s=0,r=0;return Object.values(e).forEach(e=>{a++,e.expiresAt<=t?s++:r++}),{total:a,expired:s,valid:r}}catch(e){return{total:0,expired:0,valid:0}}}clearAllCache(){try{localStorage.removeItem(this.cacheKey)}catch(e){}}loadCache(){try{const e=localStorage.getItem(this.cacheKey);return e?JSON.parse(e):{}}catch(e){return{}}}saveCache(e){try{localStorage.setItem(this.cacheKey,JSON.stringify(e))}catch(t){}}};const ce=new class{constructor(){t(this,"baseUrl","https://esi.evetech.net/latest")}async searchStructures(e,t,a){if(!e||!t||!a)throw new Error("缺少必要参数：角色ID、搜索关键词或访问令牌");try{const s=`${this.baseUrl}/characters/${e}/search/?categories=structure&search=${encodeURIComponent(t)}`,r=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${a}`,"User-Agent":"EVE Blueprint Calculator"}});if(!r.ok){if(401===r.status)throw new Error("认证失败，请重新登录");if(403===r.status)throw new Error("没有权限访问建筑搜索");if(404===r.status)return[];throw new Error(`搜索失败: ${r.status} ${r.statusText}`)}return(await r.json()).structure||[]}catch(s){if(s instanceof Error)throw s;throw new Error(`搜索建筑时发生错误: ${s}`)}}async getStructureInfo(e,t){if(!e||!t)throw new Error("缺少必要参数：建筑ID或访问令牌");try{const s=`${this.baseUrl}/universe/structures/${e}/`,r=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${t}`,"User-Agent":"EVE Blueprint Calculator"}});if(!r.ok){if(404===r.status)return null;throw new Error(`获取建筑信息失败: ${r.status} ${r.statusText}`)}const i=await r.json();let n;try{const{dataService:e}=await w(async()=>{const{dataService:e}=await Promise.resolve().then(()=>M);return{dataService:e}},void 0,import.meta.url),t=e.getEveData(),a=null==t?void 0:t.type_info[i.type_id.toString()];n=(null==a?void 0:a.icon_name)||void 0}catch(a){}return{structure_id:e,name:i.name,type_id:i.type_id,solar_system_id:i.solar_system_id,icon_name:n}}catch(a){if(a instanceof Error)throw a;throw new Error(`获取建筑信息时发生错误: ${a}`)}}async getStructuresInfo(e,t){const a=[],s=[];for(const i of e){const e=ne.getCachedStructureInfo(i);if(e){let t;try{const{dataService:a}=await w(async()=>{const{dataService:e}=await Promise.resolve().then(()=>M);return{dataService:e}},void 0,import.meta.url),s=a.getEveData(),r=null==s?void 0:s.type_info[e.type_id.toString()];t=(null==r?void 0:r.icon_name)||void 0}catch(r){}a.push({structure_id:i,name:e.name,type_id:e.type_id,solar_system_id:0,icon_name:t})}else s.push(i)}if(s.length>0){const e=5;for(let i=0;i<s.length;i+=e){const n=s.slice(i,i+e).map(e=>this.getStructureInfo(e,t));try{const e=await Promise.allSettled(n),t=[];e.forEach(e=>{"fulfilled"===e.status&&e.value&&(a.push(e.value),t.push(e.value))}),t.length>0&&ne.cacheStructureInfos(t)}catch(r){}i+e<s.length&&await new Promise(e=>setTimeout(e,100))}}return a}getCachedStructureName(e){return ne.getCachedStructureName(e)}getCachedStructureInfo(e){return ne.getCachedStructureInfo(e)}};function le(){const[e,t]=a.useState([]),[s,r]=a.useState(!0),[i,n]=a.useState(null),[c,l]=a.useState(null),[o,u]=a.useState(300),[d,m]=a.useState(!1),[h,p]=a.useState(!1),[y,f]=a.useState(!1),[g,v]=a.useState(null),[x,S]=a.useState(null),[j,N]=a.useState(null),[_,b]=a.useState(()=>{const e=localStorage.getItem("eve-blueprint-settings");if(e)try{const t=JSON.parse(e);return{materialEfficiency:t.materialEfficiency??0,timeEfficiency:t.timeEfficiency??0,complexStructure:t.complexStructure??"none",complexRig:t.complexRig??"none",complexSolarSystem:t.complexSolarSystem??null,complexTax:t.complexTax??0,refineStructure:t.refineStructure??"none",reactionRig:t.reactionRig??"none",refineSolarSystem:t.refineSolarSystem??null,reactionTax:t.reactionTax??0,marketType:t.marketType??"region",marketSelection:t.marketSelection??"10000002",structureMarketId:t.structureMarketId??null,runs:t.runs??1,considerOrderVolume:t.considerOrderVolume??!0}}catch(t){}return{materialEfficiency:0,timeEfficiency:0,complexStructure:"none",complexRig:"none",complexSolarSystem:null,complexTax:0,refineStructure:"none",reactionRig:"none",refineSolarSystem:null,reactionTax:0,marketType:"region",marketSelection:"10000002",structureMarketId:null,runs:1,considerOrderVolume:!0}}),[k,E]=a.useState(""),[T,M]=a.useState(""),[$,R]=a.useState([]),[P,B]=a.useState([]),[O,A]=a.useState(_),[z,Q]=a.useState(""),[J,W]=a.useState([]),[K,H]=a.useState(!1),[G,X]=a.useState(null),[te,ae]=a.useState(!1),[se,le]=a.useState(null),[oe,ue]=a.useState(null);a.useEffect(()=>{de(),ne.cleanExpiredCache()},[]),a.useEffect(()=>{U.init();const e=U.subscribe(e=>{v(e.accessToken),S(e.refreshToken),N(e.character),ae(e.isRefreshing),le(e.remainingMinutes)});return()=>{e(),U.destroy()}},[]),a.useEffect(()=>{h&&A(_)},[h,_]),a.useEffect(()=>{(async()=>{if("structure"===_.marketType&&_.structureMarketId){const t=ne.getCachedStructureInfo(_.structureMarketId);if(t)return void ue(t.name);if(g)try{const e=await ce.getStructureInfo(_.structureMarketId,g);e?(ue(e.name),ne.cacheStructureInfo(_.structureMarketId,e.name,e.type_id)):ue(`建筑 ${_.structureMarketId}`)}catch(e){ue(`建筑 ${_.structureMarketId}`)}else ue(`建筑 ${_.structureMarketId}`)}else ue(null)})()},[_.marketType,_.structureMarketId,g]);const de=async()=>{try{r(!0),n(null),await Promise.all([D.loadEveData(),Y.loadConfig(),Z.loadData(),ee.loadSystemsData(),w(async()=>{const{initializeEveOAuth:e}=await Promise.resolve().then(()=>F);return{initializeEveOAuth:e}},void 0,import.meta.url).then(({initializeEveOAuth:e})=>e())]);const e=D.buildTree();t(e)}catch(e){n(e instanceof Error?e.message:"加载数据失败")}finally{r(!1)}},me=e=>{if(d){const t=e.clientX;t>200&&t<600&&u(t)}},he=()=>{m(!1)},pe=()=>{A(_),p(!1)},ye=(e,t,a)=>{U.setTokens(e,t),U.setCharacter(a),f(!1)},fe=async()=>{if(z.trim())if(g&&(null==j?void 0:j.CharacterID)){H(!0),X(null),W([]);try{const e=await ce.searchStructures(j.CharacterID,z,g);if(0===e.length)return void X("未找到匹配的建筑");const t=await ce.getStructuresInfo(e,g);W(t),0===t.length&&X("获取建筑信息失败")}catch(e){X(e instanceof Error?e.message:"搜索失败")}finally{H(!1)}}else X("请先登录EVE账号");else X("请输入搜索关键词")},ge=async()=>{if(g&&x&&!te)try{ae(!0);const t=await V(g,x,()=>{});if(t.needsRefresh){v(t.accessToken),S(t.refreshToken),localStorage.setItem("eve_auth_token",t.accessToken),localStorage.setItem("eve_auth_refresh_token",t.refreshToken);try{const{getCharacterInfo:e}=await w(async()=>{const{getCharacterInfo:e}=await Promise.resolve().then(()=>F);return{getCharacterInfo:e}},void 0,import.meta.url),a=await e(t.accessToken);N(a),localStorage.setItem("eve_auth_character",JSON.stringify(a))}catch(e){}}}catch(e){}finally{ae(!1)}},ve=()=>{if(g){const e=L(g);le(e)}else le(null)};return a.useEffect(()=>{let e=null,t=null,a=null;if("/auth/callback"===window.location.pathname){const s=new URLSearchParams(window.location.search);e=s.get("code"),t=s.get("state"),a=s.get("error")}else if(window.location.hash.includes("#/auth/callback")){const s=new URLSearchParams(window.location.hash.split("?")[1]);e=s.get("code"),t=s.get("state"),a=s.get("error")}if(e||t||a||"/auth/callback"===window.location.pathname||"/EVE_BP_Calc/auth/callback"===window.location.pathname||window.location.hash.includes("#/auth/callback")){if(a){const e=window.location.pathname.includes("/EVE_BP_Calc")?"/EVE_BP_Calc/":"/";return void window.history.replaceState({},document.title,e)}if(e&&t)w(async()=>{const{handleOAuthCallback:e,getCharacterInfo:t}=await Promise.resolve().then(()=>F);return{handleOAuthCallback:e,getCharacterInfo:t}},void 0,import.meta.url).then(({handleOAuthCallback:a,getCharacterInfo:s})=>{a(e,t).then(e=>s(e.access_token).then(t=>{ye(e.access_token,e.refresh_token,t);const a=window.location.pathname.includes("/EVE_BP_Calc")?"/EVE_BP_Calc/":"/";window.history.replaceState({},document.title,a)})).catch(e=>{const t=window.location.pathname.includes("/EVE_BP_Calc")?"/EVE_BP_Calc/":"/";window.history.replaceState({},document.title,t)})});else{const e=window.location.pathname.includes("/EVE_BP_Calc")?"/EVE_BP_Calc/":"/";window.history.replaceState({},document.title,e)}}},[]),a.useEffect(()=>{if(!g||!x)return;ve(),q(g,2)&&ge();const e=setInterval(()=>{ve(),g&&q(g,2)&&!te&&ge()},6e4);return()=>{clearInterval(e)}},[g,x]),a.useEffect(()=>{ve()},[g]),a.useEffect(()=>{if(d)return document.addEventListener("mousemove",me),document.addEventListener("mouseup",he),()=>{document.removeEventListener("mousemove",me),document.removeEventListener("mouseup",he)}},[d]),s?I.jsx("div",{className:"app",children:I.jsxs("div",{className:"loading",children:[I.jsx("div",{className:"loading-spinner"}),I.jsx("div",{className:"loading-text",children:"加载中..."})]})}):i?I.jsx("div",{className:"app",children:I.jsxs("div",{className:"error",children:[I.jsx("div",{className:"error-icon",children:"⚠️"}),I.jsx("div",{className:"error-text",children:i}),I.jsx("button",{className:"error-retry",onClick:de,children:"重试"})]})}):I.jsxs("div",{className:"app",children:[I.jsxs("div",{className:"app-header",children:[I.jsx("h1",{children:"EVE蓝图计算器"}),I.jsxs("div",{className:"header-right",children:[_&&I.jsx("div",{className:"header-details",children:I.jsxs("div",{className:"settings-summary",children:[I.jsxs("div",{className:"settings-row",children:[I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"材料效率:"}),I.jsx("span",{className:"settings-value",children:_.materialEfficiency})]}),I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"时间效率:"}),I.jsx("span",{className:"settings-value",children:_.timeEfficiency})]}),I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"市场:"}),I.jsx("span",{className:"settings-value",children:(()=>{if("structure"===_.marketType&&oe)return oe;if("structure"===_.marketType&&_.structureMarketId)return`建筑 ${_.structureMarketId}`;return{10000002:"Jita",10000043:"Amarr",10000032:"Dodixie",10000042:"Hek",10000030:"Rens"}[_.marketSelection]||_.marketSelection})()})]})]}),I.jsxs("div",{className:"settings-row",children:[I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"加工建筑:"}),I.jsxs("span",{className:"settings-value",children:["none"!==_.complexStructure?_.complexStructure:"无","none"!==_.complexRig&&` + ${_.complexRig.toUpperCase()}`]})]}),I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"制造加成:"}),I.jsx("span",{className:"settings-value",children:(()=>{const e=Y.getConfig();if(!e)return"无数据";let t=1,a=1,s=1,r=1,i=1,n=1,c=1;if("none"!==_.complexStructure){const s=e.structure.complex.find(e=>e.name===_.complexStructure);s&&(t=s.ME,a=s.Cost)}if("none"!==_.complexRig){const t=e["complex-rigs"][_.complexRig];t&&(s=t.ME,r=t.Cost,i=t.hs,n=t.ls,c=t.ns)}let l=1;if(_.complexSolarSystem&&"none"!==_.complexRig){const e=Z.getSolarSystemById(_.complexSolarSystem);if(e){const t=e.display_security;l=t>=.5?1-i*(1-s):t>=0?1-n*(1-s):1-c*(1-s)}}const o=a*r,u=e=>{const t=Math.round(1e5*e)/1e5;return t%1==0?t.toString():t.toFixed(5).replace(/\.?0+$/,"")};return`材料 -${u(100*(1-t*("none"!==_.complexRig?l:1)))}%, 成本 -${u(100*(1-o))}%`})()})]}),_.complexSolarSystem&&I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"加工星系:"}),I.jsx("span",{className:"settings-value",children:(()=>{const e=Z.getDisplayNameWithSecurity(_.complexSolarSystem);return e?I.jsxs(I.Fragment,{children:[I.jsx("span",{className:"security-badge-small",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]}):"未知星系"})()})]}),_.complexSolarSystem&&I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"制造系数:"}),I.jsx("span",{className:"settings-value",children:(()=>{const e=ee.getManufacturingCostIndex(_.complexSolarSystem);return null===e?"未知":ee.formatCostIndex(e)})()})]}),_.complexTax>0&&I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"加工税率:"}),I.jsxs("span",{className:"settings-value",children:[_.complexTax,"%"]})]})]}),I.jsxs("div",{className:"settings-row",children:[I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"反应建筑:"}),I.jsxs("span",{className:"settings-value",children:["none"!==_.refineStructure?_.refineStructure:"无","none"!==_.reactionRig&&` + ${_.reactionRig.toUpperCase()}`]})]}),I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"反应加成:"}),I.jsx("span",{className:"settings-value",children:(()=>{const e=Y.getConfig();if(!e)return"无数据";let t=1,a=1,s=1,r=1,i=1,n=1,c=1;if("none"!==_.refineStructure){const s=e.structure.refine.find(e=>e.name===_.refineStructure);s&&(t=s.ME,a=s.Cost)}if("none"!==_.reactionRig){const t=e["reaction-rigs"][_.reactionRig];t&&(s=t.ME,r=t.Cost,i=t.hs,n=t.ls,c=t.ns)}let l=1;if(_.refineSolarSystem&&"none"!==_.reactionRig){const e=Z.getSolarSystemById(_.refineSolarSystem);if(e){const t=e.display_security;l=t>=.5?1-i*(1-s):t>=0?1-n*(1-s):1-c*(1-s)}}const o=a*r,u=e=>{const t=Math.round(1e5*e)/1e5;return t%1==0?t.toString():t.toFixed(5).replace(/\.?0+$/,"")};return`材料 -${u(100*(1-t*("none"!==_.reactionRig?l:1)))}%, 成本 -${u(100*(1-o))}%`})()})]}),_.refineSolarSystem&&I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"反应星系:"}),I.jsx("span",{className:"settings-value",children:(()=>{const e=Z.getDisplayNameWithSecurity(_.refineSolarSystem);return e?I.jsxs(I.Fragment,{children:[I.jsx("span",{className:"security-badge-small",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]}):"未知星系"})()})]}),_.refineSolarSystem&&I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"反应系数:"}),I.jsx("span",{className:"settings-value",children:(()=>{const e=ee.getReactionCostIndex(_.refineSolarSystem);return null===e?"未知":ee.formatCostIndex(e)})()})]}),_.reactionTax>0&&I.jsxs("div",{className:"settings-item",children:[I.jsx("span",{className:"settings-label",children:"反应税率:"}),I.jsxs("span",{className:"settings-value",children:[_.reactionTax,"%"]})]})]})]})}),I.jsxs("div",{className:"header-actions",children:[g&&j?I.jsx("div",{className:"user-menu",children:I.jsxs("div",{className:"user-info",children:[null!==se&&I.jsx("div",{className:"token-status",children:te?I.jsx("span",{className:"token-refreshing",children:"[!] 刷新中..."}):se<=2?I.jsxs("span",{className:"token-expiring",children:["[!] ",se,"分钟"]}):I.jsxs("span",{className:"token-valid",children:[se,"分钟"]})}),I.jsx("button",{className:"user-avatar-button",onClick:()=>f(!0),title:`${j.CharacterName} - 点击查看账户信息`,children:I.jsx("img",{src:`https://images.evetech.net/characters/${j.CharacterID}/portrait?size=32`,alt:j.CharacterName,className:"user-avatar"})})]})}):I.jsx("button",{className:"auth-button",onClick:()=>f(!0),title:"EVE认证",children:I.jsx("img",{src:"./eve_auth.png",alt:"EVE认证"})}),I.jsx("button",{className:"settings-button",onClick:()=>p(!0),title:"设置",children:"⚙️"})]})]})]}),I.jsxs("div",{className:"app-content",children:[I.jsxs("div",{className:"sidebar",style:{width:`${o}px`},children:[I.jsx("div",{className:"sidebar-header",children:I.jsx("h2",{children:"物品目录"})}),I.jsx("div",{className:"sidebar-content",children:I.jsx(C,{nodes:e,onNodeSelect:e=>{l(e)}})})]}),I.jsx("div",{className:"resize-handle "+(d?"resizing":""),onMouseDown:e=>{m(!0),e.preventDefault()}}),I.jsx("div",{className:"main-content",children:I.jsx("div",{className:"content-body",children:I.jsx(re,{selectedNode:c,settings:_,authToken:g})})})]}),h&&I.jsx("div",{className:"settings-overlay",children:I.jsxs("div",{className:"settings-modal",children:[I.jsxs("div",{className:"settings-header",children:[I.jsx("h2",{children:"设置"}),I.jsx("button",{className:"settings-close",onClick:pe,children:"✕"})]}),I.jsxs("div",{className:"settings-layout",children:[I.jsxs("div",{className:"settings-content",children:[I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"默认蓝图材料效率:"}),I.jsx("select",{value:O.materialEfficiency,onChange:e=>A({...O,materialEfficiency:parseInt(e.target.value)}),children:Array.from({length:11},(e,t)=>t).map(e=>I.jsx("option",{value:e,children:e},e))})]}),I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"默认蓝图时间效率:"}),I.jsx("select",{value:O.timeEfficiency,onChange:e=>A({...O,timeEfficiency:parseInt(e.target.value)}),children:Array.from({length:11},(e,t)=>2*t).map(e=>I.jsx("option",{value:e,children:e},e))})]}),I.jsxs("div",{className:"setting-group",children:[I.jsx("h3",{children:"默认加工建筑"}),I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"建筑名称:"}),I.jsx("select",{value:O.complexStructure,onChange:e=>A({...O,complexStructure:e.target.value}),children:Y.getComplexStructures().map(e=>I.jsx("option",{value:e.value,children:e.name},e.value))})]}),I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"插件:"}),I.jsx("select",{value:O.complexRig,onChange:e=>A({...O,complexRig:e.target.value}),children:Y.getComplexRigs().map(e=>I.jsx("option",{value:e.value,children:e.name},e.value))})]}),I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"星系:"}),I.jsxs("div",{className:"solar-system-input",children:[I.jsx("input",{type:"text",placeholder:"输入至少2个字符搜索星系",value:k,onChange:e=>(e=>{if(E(e),e.length>=2){const t=Z.searchSolarSystems(e);R(t)}else R([])})(e.target.value)}),$.length>0&&I.jsx("div",{className:"solar-system-results",children:$.map(e=>I.jsxs("div",{className:"solar-system-result-item",onClick:()=>{return t=e.id,A({...O,complexSolarSystem:t}),E(""),void R([]);var t},children:[I.jsx("span",{className:"security-badge",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]},e.id))}),O.complexSolarSystem&&I.jsxs("div",{className:"selected-solar-system",children:["已选择: ",(()=>{const e=Z.getDisplayNameWithSecurity(O.complexSolarSystem);return e?I.jsxs(I.Fragment,{children:[I.jsx("span",{className:"security-badge",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]}):"未知星系"})()]})]})]}),I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"设施税:"}),I.jsx("input",{type:"number",min:"0",max:"100",value:O.complexTax,onChange:e=>A({...O,complexTax:Math.min(100,Math.max(0,parseInt(e.target.value)||0))}),placeholder:"0-100"})]})]}),I.jsxs("div",{className:"setting-group",children:[I.jsx("h3",{children:"默认反应建筑"}),I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"建筑名称:"}),I.jsx("select",{value:O.refineStructure,onChange:e=>A({...O,refineStructure:e.target.value}),children:Y.getRefineStructures().map(e=>I.jsx("option",{value:e.value,children:e.name},e.value))})]}),I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"插件:"}),I.jsx("select",{value:O.reactionRig,onChange:e=>A({...O,reactionRig:e.target.value}),children:Y.getReactionRigs().map(e=>I.jsx("option",{value:e.value,children:e.name},e.value))})]}),I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"星系:"}),I.jsxs("div",{className:"solar-system-input",children:[I.jsx("input",{type:"text",placeholder:"输入至少2个字符搜索星系",value:T,onChange:e=>(e=>{if(M(e),e.length>=2){const t=Z.searchSolarSystems(e);B(t)}else B([])})(e.target.value)}),P.length>0&&I.jsx("div",{className:"solar-system-results",children:P.map(e=>I.jsxs("div",{className:"solar-system-result-item",onClick:()=>{return t=e.id,A({...O,refineSolarSystem:t}),M(""),void B([]);var t},children:[I.jsx("span",{className:"security-badge",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]},e.id))}),O.refineSolarSystem&&I.jsxs("div",{className:"selected-solar-system",children:["已选择: ",(()=>{const e=Z.getDisplayNameWithSecurity(O.refineSolarSystem);return e?I.jsxs(I.Fragment,{children:[I.jsx("span",{className:"security-badge",style:{backgroundColor:e.securityColor},children:e.displaySecurity.toFixed(1)}),e.displayName]}):"未知星系"})()]})]})]}),I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"设施税:"}),I.jsx("input",{type:"number",min:"0",max:"100",value:O.reactionTax,onChange:e=>A({...O,reactionTax:Math.min(100,Math.max(0,parseInt(e.target.value)||0))}),placeholder:"0-100"})]})]}),I.jsxs("div",{className:"setting-group",children:[I.jsx("h3",{children:"价格计算设置"}),I.jsxs("div",{className:"setting-item",children:[I.jsx("label",{children:"考虑订单数量:"}),I.jsx("input",{type:"checkbox",checked:O.considerOrderVolume,onChange:e=>A({...O,considerOrderVolume:e.target.checked})}),I.jsx("span",{className:"setting-description",children:O.considerOrderVolume?"开启：按实际订单分配计算价格（更准确）":"关闭：使用最低价格×需求量计算（更快速）"})]})]})]}),I.jsxs("div",{className:"settings-sidebar",children:[I.jsxs("div",{className:"sidebar-content",children:[I.jsx("h3",{children:"市场选择"}),I.jsxs("div",{className:"market-selector",children:[I.jsx("div",{className:"market-option",children:I.jsxs("label",{className:"market-radio-item",children:[I.jsx("input",{type:"radio",name:"sidebarMarketSelection",value:"10000002",checked:"region"===O.marketType&&"10000002"===O.marketSelection,onChange:e=>A({...O,marketType:"region",marketSelection:e.target.value,structureMarketId:null})}),I.jsx("div",{className:"market-option-content",children:I.jsx("div",{className:"market-name",children:"Jita"})})]})}),I.jsx("div",{className:"market-option",children:I.jsxs("label",{className:"market-radio-item",children:[I.jsx("input",{type:"radio",name:"sidebarMarketSelection",value:"10000043",checked:"region"===O.marketType&&"10000043"===O.marketSelection,onChange:e=>A({...O,marketType:"region",marketSelection:e.target.value,structureMarketId:null})}),I.jsx("div",{className:"market-option-content",children:I.jsx("div",{className:"market-name",children:"Amarr"})})]})}),I.jsx("div",{className:"market-option",children:I.jsxs("label",{className:"market-radio-item",children:[I.jsx("input",{type:"radio",name:"sidebarMarketSelection",value:"10000032",checked:"region"===O.marketType&&"10000032"===O.marketSelection,onChange:e=>A({...O,marketType:"region",marketSelection:e.target.value,structureMarketId:null})}),I.jsx("div",{className:"market-option-content",children:I.jsx("div",{className:"market-name",children:"Dodixie"})})]})}),I.jsx("div",{className:"market-option",children:I.jsxs("label",{className:"market-radio-item",children:[I.jsx("input",{type:"radio",name:"sidebarMarketSelection",value:"10000042",checked:"region"===O.marketType&&"10000042"===O.marketSelection,onChange:e=>A({...O,marketType:"region",marketSelection:e.target.value,structureMarketId:null})}),I.jsx("div",{className:"market-option-content",children:I.jsx("div",{className:"market-name",children:"Hek"})})]})}),I.jsx("div",{className:"market-option",children:I.jsxs("label",{className:"market-radio-item",children:[I.jsx("input",{type:"radio",name:"sidebarMarketSelection",value:"10000030",checked:"region"===O.marketType&&"10000030"===O.marketSelection,onChange:e=>A({...O,marketType:"region",marketSelection:e.target.value,structureMarketId:null})}),I.jsx("div",{className:"market-option-content",children:I.jsx("div",{className:"market-name",children:"Rens"})})]})})]})]}),I.jsxs("div",{className:"sidebar-content",style:{marginTop:"20px"},children:[I.jsx("h3",{children:"市场建筑搜索"}),I.jsxs("div",{className:"structure-search-section",children:[I.jsxs("div",{className:"structure-search-form",children:[I.jsxs("div",{className:"search-input-wrapper",children:[I.jsx("input",{type:"text",className:"structure-search-input",placeholder:"输入建筑名称关键词...",value:z,onChange:e=>Q(e.target.value),onKeyPress:e=>{"Enter"===e.key&&fe()}}),I.jsx("button",{className:"structure-search-button",onClick:fe,disabled:K||!g,children:K?"搜索中...":"搜索"})]}),z&&I.jsx("button",{className:"structure-clear-button",onClick:()=>{Q(""),W([]),X(null)},children:"清空"})]}),!g&&I.jsx("div",{className:"structure-search-notice",children:I.jsx("p",{children:"请先登录EVE账号以搜索市场建筑"})}),G&&I.jsx("div",{className:"structure-search-error",children:I.jsxs("p",{children:["[x] ",G]})}),J.length>0&&I.jsxs("div",{className:"structure-search-results",children:[I.jsxs("div",{className:"structure-results-header",children:[I.jsxs("h4",{children:["搜索结果 (",J.length,")"]}),I.jsx("button",{className:"structure-cache-clear-button",onClick:()=>{ne.clearAllCache()},title:"清除建筑信息缓存",children:"清除缓存"})]}),I.jsx("div",{className:"structure-list",children:J.map(e=>I.jsx("div",{className:"structure-item "+("structure"===O.marketType&&O.structureMarketId===e.structure_id?"selected":""),onClick:()=>{return t=e.structure_id,void A({...O,marketType:"structure",structureMarketId:t});var t},children:I.jsxs("div",{className:"structure-item-content",children:[I.jsxs("div",{className:"structure-icon",children:[e.icon_name?I.jsx("img",{src:`./static/icons/${e.icon_name}`,alt:"建筑图标",className:"structure-icon-img",onError:e=>{var t;const a=e.target;a.style.display="none",null==(t=a.nextElementSibling)||t.classList.remove("hidden")}}):null,I.jsx("div",{className:"structure-default-icon "+(e.icon_name?"hidden":""),children:"🏢"})]}),I.jsx("div",{className:"structure-info",children:I.jsx("div",{className:"structure-name",children:e.name})}),"structure"===O.marketType&&O.structureMarketId===e.structure_id&&I.jsx("div",{className:"structure-selected-indicator",children:"✓"})]})},e.structure_id))})]})]})]})]})]}),I.jsxs("div",{className:"settings-actions",children:[I.jsx("button",{className:"settings-button-cancel",onClick:pe,children:"取消"}),I.jsx("button",{className:"settings-button-confirm",onClick:()=>{(e=>{b(e);try{localStorage.setItem("eve-blueprint-settings",JSON.stringify(e))}catch(t){}})(O),p(!1)},children:"确定"})]})]})}),I.jsx(ie,{isOpen:y,onClose:()=>f(!1),onAuthSuccess:ye,currentToken:g,currentRefreshToken:x,currentCharacter:j})]})}j.createRoot(document.getElementById("root")).render(I.jsx(r.StrictMode,{children:I.jsx(le,{})}));
